# 欠席処理
```bash
$(function () {
    // デザイン用JS
    var w = $(window).width();
    if (w <= 480) {
        size = 300;
    } else {
        size = 600;
    }

    $('#addtend_dialog_mail').dialog({
        autoOpen: false, // 自動でオープンしない
        width: size, // 横幅のサイズを設定
        modal: true, // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        hide: "fade", // 非表示時のエフェクト
        closeOnEscape: false,
        open: function (event, ui) {
            //$(".ui-dialog-titlebar-close", $(this).parent()).hide();
        }
    });

    $('#exit_button').dialog({
        autoOpen: false, // 自動でオープンしない
        width: 'auto', // 横幅のサイズを設定
        modal: true, // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        hide: "fade", // 非表示時のエフェクト
    });

    $('#use_plantime').dialog({
        autoOpen: false, // 自動でオープンしない
        width: 'auto', // 横幅のサイズを設定
        modal: true, // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        hide: "fade", // 非表示時のエフェクト

        open: function(event, ui) {
            // モーダルが開かれるたびに、ダイアログのボタン押下フラグをリセット
            is_button_clicked = false;
        },

        close: function(event, ui) {

            // ボタンが押されずにモーダルが閉じられた場合、延長支援加算登録処理を実行する
            if (!is_button_clicked) {

                let dialog_data = $('#use_plantime').data();
                let r_id = dialog_data.r_id;
                let c_id = dialog_data.c_id;
                let f_id = dialog_data.f_id;
                let date = dialog_data.select_date;
                let type = dialog_data.providing_type;

                // 延長支援加算の連動処理
                const enter_time_hi = dialog_data.enter_time_hi || '';
                const leave_time_hi = dialog_data.leave_time_hi || '';

                // 延長支援時間を取得して、延長支援時間情報とモーダルを出すか出さないかを返す処理
                getDetailExtensionData(c_id, f_id, r_id, date, enter_time_hi, leave_time_hi, type, 'detail', false, function (response) {
                    if (response.modal_type !== null) {
                        // モーダルを表示
                        showExtensionModal(f_id, response.data, response.form_ary, true, 'detail');
                    } else {
                        // モーダルを出さない場合はDOM要素に延長支援時間情報を挿入
                        $(`#extension_support_save_${r_id}`).attr({'data-r_id': response.form_ary[0],});

                        // 延長支援時間をセット（時間1の開始時間と終了時間、時間2の開始時間と終了時間）
                        for (let i = 1; i <= 8; i++) {
                            $(`#extension_support_save_${r_id}`).attr(`data-exTime${i}`, response.data ? response.data[i] : '');
                        }

                        let form_ary = [];
                        form_ary.push(r_id);
                        form_ary.push($(".children" + r_id).find(".realname").data("use_services"));

                        let extensionSupportElement = $(`#extension_support_save_${r_id}`).data('r_id');
                        if (extensionSupportElement) {
                            for (let i = 1; i <= 8; i++) {
                                let ex_time = $(`#extension_support_save_${r_id}`).attr(`data-extime${i}`);
                                form_ary.push(ex_time !== null && ex_time !== undefined ? ex_time : '');
                            }
                            setRelatedExtensionDetail(date, c_id, f_id, form_ary);
                        }
                    }
                });
            }
        }
    });

    //利用時間があれば
    if ($('.js_law2024').val()) {
        var colspan = 5;
    } else {
        var colspan = 4;
    }

    $('#addtend_dialog02').dialog({
        autoOpen: false, // 自動でオープンしない
        width: size, // 横幅のサイズを設定
        modal: true, // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        hide: "fade", // 非表示時のエフェクト
        buttons: [ // ボタン名 : 処理 を設定
            {
                text: '欠席時対応加算Ⅱを算定する',
                click: function () {

                    var absence_two_note = $("[name=absence_two_note]").val();
                    //欠席時対応加算の記録者を取得する
                    var absence_two_note_staff = $("[name=dialog_absence_two_note_staff]").val();
                    var all_edit_flg = $("#js_all_edit_flg").length;

                    //一括編集画面の場合
                    if (all_edit_flg === 1) {
                        $('[name="list[' + GlobalR_id + '][absence_two_note]"]').val(absence_two_note);
                        $('[name="list[' + GlobalR_id + '][absence_two_note_staff]"]').val(absence_two_note_staff);
                        $('[name="list[' + GlobalR_id + '][absence_two_flg]"]').val(1);

                        var absence_on_html = '<a href="#" class="enter red js_absence-two-on js_attend_absence_two dib mt10"><b>欠席時対応加算Ⅱ</b></a>';
                        var absence_reason_edit = '<td colspan="'+colspan+'" class="tal"><div class="js_reason_div"><b>[記録者]</b>&nbsp; <span class="dib"><select class="mr10 comboBoxStaffJquery" id="js_combo' + GlobalR_id + '"></select>&nbsp;<select class="js_reason_staff" id="js_staff' + GlobalR_id + '" data-absence="2"></select></span><textarea name="list[' + GlobalR_id + '][reason_text]" id=' + GlobalR_id + ' rows="2" class="form-control mt5 js_reason_text db js_ar_edit_two minH14em" data-absence="2" placeholder="理由記入欄"></textarea></div></td>';
                        $("#providing" + GlobalR_id).html(absence_on_html);
                        if ($('.js_children_area' + GlobalR_id).next('tr').data('rid') == GlobalR_id) {
                            $('.js_children_area' + GlobalR_id).find('.enter').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.leave').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.body_temp').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.time_division').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.providing').attr('rowspan', 1);
                            $('.js_tr_area' + GlobalR_id).prepend(absence_reason_edit)
                            $('[name="list[' + GlobalR_id + '][reason_text]"]').val(absence_two_note);
                        }

                        //スマホ表示の時にもう一つのtableの欠席時対応加算Ⅱは非表示にする
                        // if (window.innerWidth <= 768) {
                        //     $('.pinned').find('.tal').hide();
                        // }

                        //スタッフのプルダウン取得
                        let combo_copy = $('.comboBoxStaffJquery:first').clone();
                        let staff_copy = $('#js_setting_absence_note_staff').clone();
                        $(combo_copy).children('option').each(function (i, combo) {
                            $('#js_combo' + GlobalR_id).append(combo);
                        });

                        $($(staff_copy).children('option')).each(function (i, staff) {
                            $('#js_staff' + GlobalR_id).append(staff);
                        });
                        $('#js_combo' + GlobalR_id).val(0);
                        $('#js_staff' + GlobalR_id).val(absence_two_note_staff);
                        getCancelCount();

                        // 加算実績テーブルの出欠席更新
                        $(`#js_adding_atndinfo${GlobalR_id}`).html('<b class="red">欠席時対応加算Ⅱ</b>');

                        //連動分の加算を削除
                        DeleteAddingRows(GlobalR_id)

                    } else {

                        var r_id = $("#hidden_r_id").text();
                        var c_id = $("#hidden_c_id").text();
                        var f_id = $("#hidden_f_id").text();
                        var date = $("#hidden_date").text();

                        proViding(r_id, 3, c_id, f_id, date, absence_two_note, absence_two_note_staff);
                    }
                    setAttendHeight();
                    $(this).dialog("close");

                    // 加算実績テーブルの加算エラーチェック処理（欠席時対応加算Ⅱを算定した場合のみ）
                    let $attend = $(`#js_related_class${GlobalR_id}`);
                    let $target = $attend.find('tr:first');
                    // 欠席時対応加算エラーチェック
                    checkHomeAddingError(".js-selected-adding-all", $target);
                }
            },
            {
                text: '欠席時対応加算Ⅱを算定しない',
                click: function () {
                    //欠席時対応加算の備考を取得する
                    var absence_two_note = $("[name=absence_two_note]").val();
                    //欠席時対応加算の記録者を取得する
                    var absence_two_note_staff = $("[name=dialog_absence_two_note_staff]").val();
                    var all_edit_flg = $("#js_all_edit_flg").length;

                    //一括編集画面の場合
                    if (all_edit_flg === 1) {
                        $('[name="list[' + GlobalR_id + '][absence_two_note]"]').val(absence_two_note);
                        $('[name="list[' + GlobalR_id + '][absence_two_note_staff]"]').val(absence_two_note_staff);
                        $('[name="list[' + GlobalR_id + '][absence_two_flg]"]').val(2);
                        var absence_on_html = '<a href="#" class="enter red js_absence-two-off js_attend_absence_two dib mt10"><b>欠席時対応加算Ⅱを算定しない</b></a>';
                        var absence_reason_edit = '<td colspan="'+colspan+'" class="tal"><div class="js_reason_div"><b>[記録者]</b>&nbsp; <span class="dib"><select class="mr10 comboBoxStaffJquery" id="js_combo' + GlobalR_id + '"></select>&nbsp;<select class="js_reason_staff" id="js_staff' + GlobalR_id + '" data-absence="2"></select></span><textarea name="list[' + GlobalR_id + '][reason_text]" id=' + GlobalR_id + ' rows="2" class="form-control mt5 js_reason_text db js_ar_edit_two minH14em" data-absence="2" placeholder="理由記入欄"></textarea></div></td>';

                        $("#providing" + GlobalR_id).html(absence_on_html);
                        if ($('.js_children_area' + GlobalR_id).next('tr').data('rid') == GlobalR_id) {
                            $('.js_children_area' + GlobalR_id).find('.enter').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.leave').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.body_temp').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.providing').attr('rowspan', 1);
                            $('.js_children_area' + GlobalR_id).find('.time_division').attr('rowspan', 1);
                            $('.js_tr_area' + GlobalR_id).prepend(absence_reason_edit)
                            $('[name="list[' + GlobalR_id + '][reason_text]"]').val(absence_two_note);
                        }

                        //スマホ表示の時にもう一つのtableの欠席時対応加算Ⅱは非表示にする
                        // if (window.innerWidth <= 768) {
                        //     $('.pinned').find('.tal').hide();
                        // }

                        //スタッフのプルダウン取得
                        let combo_copy = $('.comboBoxStaffJquery:first').clone();
                        let staff_copy = $('#js_setting_absence_note_staff').clone();
                        $(combo_copy).children('option').each(function (i, combo) {
                            $('#js_combo' + GlobalR_id).append(combo);
                        });

                        $($(staff_copy).children('option')).each(function (i, staff) {
                            $('#js_staff' + GlobalR_id).append(staff);
                        });
                        $('#js_combo' + GlobalR_id).val(0);
                        $('#js_staff' + GlobalR_id).val(absence_two_note_staff);

                        getCancelCount();

                        // 加算実績テーブルの出欠席更新
                        $(`#js_adding_atndinfo${GlobalR_id}`).html('<b class="red">欠席時対応加算Ⅱを算定しない</b>');

                        //連動分の加算を削除
                        DeleteAddingRows(GlobalR_id)

                    } else {
                        var r_id = $("#hidden_r_id").text();
                        var c_id = $("#hidden_c_id").text();
                        var f_id = $("#hidden_f_id").text();
                        var date = $("#hidden_date").text();

                        proViding(r_id, 4, c_id, f_id, date, absence_two_note, absence_two_note_staff);
                    }
                    setAttendHeight();
                    $(this).dialog("close");
                }
            }
        ]
    });

    // ajax用PHP
    var url = "./ajax/ajax_attendance.php";
    var is_mail = 0;
    var mail_flg = 0;
    var linkage = 0;
    var idname = "";
    var atnd_data = "";
    var r_id = "";
    var c_id = "";
    var f_id = "";
    var size = "";
    var date = "";
    var strength_action = "";
    var data_list = {};
    // 画面サイズ取得
    var w = $(window).width();
    if (w <= 480) {
        size = 300;
    } else {
        size = 600;
    }

    $('#addtend_dialog').dialog({
        autoOpen: false, // 自動でオープンしない
        width: size, // 横幅のサイズを設定
        modal: true, // モーダル表示する

        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        // show: "clip",     // 表示時のエフェクト
        hide: "fade", // 非表示時のエフェクト
        buttons: [
            //　モーダル初期設定
            {
                text: '欠席時対応加算を算定する',
                click: function () {

                    //欠席時対応加算の備考を取得する
                    var absence_note = $("[name=absence_note]").val();
                    //欠席時対応加算の記録者を取得する
                    var absence_note_staff = $("[name=dialog_absence_note_staff]").val();
                    var all_edit_flg = $("#js_all_edit_flg").length;

                    //一括編集画面の場合
                    if (all_edit_flg === 1) {

                        //欠席時対応加算を選択したフラグを立てる(デフォルト文差し込み判定に使用)
                        $('[name="list[' + GlobalR_id + '][absence_click_count]"]').val(1);
                        $('[name="list[' + GlobalR_id + '][absence_note]"]').val(absence_note);
                        $('[name="list[' + GlobalR_id + '][absence_note_staff]"]').val(absence_note_staff);

                        var month = getMonth();

                        var absence_times = parseInt($(GlobalAbsence).attr("abs_times")) + 1;
                        var hidden = '<input type="hidden" value="2" name="list[' + GlobalR_id + '][attend_flg]" abs_times="' + absence_times + '">';
                        var absence_on_html = '<a href="#" class="enter red absence-on js_attend_absenceflg2 dib m5"><b>欠席（' + month + '月欠席' + absence_times + '回）</b></a>';
                        var absence_reason_edit = '<div class="js_reason_div"><b>[記録者]</b>&nbsp; <span class="dib"><select class="mr10 comboBoxStaffJquery" id="js_combo' + GlobalR_id + '"></select>&nbsp;<select class="js_reason_staff" id="js_staff' + GlobalR_id + '" data-absence="2"></select></span><textarea name="list[' + GlobalR_id + '][reason_text]" id=' + GlobalR_id + ' rows="2" class="form-control mt5 js_reason_text db minH14em" data-absence="2" placeholder="理由記入欄"></textarea></div>';

                        $(GlobalAbsence).parent().html(hidden + absence_on_html + absence_reason_edit);
                        $('[name="list[' + GlobalR_id + '][reason_text]"]').val(absence_note);

                        //スタッフのプルダウン取得
                        let combo_copy = $('.comboBoxStaffJquery:first').clone();
                        let staff_copy = $('#js_setting_absence_note_staff').clone();
                        $(combo_copy).children('option').each(function (i, combo) {
                            $('#js_combo' + GlobalR_id).append(combo);
                        });

                        $($(staff_copy).children('option')).each(function (i, staff) {
                            $('#js_staff' + GlobalR_id).append(staff);
                        });
                        $('#js_combo' + GlobalR_id).val(0);
                        $('#js_staff' + GlobalR_id).val(absence_note_staff);

                        getCancelCount();

                        // 食事提供加算用の処理
                        let meal_offer_flg = $('[name="list[' + GlobalR_id + '][meal_offer_flg]"]').val();　// 食事提供加算の対象児童なのかを取得
                        let addingMealFlg = $('[name="list[' + GlobalR_id + '][adding_meal_flg]"]').val();　// 食事提供加算の連動機能有無を取得
                        let addingMealVal = $('[name="list[' + GlobalR_id + '][adding_meal_id]"]').val();　// 食事提供加算の値を取得

                        // 食事提供加算対象児童で、連動機能ある場合は「なし」を表示
                        if ((addingMealFlg === '1') && (meal_offer_flg === '1')) {
                            if (addingMealVal === '1') {
                                $("#meal" + GlobalR_id + " .meal_btn").trigger('click');
                            }
                            $("#meal" + GlobalR_id + " .meal_btn").hide();
                            $("#meal" + GlobalR_id + " b").show();
                        }

                        // 加算実績テーブルの出欠席更新
                        $(`#js_adding_atndinfo${GlobalR_id}`).html('<b class="red">欠席</b>');

                    } else {
                        data_list["r_id"] = atnd_data[1];
                        data_list["c_id"] = atnd_data[2];
                        data_list["f_id"] = atnd_data[3];
                        data_list["mail_flg"] = mail_flg;
                        data_list["attend_flg"] = 2;
                        data_list["linkage"] = linkage;
                        data_list["date"] = atnd_data[4];
                        data_list["strength_action"] = atnd_data[5];
                        data_list["special_support"] = atnd_data[6];
                        data_list["absence_note"] = absence_note;
                        data_list["absence_note_staff"] = absence_note_staff;

                        $.ajax({
                            url: url,
                            data: {
                                "data_list": data_list,
                            },
                            timeout: 3000,
                            async: false,
                            dataType: 'json',
                            success: function (data) {
                                Success(data, data_list["r_id"], 0, data_list["c_id"], data_list["f_id"], data_list["attend_flg"], 0, data_list["date"]);
                            }
                        });


                        //連動の調整
                        //要素をloadする
                        var rid = data_list["r_id"]
                        $.ajax({
                            type: 'GET',
                            url: 'attendance.php?mode=detail&date=' + data_list["date"],
                            dataType: 'html',
                            success: function (data) {
                                $('#js_adding_list' + rid, window.parent.document).html($(data).find('#js_adding_list' + rid).html());
                            }
                        });
                    }

                    setAttendHeight();
                    $(this).dialog("close");

                    // 加算実績テーブルの加算エラーチェック処理（欠席時対応加算を算定した場合のみ）
                    let $attend = $(`#js_related_class${GlobalR_id}`);
                    let $target = $attend.find('tr:first');
                    // 欠席時対応加算エラーチェック
                    checkHomeAddingError(".js-selected-adding-all", $target);

                }
            },
            {
                text: '欠席時対応加算を算定しない',
                click: function () {

                    //2022年9月リリース分にて理由を残せるように変更
                    //欠席時対応加算の備考を取得する
                    var absence_note = $("[name=absence_note]").val();
                    //欠席時対応加算の記録者を取得する
                    var absence_note_staff = $("[name=dialog_absence_note_staff]").val();
                    var all_edit_flg = $("#js_all_edit_flg").length;

                    //一括編集画面の場合
                    if (all_edit_flg === 1) {

                        //欠席時対応加算を選択したフラグを立てる(デフォルト文差し込み判定に使用)
                        $('[name="list[' + GlobalR_id + '][absence_click_count]"]').val(1);
                        $('[name="list[' + GlobalR_id + '][absence_note]"]').val(absence_note);
                        $('[name="list[' + GlobalR_id + '][absence_note_staff]"]').val(absence_note_staff);

                        var absence_times = parseInt($(GlobalAbsence).attr("abs_times"));
                        var hidden = '<input type="hidden" value="3" name="list[' + GlobalR_id + '][attend_flg]" abs_times="' + absence_times + '">';
                        var absence_on_html = '<a href="#" class="enter red absence-off js_attend_absenceflg3"><b>欠席（欠席時対応加算を取らない）</b></a>'
                        var absence_reason_edit = '<div class="js_reason_div"><b>[記録者]</b>&nbsp; <span class="dib"><select class="mr10 comboBoxStaffJquery" id="js_combo' + GlobalR_id + '"></select>&nbsp;<select class="js_reason_staff" id="js_staff' + GlobalR_id + '"></select></span><textarea name="list[' + GlobalR_id + '][reason_text]" id=' + GlobalR_id + ' rows="2" class="form-control mt5 js_reason_text db minH14em" data-absence="1" placeholder="理由記入欄"></textarea></div>';
                        $(GlobalAbsence).parent().html(hidden + absence_on_html + absence_reason_edit);
                        $('[name="list[' + GlobalR_id + '][reason_text]"]').val(absence_note);

                        //スタッフのプルダウン取得
                        let combo_copy = $('.comboBoxStaffJquery:first').clone();
                        let staff_copy = $('#js_setting_absence_note_staff').clone();
                        $(combo_copy).children('option').each(function (i, combo) {
                            $('#js_combo' + GlobalR_id).append(combo);
                        });

                        $($(staff_copy).children('option')).each(function (i, staff) {
                            $('#js_staff' + GlobalR_id).append(staff);
                        });
                        $('#js_combo' + GlobalR_id).val(0);
                        $('#js_staff' + GlobalR_id).val(absence_note_staff);

                        getCancelCount();

                        // 食事提供加算用の処理
                        let meal_offer_flg = $('[name="list[' + GlobalR_id + '][meal_offer_flg]"]').val();　// 食事提供加算の対象児童なのかを取得
                        let addingMealFlg = $('[name="list[' + GlobalR_id + '][adding_meal_flg]"]').val();　// 食事提供加算の連動機能有無を取得
                        let addingMealVal = $('[name="list[' + GlobalR_id + '][adding_meal_id]"]').val();　// 食事提供加算の値を取得

                        // 食事提供加算対象児童で、連動機能ある場合は「なし」を表示
                        if ((addingMealFlg === '1') && (meal_offer_flg === '1')) {
                            if (addingMealVal === '1') {
                                $("#meal" + GlobalR_id + " .meal_btn").trigger('click');
                            }
                            $("#meal" + GlobalR_id + " .meal_btn").hide();
                            $("#meal" + GlobalR_id + " b").show();
                        }

                        // 加算実績テーブルの出欠席更新
                        $(`#js_adding_atndinfo${GlobalR_id}`).html('<b class="red">欠席(欠席時対応加算を取らない)</b>');

                    } else {
                        data_list["r_id"] = atnd_data[1];
                        data_list["c_id"] = atnd_data[2];
                        data_list["f_id"] = atnd_data[3];
                        data_list["mail_flg"] = mail_flg;
                        data_list["attend_flg"] = 3;
                        data_list["linkage"] = linkage;
                        data_list["date"] = atnd_data[4];
                        data_list["strength_action"] = atnd_data[5];
                        data_list["absence_note"] = absence_note;
                        data_list["absence_note_staff"] = absence_note_staff;

                        $.ajax({
                            url: url,
                            data: {
                                "data_list": data_list,
                            },
                            timeout: 3000,
                            async: false,
                            dataType: 'json',
                            success: function (data) {
                                Success(data, data_list["r_id"], 0, data_list["c_id"], data_list["f_id"], data_list["attend_flg"], 0, data_list["date"]);
                            }
                        });
                    }
                    setAttendHeight();
                    $(this).dialog("close");
                }
            }
        ]

    });

    // .jqeryui-absence クリック時にモーダル表示
    $(document).on('click', '.jqeryui-absence', function () {
        // 予約IDなど用意
        idname = $(this).attr("id");
        atnd_data = idname.split("_");

        //非表示にしてプルダウンが開かないようにする
        $('#addtend_dialog').find('.comboBoxStaffJquery').hide();
        $('#js_absence_note_staff').hide();
        $('#js_absence_note_dialog').hide();

        //再表示
        $('#addtend_dialog').find('.comboBoxStaffJquery').show();
        $('#js_absence_note_staff').show();
        $('#js_absence_note_dialog').show();

        //ダイアログ表示
        $('#addtend_dialog').dialog('open');

        //欠席回数
        c_id = atnd_data[2];
        f_id = atnd_data[3];
        setAbsenceTimes(c_id, f_id);
        return false;
    });

    // モーダル画面以外のブラウザ領域をクリックで、モーダル非表示
    $(document).on('click', '.ui-widget-overlay', function () {
        //非表示にしてプルダウンが開かないようにする
        $('#addtend_dialog').find('.comboBoxStaffJquery').hide();
        $('#js_absence_note_staff').hide();
        $('#js_absence_note_dialog').hide();

        $('#addtend_dialog02').find('.comboBoxStaffJquery').hide();
        $('#js_absence_two_note_staff').hide();
        $('#js_absence_two_note_dialog').hide();

        $('.js_dialog_time').hide();

        //ダイアログを閉じる
        $('.ui-dialog-content').dialog('close');

    });
});
```