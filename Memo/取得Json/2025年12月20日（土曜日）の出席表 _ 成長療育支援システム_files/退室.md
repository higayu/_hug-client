# 退室
```bash
/**
 * 退室時間保存準備(別環境で入室時間・提供形態登録後、画面更新していない環境での退室実績登録に対応するための処理)
 *
 * @param {number} r_id - 予約ID
 * @param {number} is_mail - メール通知設定フラグ
 * @param {number} c_id - 児童ID
 * @param {number} f_id - 施設ID
 * @param {number} attend_flg - 出席フラグ
 * @param {number} linkage - 連動フラグ
 */
function sendLeaveMail(r_id, is_mail, c_id, f_id, attend_flg, linkage) {

    // 入室時間を取得
    let enter_time = $.trim($('#enter' + r_id).find('span').text()).split(':').map(Number);

    // 提供形態を取得
    let providing_type = null;
    if ($('.children' + r_id).data('providing_type')) {
        providing_type = parseInt($(`.children${r_id}`).data('providing_type'));
    }

    // 最新の入室時間、提供形態を取得
    $.ajax({
        url: 'ajax/ajax_attendance.php',
        type: 'GET',
        data: {
            action: 'getEnterTimeAndProvidingType',
            r_id: r_id
        },
        dataType: 'json',
        success: function(response) {

            // DOM要素から取得した入室時間・提供形態がDBの入室時間・提供形態と異なる場合、DBの値で更新
            // 入室時間
            if (response.entering_room_time) {
                let entering_room_time = response.entering_room_time;

                // 0000-00-00 00:00:00 の形式から時間部分（00:00）を抽出
                let time_part = entering_room_time.split(' ')[1].split(':');

                // 入室時間を更新
                enter_time = time_part.slice(0, 2).map(Number);

                // 入室時間が更新された場合、画面表示を更新
                $(`#enter${r_id}`).html(`<b><span class='green'>${time_part[0]}:${time_part[1]}</span></b>`);
            }

            // 提供形態
            let current_providing_type = null;
            if (response.providing_type) {
                current_providing_type = parseInt(response.providing_type);
                if ((current_providing_type !== providing_type)) {

                    // 提供形態を更新
                    providing_type = current_providing_type;

                    // 提供形態が更新された場合、画面表示を更新
                    $(`#providing${r_id}`).html(`<b><span class='green'>${response.type_name}</span></b>`);
                }
            }

            // 続きの退室時間保存準備
            continueSendLeaveMail(r_id, is_mail, c_id, f_id, attend_flg, linkage, enter_time, providing_type);
        }
    });
}
```