# カスタムボタン設定ファイルの役割

## 概要

カスタムボタン機能では、2つのJSONファイルを使用してカスタムボタンの管理を行います。

1. **`customButtons.json`** - ユーザーが作成したカスタムボタンの設定を保存
2. **`availableActions.json`** - カスタムボタンで使用できるアクション（機能）の一覧を定義

---

## 1. customButtons.json

### 役割
ユーザーが設定画面で作成・編集したカスタムボタンの設定を永続化するファイルです。  
ユーザーのカスタマイズ内容が保存され、アプリケーション再起動後も保持されます。

### ファイルパス
- **開発時**: `data/customButtons.json` (プロジェクトルート直下)
- **ビルド後**: `{ユーザーディレクトリ}/data/customButtons.json`

### データ構造

```json
{
  "version": "1.0.0",
  "customButtons": [
    {
      "id": "addition-compare-btn",      // ボタンの一意ID
      "enabled": true,                   // 有効/無効フラグ
      "text": "加算の比較",               // ボタンに表示するテキスト
      "color": "#f9d4fc",                // ボタンの背景色（HEX形式）
      "action": "additionCompare",        // 実行するアクションID（availableActions.jsonのidと対応）
      "order": 1                         // 表示順序（小さい順）
    }
  ]
}
```

### 各プロパティの説明

| プロパティ | 型 | 説明 | 必須 |
|-----------|-----|------|------|
| `version` | string | ファイル形式のバージョン | ✅ |
| `customButtons` | array | カスタムボタンの配列 | ✅ |
| `id` | string | ボタンの一意識別子（自動生成または手動指定） | ✅ |
| `enabled` | boolean | ボタンを有効にするか（true: 表示、false: 非表示） | ✅ |
| `text` | string | ボタンに表示するテキスト | ✅ |
| `color` | string | ボタンの背景色（HEX形式: `#RRGGBB`） | ✅ |
| `action` | string | 実行するアクションID（`availableActions.json`の`id`と対応） | ✅ |
| `order` | number | ボタンの表示順序（数値が小さい順に表示） | ✅ |

### 使用タイミング

- **読み込み**: アプリケーション起動時、設定モーダル表示時、設定再読み込み時
- **保存**: 設定モーダルで「保存」ボタンをクリックした時

### 関連コード

- **読み込み処理**: `main/parts/handlers/customButtonsHandler.js` → `read-custom-buttons`
- **保存処理**: `main/parts/handlers/customButtonsHandler.js` → `save-custom-buttons`
- **レンダラー側**: `renderer/modules/config/customButtons.js`
  - `loadCustomButtons()` - ファイルから読み込み
  - `saveCustomButtons()` - ファイルに保存
  - `CustomButtonsState.customButtons` - メモリ上での状態管理

---

## 2. availableActions.json

### 役割
カスタムボタンで使用できるアクション（機能）のマスター定義です。  
ユーザーがカスタムボタンを作成する際に、このファイルに定義されたアクションから選択できます。

**注意**: このファイルは開発者が管理し、ユーザーが直接編集することは想定されていません。

### ファイルパス
- **開発時**: `data/availableActions.json` (プロジェクトルート直下)
- **ビルド後**: `{ユーザーディレクトリ}/data/availableActions.json`

### データ構造

```json
{
  "version": "1.0.0",
  "availableActions": [
    {
      "id": "additionCompare",                    // アクションの一意ID（customButtons.jsonのactionと対応）
      "name": "加算比較",                          // アクションの表示名
      "description": "加算登録の比較機能を実行します", // アクションの説明
      "category": "比較機能",                      // カテゴリ（UIでグループ化に使用）
      "icon": "📊"                                // アクションのアイコン（絵文字など）
    }
  ]
}
```

### 各プロパティの説明

| プロパティ | 型 | 説明 | 必須 |
|-----------|-----|------|------|
| `version` | string | ファイル形式のバージョン | ✅ |
| `availableActions` | array | 利用可能なアクションの配列 | ✅ |
| `id` | string | アクションの一意識別子（customButtons.jsonの`action`と対応） | ✅ |
| `name` | string | アクションの表示名 | ✅ |
| `description` | string | アクションの説明文 | ✅ |
| `category` | string | アクションのカテゴリ（UIでグループ化に使用） | ✅ |
| `icon` | string | アクションのアイコン（絵文字など） | ⚠️ 推奨 |

### 使用タイミング

- **読み込み**: アプリケーション起動時、設定モーダル表示時
- **表示**: 設定モーダルの「カスタムボタン」タブで、新しいボタン作成時のアクション選択肢として表示

### カテゴリ例

現在定義されているカテゴリ：
- **比較機能** - 比較系のアクション
- **カスタム** - カスタムアクション
- **認証** - ログイン関連
- **データ管理** - データのインポート/エクスポート
- **設定** - アプリケーション設定

### 関連コード

- **読み込み処理**: `main/parts/handlers/customButtonsHandler.js` → `read-available-actions`
- **レンダラー側**: `renderer/modules/config/customButtons.js`
  - `loadAvailableActions()` - ファイルから読み込み
  - `getAvailableActions()` - アクション一覧を取得
  - `getActionsByCategory()` - カテゴリ別にグループ化
  - `CustomButtonsState.availableActions` - メモリ上での状態管理

---

## 3. ファイル間の関係

### データフロー

```
availableActions.json (マスター定義)
         ↓
    [ユーザーがカスタムボタンを作成]
         ↓
    action: "additionCompare" ← availableActions.jsonのidを参照
         ↓
customButtons.json (ユーザー設定)
         ↓
    [アプリケーション実行]
         ↓
    [ボタンクリック]
         ↓
    handleCustomButtonClick() で action に基づいて処理実行
```

### 関連付け

`customButtons.json`の`action`プロパティは、`availableActions.json`の`id`プロパティと対応しています。

**例**:
```json
// availableActions.json
{
  "id": "additionCompare",
  "name": "加算比較"
}

// customButtons.json
{
  "action": "additionCompare",  // ← availableActions.jsonのidと対応
  "text": "加算の比較"
}
```

---

## 4. 実行処理の流れ

カスタムボタンがクリックされた時の処理フロー：

1. `customButtons.json`からボタン設定を読み込み
2. ボタンの`action`プロパティを確認
3. `CustomButtonManager.handleCustomButtonClick()`が呼ばれる
4. `action`の値に基づいてswitch文で処理を分岐
5. 対応するハンドラー関数（例: `handleAdditionCompare()`）が実行される

### 実行ハンドラーの場所

`renderer/modules/actions/customButtons.js`の`CustomButtonManager`クラス内で定義：

```javascript
handleCustomButtonClick(buttonConfig) {
  switch (buttonConfig.action) {
    case 'additionCompare':
      this.handleAdditionCompare(buttonConfig);
      break;
    case 'customAction1':
      this.handleCustomAction1(buttonConfig);
      break;
    // ... その他のアクション
  }
}
```

---

## 5. ファイル管理の注意点

### customButtons.json

- ✅ ユーザーが設定画面から編集可能
- ✅ アプリケーションが自動保存
- ✅ 削除や並び替えも可能
- ⚠️ 手動編集は非推奨（UIから編集を推奨）

### availableActions.json

- ✅ 開発者が定義・管理
- ✅ 新しいアクションを追加する場合は、対応する実行ハンドラーも実装が必要
- ⚠️ ユーザーが直接編集する想定はなし
- ⚠️ `id`を変更すると、既存のカスタムボタンとの関連が切れる可能性あり

---

## 6. 新規アクションの追加方法

新しいアクションを追加する場合の手順：

1. **`availableActions.json`にアクションを追加**
   ```json
   {
     "id": "newAction",
     "name": "新しいアクション",
     "description": "新しいアクションの説明",
     "category": "カスタム",
     "icon": "🔧"
   }
   ```

2. **`renderer/modules/actions/customButtons.js`に実行ハンドラーを追加**
   ```javascript
   handleCustomButtonClick(buttonConfig) {
     switch (buttonConfig.action) {
       // ... 既存のケース
       case 'newAction':
         this.handleNewAction(buttonConfig);
         break;
     }
   }
   
   handleNewAction(buttonConfig) {
     // 実際の処理を実装
   }
   ```

3. **アプリケーションを再起動して反映**

---

## 7. トラブルシューティング

### カスタムボタンが表示されない

- `customButtons.json`の`enabled`が`true`になっているか確認
- ファイルが正しく読み込まれているかコンソールログで確認

### アクションが実行されない

- `customButtons.json`の`action`と`availableActions.json`の`id`が一致しているか確認
- 実行ハンドラーが正しく実装されているか確認

### ファイルが見つからない

- 初回起動時に自動生成される（デフォルト設定が作成される）
- ファイルパスが正しいか確認（開発時とビルド後でパスが異なる）

---

## まとめ

- **`customButtons.json`**: ユーザーのカスタマイズ設定（編集可）
- **`availableActions.json`**: アクションのマスター定義（開発者管理）
- 2つのファイルは`action`と`id`で関連付けられる
- UIから編集することで整合性が保たれる

