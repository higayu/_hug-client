# 処理

# バックエンドのAPI
http://192.168.1.229:3001/api/
router.js
```js
const express = require("express");
const router = express.Router();
const { getPool } = require("./db"); // ✅ 修正：getConnection → getPool に変更
const crypto = require("crypto");

// =====================================================
// 認証API
// =====================================================
router.post("/:dbname/:table/login", async (req, res) => {
  const { dbname, table } = req.params;
  const { email, password } = req.body;

  try {
    // SHA256ハッシュ化（email + password）
    const hash = crypto.createHash("sha256").update(email + password).digest("hex");

    const pool = getPool(dbname); // ✅ ここでプールを取得
    const [rows] = await pool.query(
      `SELECT * FROM \`${table}\` WHERE email = ? AND password = ?`,
      [email, hash]
    );

    if (rows.length === 0) {
      return res.status(401).json({
        error: "メールアドレスまたはパスワードが間違っています",
        hash: hash
      });
    }

    res.json(rows[0]);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// 指定DBの全テーブルからデータ全件取得（安全版）
// =====================================================
router.get("/:dbname/__all", async (req, res) => {
  const { dbname } = req.params;
  try {
    const pool = getPool(dbname);
    const [tables] = await pool.query("SHOW TABLES");

    const results = {};
    for (const row of tables) {
      const tableName = Object.values(row)[0];
      const [rows] = await pool.query(`SELECT * FROM \`${tableName}\``);
      results[tableName] = rows;
    }

    res.json(results);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});



// =====================================================
// 全件取得 (Read)
// =====================================================
router.get("/:dbname/:table", async (req, res) => {
  const { dbname, table } = req.params;
  try {
    const pool = getPool(dbname);
    const [rows] = await pool.query(`SELECT * FROM \`${table}\``);
    res.json(rows);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// 条件付き取得 (Search)
// =====================================================
router.get("/:dbname/:table/search", async (req, res) => {
  const { dbname, table } = req.params;
  const { pk, values } = req.query;

  try {
    if (!pk || !values) {
      return res.status(400).json({ error: "pk と values を指定してください" });
    }

    const pkCols = pk.split(",");
    const pkVals = values.split(",");

    if (pkCols.length !== pkVals.length) {
      return res.status(400).json({ error: "pk と values の数が一致していません" });
    }

    const whereClause = pkCols.map(col => `\`${col}\` = ?`).join(" AND ");

    const pool = getPool(dbname);
    const [rows] = await pool.query(
      `SELECT * FROM \`${table}\` WHERE ${whereClause}`,
      pkVals
    );

    res.json(rows);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// データ追加 (Create)
// =====================================================
router.post("/:dbname/:table", async (req, res) => {
  const { dbname, table } = req.params;
  const data = req.body;

  try {
    const pool = getPool(dbname);
    const [result] = await pool.query(`INSERT INTO \`${table}\` SET ?`, data);
    res.json({ insertedId: result.insertId });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// データ更新 (Update)
// =====================================================
router.put("/:dbname/:table", async (req, res) => {
  const { dbname, table } = req.params;
  const { pk, values } = req.query;
  const data = req.body;

  try {
    if (!pk || !values) {
      return res.status(400).json({ error: "pk と values を指定してください" });
    }

    const pkCols = pk.split(",");
    const pkVals = values.split(",");

    if (pkCols.length !== pkVals.length) {
      return res.status(400).json({ error: "pk と values の数が一致していません" });
    }

    const whereClause = pkCols.map(col => `\`${col}\` = ?`).join(" AND ");

    const pool = getPool(dbname);
    const [result] = await pool.query(
      `UPDATE \`${table}\` SET ? WHERE ${whereClause}`,
      [data, ...pkVals]
    );

    res.json({ affectedRows: result.affectedRows });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// データ削除 (Delete)
// =====================================================
router.delete("/:dbname/:table", async (req, res) => {
  const { dbname, table } = req.params;
  const { pk, values } = req.query;

  try {
    if (!pk || !values) {
      return res.status(400).json({ error: "pk と values を指定してください" });
    }

    const pkCols = pk.split(",");
    const pkVals = values.split(",");

    if (pkCols.length !== pkVals.length) {
      return res.status(400).json({ error: "pk と values の数が一致していません" });
    }

    const whereClause = pkCols.map(col => `\`${col}\` = ?`).join(" AND ");

    const pool = getPool(dbname);
    const [result] = await pool.query(
      `DELETE FROM \`${table}\` WHERE ${whereClause}`,
      pkVals
    );

    res.json({ affectedRows: result.affectedRows });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// ストアドプロシージャ呼び出し
// =====================================================
router.post("/:dbname/procedure/:procname", async (req, res) => {
  const { dbname, procname } = req.params;
  const { params } = req.body;

  try {
    const pool = getPool(dbname);
    const placeholders = params && params.length > 0 ? params.map(() => "?").join(",") : "";
    const sql = `CALL \`${procname}\`(${placeholders})`;

    const [rows] = await pool.query(sql, params);
    res.json(rows[0] ?? rows);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


// =====================================================
// 外部サイト取得API
// =====================================================
const hugHandler = require("./hug");
router.get("/hug", hugHandler);

router.get("/hug-proxy", async (req, res) => {
  try {
    const response = await fetch("https://www.hug-ayumu.link/hug/wm/");
    const html = await response.text();
    res.send(html);
  } catch (err) {
    res.status(500).send("Error fetching Hug page");
  }
});

module.exports = router;
```

# sqlのプロシージャの定義
```sql
CREATE DEFINER=`test`@`192.168.1.%` PROCEDURE `insert_manager_p`(
	IN `p_child_id` INT,
	IN `p_child_name` VARCHAR(255),
	IN `p_notes` TEXT,
	IN `p_pronunciation_id` INT,
	IN `p_children_type_id` INT,
	IN `p_staff_id` INT,
	IN `p_facility_id` INT,
	IN `p_day_of_week_json` VARCHAR(50)
)
LANGUAGE SQL
NOT DETERMINISTIC
CONTAINS SQL
SQL SECURITY DEFINER
COMMENT ''
BEGIN
    DECLARE v_exists_child INT;
    DECLARE v_exists_manager INT;

    -- ① children 存在チェック
    SELECT COUNT(*) INTO v_exists_child
    FROM children
    WHERE id = p_child_id;

    IF v_exists_child = 0 THEN
        INSERT INTO children (
            id, name, notes, pronunciation_id, children_type_id
        ) VALUES (
            p_child_id, p_child_name, p_notes, p_pronunciation_id, p_children_type_id
        );
    END IF;


    -- ② facility_children 存在チェック
    IF NOT EXISTS (
        SELECT 1 FROM facility_children
        WHERE children_id = p_child_id
          AND facility_id = p_facility_id
    ) THEN
        INSERT INTO facility_children (children_id, facility_id)
        VALUES (p_child_id, p_facility_id);
    END IF;


    -- ③ managers 存在チェック
    SELECT COUNT(*) INTO v_exists_manager
    FROM managers
    WHERE children_id = p_child_id
      AND staff_id = p_staff_id;

    -- ④ レコードが存在しない → INSERT
    IF v_exists_manager = 0 THEN
        INSERT INTO managers (children_id, staff_id, day_of_week)
        VALUES (p_child_id, p_staff_id, p_day_of_week_json);

    -- ⑤ レコードが存在する → 強制 UPDATE
    ELSE
        UPDATE managers
        SET day_of_week = p_day_of_week_json
        WHERE children_id = p_child_id
          AND staff_id = p_staff_id;
    END IF;

END
```