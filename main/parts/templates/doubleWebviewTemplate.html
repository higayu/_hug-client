<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; display:flex; flex-direction:column; font-family:sans-serif; }
    #tabs { display:flex; background:#eee; border-bottom:2px solid #ccc; }
    .tab { flex:1; text-align:center; padding:10px; cursor:pointer; }
    .tab.active { background:#fff; border-top:2px solid #555; border-left:1px solid #ccc; border-right:1px solid #ccc; }
    #content { flex:1; position:relative; }
    #webviews { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; }
    webview { flex:1; height:100%; border:none; }
    #left { border-right:2px solid #ccc; }
    #resultView { position:absolute; top:0; left:0; width:100%; height:100%; background:#fafafa; overflow:auto;
      white-space:pre; font-family:monospace; padding:20px; display:none; }

    #resultView h2 {
      background:#f3f3f3; padding:6px 10px; border-left:5px solid #888;
    }
    .table-wrapper {
      overflow-x:auto; margin-bottom:40px;
    }
    table.table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    table.table th, table.table td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      font-size: 13px;
    }
    table.table th { background: #e0e0e0; }
    tr:nth-child(even) { background: #fafafa; }
    #resultContainer {
       display: flex;
       flex-direction: row;
       gap: 20px;
    }
    
    .result-half {
       flex: 1;
       min-width: 0;
       display: flex;
       flex-direction: column;
    }
    
    .result-half h2 {
       background:#f3f3f3;
       padding:6px 10px;
       border-left:5px solid #888;
       margin-top:0;
    }
    
    .table-wrapper {
       flex: 1;
       overflow-x: auto;
       overflow-y: auto;
       background: white;
       border: 1px solid #ccc;
       border-radius: 6px;
       padding: 6px;
    }
    
    button {
      padding: 8px 12px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #005a9e;
    }

  </style>
</head>
<body>
  <div id="tabs">
    <div id="tabView" class="tab active">ğŸ“„ ãƒšãƒ¼ã‚¸è¡¨ç¤º</div>
    <div id="tabResult" class="tab">ğŸ“Š å–å¾—çµæœ</div>
  </div>
  <div id="content">
    <div style="position:absolute; top:10px; right:20px; z-index:5; display:flex; gap:10px;">
      <button id="clickAdditionBtn">â• åŠ ç®—ç™»éŒ²ã‚¯ãƒªãƒƒã‚¯</button>
      <button id="getDataBtn">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
    </div>
    <div id="webviews">
      <webview id="left"
        src="{{URL1}}"
        preload="file://{{PRELOAD_PATH}}"
        allowpopups
        disablewebsecurity></webview>
      <webview id="right"
        src="{{URL2}}"
        preload="file://{{PRELOAD_PATH}}"
        allowpopups
        disablewebsecurity></webview>
    </div>
    <div id="resultView"></div>
  </div>

  <script>
    const tabView = document.getElementById("tabView");
    const tabResult = document.getElementById("tabResult");
    const webviews = document.getElementById("webviews");
    const resultView = document.getElementById("resultView");
    const left = document.getElementById("left");
    const right = document.getElementById("right");

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    tabView.addEventListener("click", () => {
      tabView.classList.add("active");
      tabResult.classList.remove("active");
      webviews.style.display = "flex";
      resultView.style.display = "none";
    });
    tabResult.addEventListener("click", () => {
      tabResult.classList.add("active");
      tabView.classList.remove("active");
      webviews.style.display = "none";
      resultView.style.display = "block";
    });

    // åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    async function clickAdditionRadio() {
      try {
        console.log("ğŸŸ¢ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸­...");
        
        const success = await left.executeJavaScript(`
          const radio = document.querySelector('input[type="radio"][name="tableChange"][value="2"]');
          if (radio) {
            radio.click();
            console.log("âœ… åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸ");
            true;
          } else {
            console.log("âŒ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            false;
          }
        `);
        
        if (success) {
          console.log("âœ… åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ");
        } else {
          console.log("âš ï¸ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      } catch (error) {
        console.error("âŒ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
      }
    }

    // åŠ ç®—ç™»éŒ²ã‚¯ãƒªãƒƒã‚¯ãƒœã‚¿ãƒ³
    document.getElementById("clickAdditionBtn").addEventListener("click", async () => {
      await clickAdditionRadio();
    });

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    document.getElementById("getDataBtn").addEventListener("click", async () => {
      try {
        console.log("ğŸŸ¢ ãƒšãƒ¼ã‚¸å…¨ä½“ã®æ§‹é€ ã‚’å–å¾—é–‹å§‹...");

        async function waitForPageReady(view) {
          for (let i = 0; i < 30; i++) {
            const state = await view.executeJavaScript('document.readyState');
            if (state === "complete") return true;
            await new Promise(r => setTimeout(r, 500));
          }
          throw new Error("ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ");
        }

        await waitForPageReady(left);
        await waitForPageReady(right);
        
        // åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
        await clickAdditionRadio();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿ
        await new Promise(r => setTimeout(r, 1000));

        const htmlLeft = await left.executeJavaScript(`
          console.log("ğŸ” å·¦ãƒšãƒ¼ã‚¸:", document.title);
          let el = document.querySelector("table.js_adding_table");
          if (!el) {
            console.log("âš ï¸ js_adding_tableã‚¯ãƒ©ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸ã®tableã‚’æ¢ã—ã¾ã™...");
            el = document.querySelector("table");
            if (!el) throw new Error("å·¦ãƒšãƒ¼ã‚¸ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
          console.log("âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸ:", el.className);
          el.outerHTML;
        `);

        const htmlRight = await right.executeJavaScript(`
          console.log("ğŸ” å³ãƒšãƒ¼ã‚¸:", document.title);
          const el = document.querySelector("table");
          if (!el) throw new Error("å³ãƒšãƒ¼ã‚¸ã«<table>ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          el.outerHTML;
        `);

        resultView.innerHTML =
          '<div id="resultContainer">' +
            '<div class="result-half">' +
              '<h2>ğŸ“˜ å·¦ãƒšãƒ¼ã‚¸ï¼ˆè¨˜éŒ²ä¸€è¦§ï¼‰</h2>' +
              '<div class="table-wrapper">' + htmlLeft + '</div>' +
            '</div>' +
            '<div class="result-half">' +
              '<h2>ğŸ“™ å³ãƒšãƒ¼ã‚¸ï¼ˆè¨ˆç”»çŠ¶æ³ï¼‰</h2>' +
              '<div class="table-wrapper">' + htmlRight + '</div>' +
            '</div>' +
          '</div>';

        tabResult.click();

      } catch (err) {
        console.error("ğŸ’¥ æ§‹é€ å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
        alert("æ§‹é€ å–å¾—ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });
  </script>
</body>
</html>
