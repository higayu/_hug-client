<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; display:flex; flex-direction:column; font-family:sans-serif; }
    #tabs { display:flex; background:#eee; border-bottom:2px solid #ccc; }
    .tab { flex:1; text-align:center; padding:10px; cursor:pointer; }
    .tab.active { background:#fff; border-top:2px solid #555; border-left:1px solid #ccc; border-right:1px solid #ccc; }
    #content { flex:1; position:relative; }
    #webviews { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; }
    webview { flex:1; height:100%; border:none; }
    #left { border-right:2px solid #ccc; }
    #resultView { position:absolute; top:0; left:0; width:100%; height:100%; background:#fafafa; overflow:auto;
      white-space:pre; font-family:monospace; padding:20px; display:none; }

    #resultView h2 {
      background:#f3f3f3; padding:6px 10px; border-left:5px solid #888;
    }
    .table-wrapper {
      overflow-x:auto; margin-bottom:40px;
    }
    table.table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    table.table th, table.table td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      font-size: 13px;
    }
    table.table th { background: #e0e0e0; }
    tr:nth-child(even) { background: #fafafa; }
    #resultContainer {
       display: flex;
       flex-direction: row;
       gap: 20px;
    }
    
    .result-half {
       flex: 1;
       min-width: 0;
       display: flex;
       flex-direction: column;
    }
    
    .result-half h2 {
       background:#f3f3f3;
       padding:6px 10px;
       border-left:5px solid #888;
       margin-top:0;
    }
    
    .table-wrapper {
       flex: 1;
       overflow-x: auto;
       overflow-y: auto;
       background: white;
       border: 1px solid #ccc;
       border-radius: 6px;
       padding: 6px;
    }
    
    button {
      padding: 8px 12px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #005a9e;
    }

  </style>
</head>
<body>
  <!-- ======== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ ======== -->
  <div id="toolbar" style="background: #f5f5f5; padding: 10px; border-bottom: 1px solid #ddd; display: flex; gap: 20px; align-items: center;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <label style="font-weight: bold;">æ–½è¨­ID:</label>
      <input type="text" id="facilityIdInput" readonly style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; background: #fff;" />
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <label style="font-weight: bold;">æ—¥ä»˜:</label>
      <input type="date" id="dateStrInput" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; background: #fff;" />
    </div>
    <button id="getDataBtn">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
  </div>
  <div id="tabs">
    <div id="tabView" class="tab active">ğŸ“„ ãƒšãƒ¼ã‚¸è¡¨ç¤º</div>
    <div id="tabResult" class="tab">ğŸ“Š å–å¾—çµæœ</div>
  </div>
  <div id="content">
    <div id="webviews">
      <webview id="left"
        src="{{URL1}}"
        preload="file://{{PRELOAD_PATH}}"
        allowpopups
        disablewebsecurity></webview>
      <webview id="right"
        src="{{URL2}}"
        preload="file://{{PRELOAD_PATH}}"
        allowpopups
        disablewebsecurity></webview>
    </div>
    <div id="resultView"></div>
  </div>

  <script>
    const tabView = document.getElementById("tabView");
    const tabResult = document.getElementById("tabResult");
    const webviews = document.getElementById("webviews");
    const resultView = document.getElementById("resultView");
    const left = document.getElementById("left");
    const right = document.getElementById("right");

    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å€¤ã‚’è¨­å®š
    document.addEventListener("DOMContentLoaded", () => {
      const facilityIdInput = document.getElementById("facilityIdInput");
      const dateStrInput = document.getElementById("dateStrInput");
      
      if (facilityIdInput) {
        facilityIdInput.value = "{{FACILITY_ID}}";
      }
      if (dateStrInput) {
        dateStrInput.value = "{{DATE_STR}}";
      }
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    tabView.addEventListener("click", () => {
      tabView.classList.add("active");
      tabResult.classList.remove("active");
      webviews.style.display = "flex";
      resultView.style.display = "none";
    });
    tabResult.addEventListener("click", () => {
      tabResult.classList.add("active");
      tabView.classList.remove("active");
      webviews.style.display = "none";
      resultView.style.display = "block";
    });

    // åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    async function clickAdditionRadio() {
      try {
        //console.log("ğŸŸ¢ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸­...");
        
        const success = await left.executeJavaScript(`
          const radio = document.querySelector('input[type="radio"][name="tableChange"][value="2"]');
          if (radio) {
            radio.click();
            console.log("âœ… åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸ");
            true;
          } else {
            console.log("âŒ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            false;
          }
        `);
        
        if (success) {
          console.log("âœ… åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ");
        } else {
          console.log("âš ï¸ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      } catch (error) {
        console.error("âŒ åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
      }
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    document.getElementById("getDataBtn").addEventListener("click", async () => {
      try {
        //console.log("ğŸŸ¢ ãƒšãƒ¼ã‚¸å…¨ä½“ã®æ§‹é€ ã‚’å–å¾—é–‹å§‹...");

        async function waitForPageReady(view) {
          for (let i = 0; i < 30; i++) {
            const state = await view.executeJavaScript('document.readyState');
            if (state === "complete") return true;
            await new Promise(r => setTimeout(r, 500));
          }
          throw new Error("ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ");
        }

        await waitForPageReady(left);
        await waitForPageReady(right);
        
        // å·¦å´webviewã®URLã‚’å‹•çš„ã«å¤‰æ›´
        const facilityId = document.getElementById("facilityIdInput").value;
        const dateValue = document.getElementById("dateStrInput").value;
        const newUrl = `https://www.hug-ayumu.link/hug/wm/attendance.php?mode=detail&f_id=${facilityId}&date=${dateValue}`;
        
        console.log("ğŸ” å·¦å´webviewã®URLã‚’å¤‰æ›´ä¸­...", newUrl);
        left.src = newUrl;
        
        // URLå¤‰æ›´å¾Œã®ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
        console.log("ğŸ” å·¦å´webviewã®ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚’å¾…æ©Ÿä¸­...");
        await waitForPageReady(left);
        console.log("âœ… å·¦å´webviewã®ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");

        // åŠ ç®—ç™»éŒ²ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
        await clickAdditionRadio();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿ
        await new Promise(r => setTimeout(r, 2000));
        
        // å·¦ãƒšãƒ¼ã‚¸ã®webviewãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        console.log("ğŸ” å·¦ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç¢ºèªä¸­...");
        const leftReady = await left.executeJavaScript('document.readyState');
        console.log("ğŸ” å·¦ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿çŠ¶æ…‹:", leftReady);
        
        // å·¦ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¢ºèª
        const leftTitle = await left.executeJavaScript('document.title');
        console.log("ğŸ” å·¦ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«:", leftTitle);

        // 1. webviewå†…ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
        let htmlLeft;
        try {
          htmlLeft = await left.executeJavaScript(`
            console.log("ğŸ” å·¦ãƒšãƒ¼ã‚¸:", document.title);
            console.log("ğŸ” ãƒšãƒ¼ã‚¸URL:", window.location.href);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¢ã™
            let el = document.querySelector("table.js_adding_table");
            if (!el) {
              console.log("âš ï¸ js_adding_tableã‚¯ãƒ©ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸ã®tableã‚’æ¢ã—ã¾ã™...");
              el = document.querySelector("table");
              if (!el) {
                console.log("âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                throw new Error("å·¦ãƒšãƒ¼ã‚¸ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
              }
            }
            console.log("âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸ:", el.className);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’è¿”ã™
            el.outerHTML;
          `);
        } catch (error) {
          console.error("âŒ å·¦ãƒšãƒ¼ã‚¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã§ã‚¨ãƒ©ãƒ¼:", error);
          htmlLeft = '<table><tr><td>å·¦ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr></table>';
        }

        // 2. å–å¾—ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€Œå°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã€ã®è¡Œã‚’æŠ½å‡º
       // console.log("ğŸ” å–å¾—ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æŠ½å‡ºå‡¦ç†ã‚’é–‹å§‹...");
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’DOMè¦ç´ ã¨ã—ã¦è§£æ
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlLeft;
        const table = tempDiv.querySelector('table');
        
        if (!table) {
         // console.error("âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          htmlLeft = '<table><tr><td>ãƒ†ãƒ¼ãƒ–ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr></table>';
        } else {
          const rows = table.querySelectorAll('tr');
         // console.log("ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œæ•°:", rows.length);
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®åˆ—æ•°ã‚’ç¢ºèª
          if (rows.length > 0) {
            const headerCells = rows[0].querySelectorAll("th, td");
           // console.log("ğŸ“‹ ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—æ•°:", headerCells.length);
            for (let i = 0; i < headerCells.length; i++) {
             // console.log("åˆ—" + i + ":", headerCells[i].textContent.trim());
            }
          }
          
            // ã€Œå°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã€ã‚’å«ã‚€è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã¨5ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
           const extractedData = [];
           
           // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æƒ…å ±ã‚’è¿½åŠ 
           if (rows.length > 0) {
             const headerCells = rows[0].querySelectorAll("th, td");
             if (headerCells.length > 5) {
               let headerText1 = "";
               let headerText5 = "";
               
               // ãƒ˜ãƒƒãƒ€ãƒ¼0ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«æŠ½å‡º
               if (headerCells[0]) {
                 const nameElement = headerCells[0].querySelector('p');
                 if (nameElement) {
                   headerText1 = nameElement.textContent.trim().replace(/\s+/g, ' ');
                 } else {
                   headerText1 = headerCells[0].textContent.trim().replace(/\s+/g, ' ');
                 }
               }
               
               // ãƒ˜ãƒƒãƒ€ãƒ¼5ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç©ºç™½ã‚’æ•´ç†ï¼‰
               if (headerCells[5]) {
                 headerText5 = headerCells[5].textContent.trim().replace(/\s+/g, ' ');
               }
               
               extractedData.push({
                 type: "header",
                 text1: headerText1,
                 text5: headerText5
               });
              // console.log("ğŸ“‹ ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:", headerText1, "|", headerText5);
             }
           }
           
           // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
           let foundCount = 0;
           for (let i = 1; i < rows.length; i++) {
             const row = rows[i];
             const cells = row.querySelectorAll("td");
             
            // console.log("è¡Œ" + i + "ã®åˆ—æ•°:", cells.length);
             
             // å„åˆ—ã®å†…å®¹ã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
             for (let j = 0; j < Math.min(cells.length, 10); j++) {
               const cellText = cells[j].textContent.trim();
               if (cellText.includes("å°‚é–€çš„æ”¯æ´") || cellText.includes("åŠ ç®—")) {
                // console.log("åˆ—" + j + "ã«å°‚é–€çš„æ”¯æ´é–¢é€£ã®æ–‡å­—ã‚’ç™ºè¦‹:", cellText);
               }
             }
             
             // 6ç•ªç›®ã®åˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5ï¼‰ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
             if (cells.length > 5) {
               const cell = cells[5];
               const cellText = cell.textContent.trim();
              // console.log("åˆ—5ã®å†…å®¹:", cellText);
               
               // ã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢æ–¹æ³•
               let isTargetRow = false;
               
               // 1. textContentã§æ¤œç´¢
               if (cellText.includes("å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—")) {
                 isTargetRow = true;
                // console.log("âœ… textContentã§å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’ç™ºè¦‹");
               }
               
               // 2. innerHTMLã§æ¤œç´¢ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
               if (!isTargetRow && cell.innerHTML.includes("å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—")) {
                 isTargetRow = true;
                // console.log("âœ… innerHTMLã§å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’ç™ºè¦‹");
               }
               
               // 3. <b>ã‚¿ã‚°å†…ã‚’ç›´æ¥æ¤œç´¢
               if (!isTargetRow) {
                 const boldElements = cell.querySelectorAll('b');
                 for (let b of boldElements) {
                   if (b.textContent.includes("å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—")) {
                     isTargetRow = true;
                  //   console.log("âœ… <b>ã‚¿ã‚°å†…ã§å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’ç™ºè¦‹:", b.textContent.trim());
                     break;
                   }
                 }
               }
               
               if (isTargetRow) {
               //  console.log("âœ… å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã®è¡Œã‚’ç™ºè¦‹");
                 
                 // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã¨5ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
                 let text1 = "";
                 let text5 = "";
                 
                 // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«æŠ½å‡º
                 if (cells[0]) {
                   // åå‰éƒ¨åˆ†ã‚’å–å¾—ï¼ˆ<p>ã‚¿ã‚°å†…ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                   const nameElement = cells[0].querySelector('p');
                   if (nameElement) {
                     text1 = nameElement.textContent.trim().replace(/\s+/g, ' ');
                   } else {
                     // <p>ã‚¿ã‚°ãŒãªã„å ´åˆã¯å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ”¹è¡Œã‚’é™¤å»
                     text1 = cells[0].textContent.trim().replace(/\s+/g, ' ');
                   }
                 }
                 
                 // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç©ºç™½ã‚’æ•´ç†ï¼‰
                 if (cells[5]) {
                   text5 = cells[5].textContent.trim().replace(/\s+/g, ' ');
                 }
                 
                 extractedData.push({
                   type: "data",
                   text1: text1,
                   text5: text5
                 });
                 
                 console.log("ğŸ“ æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:", text1, "|", text5);
                 foundCount++;
               }
             }
           }
          
          //console.log("ğŸ” å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã®è¡Œæ•°:", foundCount);
          
           // æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦è¡¨ç¤ºç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›
           if (extractedData.length > 0) {
             let tableHtml = '<table style="border-collapse: collapse; width: 100%; font-size: 12px;">';
             
             // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
             const headerData = extractedData.find(item => item.type === "header");
             if (headerData) {
               tableHtml += '<tr style="background-color: #e0e0e0;">';
               tableHtml += '<th style="border: 1px solid #ccc; padding: 6px; width: 25%; font-size: 11px; text-align: left;">' + headerData.text1 + '</th>';
               tableHtml += '<th style="border: 1px solid #ccc; padding: 6px; width: 75%; font-size: 11px; text-align: left;">' + headerData.text5 + '</th>';
               tableHtml += '</tr>';
             }
             
             // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
             const dataItems = extractedData.filter(item => item.type === "data");
             dataItems.forEach((item, index) => {
               const bgColor = index % 2 === 0 ? '#fafafa' : '#ffffff';
               tableHtml += '<tr style="background-color: ' + bgColor + ';">';
               tableHtml += '<td style="border: 1px solid #ccc; padding: 6px; vertical-align: top; word-wrap: break-word; white-space: normal; line-height: 1.4;">' + item.text1 + '</td>';
               tableHtml += '<td style="border: 1px solid #ccc; padding: 6px; vertical-align: top; word-wrap: break-word; white-space: normal; line-height: 1.4;">' + item.text5 + '</td>';
               tableHtml += '</tr>';
             });
             
             tableHtml += '</table>';
             htmlLeft = tableHtml;
             console.log("âœ… æŠ½å‡ºå®Œäº†:", dataItems.length, "è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦è¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›");
           } else {
             console.log("âš ï¸ å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™");
             // htmlLeftã¯æ—¢ã«å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾ä½¿ç”¨
           }
        }

        // å³å´webviewã§æ–½è¨­IDã«åŸºã¥ã„ã¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠ
        console.log("ğŸ” æ–½è¨­ID:", facilityId);
        
        // å³å´webviewã§æ–½è¨­IDã«ä¸€è‡´ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã¿ã‚’é¸æŠ
        await right.executeJavaScript(`
          console.log("ğŸ” å³ãƒšãƒ¼ã‚¸ã§æ–½è¨­IDãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠé–‹å§‹...");
          
          // å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä¸€æ—¦ãƒã‚§ãƒƒã‚¯è§£é™¤
          const allCheckboxes = document.querySelectorAll('input[type="checkbox"][name^="f_ary"]');
          allCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // æŒ‡å®šã•ã‚ŒãŸæ–½è¨­IDã«ä¸€è‡´ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠ
          const targetCheckbox = document.querySelector('input[type="checkbox"][data-fid="${facilityId}"]');
          if (targetCheckbox) {
            targetCheckbox.checked = true;
            console.log("âœ… æ–½è¨­ID ${facilityId} ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã—ã¾ã—ãŸ");
          } else {
            console.log("âš ï¸ æ–½è¨­ID ${facilityId} ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        `);

        // åŠ ç®—åã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§ã€Œå°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã€ã‚’é¸æŠ
        console.log("ğŸ” åŠ ç®—åã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’é¸æŠä¸­...");
        await right.executeJavaScript(`
          const selectElement = document.querySelector('select[name="adding_children_id"]');
          if (selectElement) {
            // value="55"ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
            selectElement.value = "55";
            console.log("âœ… å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ï¼ˆvalue=55ï¼‰ã‚’é¸æŠã—ã¾ã—ãŸ");
          } else {
            console.log("âŒ åŠ ç®—åã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        `);

        // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdp1ã¨dp2ï¼‰ã«dateStrInputã®å€¤ã‚’ã‚»ãƒƒãƒˆ
        console.log("ğŸ” æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆä¸­...", dateValue);
        await right.executeJavaScript(`
          const dp1 = document.getElementById("dp1");
          const dp2 = document.getElementById("dp2");
          if (dp1 && dp2) {
            dp1.value = "${dateValue}";
            dp2.value = "${dateValue}";
            console.log("âœ… æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdp1ã¨dp2ï¼‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ:", "${dateValue}");
          } else {
            console.log("âŒ æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdp1ã¾ãŸã¯dp2ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        `);

        // æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
        console.log("ğŸ” æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸­...");
        await right.executeJavaScript(`
          const searchButton = document.querySelector('button.btn.search[type="submit"]');
          if (searchButton) {
            console.log("âœ… æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸ");
            searchButton.click();
          } else {
            console.log("âŒ æ¤œç´¢ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        `);

        // æ¤œç´¢å¾Œã®ãƒšãƒ¼ã‚¸æ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿ
        console.log("ğŸ” æ¤œç´¢å¾Œã®ãƒšãƒ¼ã‚¸æ›´æ–°ã‚’å¾…æ©Ÿä¸­...");
        await waitForPageReady(right);
        console.log("âœ… å³ãƒšãƒ¼ã‚¸ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ");

         let htmlRight = await right.executeJavaScript(`
           console.log("ğŸ” å³ãƒšãƒ¼ã‚¸:", document.title);
           const el = document.querySelector("table");
           if (!el) throw new Error("å³ãƒšãƒ¼ã‚¸ã«<table>ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
           el.outerHTML;
         `);

         // å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºå‡¦ç†
         console.log("ğŸ” å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºå‡¦ç†ã‚’é–‹å§‹...");
         
         // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’DOMè¦ç´ ã¨ã—ã¦è§£æ
         const tempDivRight = document.createElement('div');
         tempDivRight.innerHTML = htmlRight;
         const tableRight = tempDivRight.querySelector('table');
         
         if (!tableRight) {
           console.error("âŒ å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
           htmlRight = '<table><tr><td>å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr></table>';
         } else {
           const rowsRight = tableRight.querySelectorAll('tr');
           console.log("ğŸ“Š å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œæ•°:", rowsRight.length);
           
           // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®åˆ—æ•°ã‚’ç¢ºèª
           if (rowsRight.length > 0) {
             const headerCellsRight = rowsRight[0].querySelectorAll("th, td");
             console.log("ğŸ“‹ å³ã®ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—æ•°:", headerCellsRight.length);
             for (let i = 0; i < headerCellsRight.length; i++) {
               console.log("å³ã®åˆ—" + i + ":", headerCellsRight[i].textContent.trim());
             }
           }
           
           // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ã¨2ã®åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
           const extractedDataRight = [];
           
           // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æƒ…å ±ã‚’è¿½åŠ 
           if (rowsRight.length > 0) {
             const headerCellsRight = rowsRight[0].querySelectorAll("th, td");
             if (headerCellsRight.length > 2) {
               let headerText1 = "";
               let headerText2 = "";
               
               // ãƒ˜ãƒƒãƒ€ãƒ¼1ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«æŠ½å‡º
               if (headerCellsRight[1]) {
                 const nameElement = headerCellsRight[1].querySelector('p');
                 if (nameElement) {
                   headerText1 = nameElement.textContent.trim().replace(/\s+/g, ' ');
                 } else {
                   headerText1 = headerCellsRight[1].textContent.trim().replace(/\s+/g, ' ');
                 }
               }
               
               // ãƒ˜ãƒƒãƒ€ãƒ¼2ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç©ºç™½ã‚’æ•´ç†ï¼‰
               if (headerCellsRight[2]) {
                 headerText2 = headerCellsRight[2].textContent.trim().replace(/\s+/g, ' ');
               }
               
               extractedDataRight.push({
                 type: "header",
                 text1: headerText1,
                 text2: headerText2
               });
               console.log("ğŸ“‹ å³ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:", headerText1, "|", headerText2);
             }
           }
           
           // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æŠ½å‡º
           let foundCountRight = 0;
           for (let i = 1; i < rowsRight.length; i++) {
             const row = rowsRight[i];
             const cells = row.querySelectorAll("td");
             
             // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ã¨2ã®åˆ—ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
             if (cells.length > 2) {
               let text1 = "";
               let text2 = "";
               
               // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«æŠ½å‡º
               if (cells[1]) {
                 const nameElement = cells[1].querySelector('p');
                 if (nameElement) {
                   text1 = nameElement.textContent.trim().replace(/\s+/g, ' ');
                 } else {
                   text1 = cells[1].textContent.trim().replace(/\s+/g, ' ');
                 }
               }
               
               // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç©ºç™½ã‚’æ•´ç†ï¼‰
               if (cells[2]) {
                 text2 = cells[2].textContent.trim().replace(/\s+/g, ' ');
               }
               
               extractedDataRight.push({
                 type: "data",
                 text1: text1,
                 text2: text2
               });
               
               console.log("ğŸ“ å³ã®æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:", text1, "|", text2);
               foundCountRight++;
             }
           }
           
           console.log("ğŸ” å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«æŠ½å‡ºå®Œäº†:", foundCountRight, "è¡Œã®ãƒ‡ãƒ¼ã‚¿");
           
           // æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦è¡¨ç¤ºç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›
           if (extractedDataRight.length > 0) {
             let tableHtmlRight = '<table style="border-collapse: collapse; width: 100%; font-size: 12px;">';
             
             // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
             const headerDataRight = extractedDataRight.find(item => item.type === "header");
             if (headerDataRight) {
               tableHtmlRight += '<tr style="background-color: #e0e0e0;">';
               tableHtmlRight += '<th style="border: 1px solid #ccc; padding: 6px; width: 25%; font-size: 11px; text-align: left;">' + headerDataRight.text1 + '</th>';
               tableHtmlRight += '<th style="border: 1px solid #ccc; padding: 6px; width: 75%; font-size: 11px; text-align: left;">' + headerDataRight.text2 + '</th>';
               tableHtmlRight += '</tr>';
             }
             
             // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
             const dataItemsRight = extractedDataRight.filter(item => item.type === "data");
             dataItemsRight.forEach((item, index) => {
               const bgColor = index % 2 === 0 ? '#fafafa' : '#ffffff';
               tableHtmlRight += '<tr style="background-color: ' + bgColor + ';">';
               tableHtmlRight += '<td style="border: 1px solid #ccc; padding: 6px; vertical-align: top; word-wrap: break-word; white-space: normal; line-height: 1.4;">' + item.text1 + '</td>';
               tableHtmlRight += '<td style="border: 1px solid #ccc; padding: 6px; vertical-align: top; word-wrap: break-word; white-space: normal; line-height: 1.4;">' + item.text2 + '</td>';
               tableHtmlRight += '</tr>';
             });
             
             tableHtmlRight += '</table>';
             htmlRight = tableHtmlRight;
             console.log("âœ… å³ã®æŠ½å‡ºå®Œäº†:", dataItemsRight.length, "è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦è¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›");
           } else {
             console.log("âš ï¸ å³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™");
             // htmlRightã¯æ—¢ã«å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾ä½¿ç”¨
           }
         }

         resultView.innerHTML =
          '<div id="resultContainer">' +
            '<div class="result-half">' +
              '<h2>ğŸ“˜ å·¦ãƒšãƒ¼ã‚¸ï¼ˆè¨˜éŒ²ä¸€è¦§ï¼‰</h2>' +
              '<div class="table-wrapper">' + htmlLeft + '</div>' +
            '</div>' +
            '<div class="result-half">' +
              '<h2>ğŸ“™ å³ãƒšãƒ¼ã‚¸ï¼ˆè¨ˆç”»çŠ¶æ³ï¼‰</h2>' +
              '<div class="table-wrapper">' + htmlRight + '</div>' +
            '</div>' +
          '</div>';

        tabResult.click();

      } catch (err) {
        console.error("ğŸ’¥ æ§‹é€ å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
        alert("æ§‹é€ å–å¾—ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });
  </script>
</body>
</html>
