/**
 * JS共通関数
 * Created by Nozue on 2015/07/17.
 */


/**
 * ふりがなから名前リストを生成
 * @param mode
 * @param key
 */

$(document).ready(function() {

    $("[onclick]").each(function() {
        var onclickAttr = $(this).attr("onclick");

        // onclickが"window.print();"の場合
        if (onclickAttr && onclickAttr.trim() === "window.print();") {
            // onclick属性を削除
            $(this).removeAttr("onclick");

            // クラスを追加
            $(this).addClass("print_chrome_js");
        }
    });

    var originalScrollTop;

    function handlePrint() {
        // 現在のスクロール位置を保存
        originalScrollTop = $(window).scrollTop();

        // ページを上部にスクロール
        $(window).scrollTop(0);

        // 印刷ダイアログを開く
        window.print();
    }

    // 印刷ダイアログが閉じられた後にスクロール位置を元に戻す
    $(window).on("afterprint", function() {
        if (originalScrollTop !== undefined) {
            $(window).scrollTop(originalScrollTop);
            originalScrollTop = undefined; // Reset the variable
        }
    });

    $(document).on("click", ".print_chrome_js", (function () {
        handlePrint();
    }));
});
function comboBoxNameList(mode, key,id) {

    if ($('[name=s_year]').val()) {
        var year = $('[name=s_year]').val();
    }
    if ($('[name=s_month]').val()) {
        var month = $('[name=s_month]').val();
    }

    if (year && month) {
        var date = year+'-'+month+'-01';
    }else{
        if ($('[name=result_dateYear]').val()) {
            var year = $('[name=result_dateYear]').val();
        }
        if ($('[name=result_dateMonth]').val()) {
            var month = $('[name=result_dateMonth]').val();
        }
        if (year && month) {
            var date = year+'-'+month+'-01';
        }else{
            var date = '';
        }
    }

    var f_id = $('#f_id').val();

    var url = prePath + "./ajax/ajax_furigana.php?mode=" + mode + "&key=" + key + "&date=" + date + "&f_id=" + f_id;
    //pageを取得しておく
    var page_name = "";
    //現在のページを取得する
    page_name = window.location.href.split('/').pop();
    page_name = page_name.substring(0, page_name.indexOf("."));

    var domid = id;

    $.ajax({
        type: 'get',
        url: url,
        data:{
            "page":page_name,
        },
        timeout: 3000,
        dataType: 'jsonp',
        jsonpCallback: 'nameList',
        success: function (json) {

            if (mode == "parent") {

                //一度プルダウン内を全削除
                $('#parent_list > option').remove();
                $('#parent_list').append($('<option>').html('----').val(0));

                //新しい値をセット
                if (json) {
                    Object.keys(json).forEach(function (key) {
                        var key_data = this[key]["key"];
                        var val_data = this[key]["val"];

                        $('#parent_list').append($('<option>').html(val_data).val(key_data));
                    }, json);
                }
            } else if (mode == "school") {

                //一度プルダウン内を全削除
                $('#school_list > option').remove();
                $('#school_list').append($('<option>').html('----').val(0));

                //新しい値をセット
                if (json) {
                    Object.keys(json).forEach(function (key) {
                        var key_data = this[key]["key"];
                        var val_data = this[key]["val"];

                        $('#school_list').append($('<option>').html(val_data).val(key_data));
                    }, json);
                }
                //一度プルダウン内を全削除
                $('#school_name > option').remove();
                $('#school_name').append($('<option>').html('----').val(0));

                //新しい値をセット
                if (json) {
                    Object.keys(json).forEach(function (key) {
                        var key_data = this[key]["key"];
                        var val_data = this[key]["val"];

                        $('#school_name').append($('<option>').html(val_data).val(key_data));
                    }, json);
                }
            } else if (mode == "support_office") {

                //一度プルダウン内を全削除
                $('#office_name_list > option').remove();
                $('#office_name_list').append($('<option>').html('----').val(0));

                //新しい値をセット
                if (json) {
                    Object.keys(json).forEach(function (key) {
                        var key_data = this[key]["key"];
                        var val_data = this[key]["val"];

                        $('#office_name_list').append($('<option>').html(val_data).val(key_data));
                    }, json);
                }
            } else {
                //一度プルダウン内を全削除
                if (page_name == "facility_other_agreement"){
                    $('#'+domid).find(".name_list > option").remove();
                    $('#'+domid).find(".name_list").append($('<option>').html('----').val(0));
                    //新しい値をセット
                    if (json) {
                        Object.keys(json).forEach(function (key) {
                            var key_data = this[key]["key"];
                            var val_data = this[key]["val"];

                            $('#'+domid).find(".name_list").append($('<option>').html(val_data).val(key_data));
                        }, json);
                    }
                }else if(page_name == "payment" || page_name == "mirror_payment" || page_name == "payment-consultation" || page_name == "payment-plan-consultation"){
                    //一度プルダウン内を全削除（キャンセルの際、再挿入のため変数に入れる）
                    detached_facility_name_combo = $('#manage_facility'+id).find('option').detach();
                    //ふりがなのコンボボックスを使用したのでフラグを立てる
                    $('#manage_facility'+id).attr("data-js_facility_combo_flg",1);
                    $('#manage_facility'+id).append($('<option>').html('なし').val('f'+0));
                    if (json) {
                        Object.keys(json).forEach(function (key) {
                            var key_data = this[key]["key"];
                            var val_data = this[key]["val"];
                            $('#manage_facility'+id).append($('<option>').html(val_data).val(key_data));
                        }, json);
                    }

                    //自施設選んだ後に五十音変更したとき、上限管理加算の取得設定を非活性にする
                    if($('#manage_facility'+id).val() == ('f'+0)){
                        $('#js_manage_limit'+id).val(0);
                        $('#js_manage_limit'+id).css({
                            'pointer-events': 'none',           // 1camelCase形式で指定
                            'color': '#CCC',           // 1camelCase形式で指定
                            'background-color': '#E5E5E5'  // 2ハイフン形式で指定
                        });
                    }
                    //兄弟の上限管理の処理を動かす
                    $('#manage_facility'+id).trigger("change");

                }else{
                    $('#name_list > option').remove();
                    $('#name_list').show();
                    $("#js_initial_none").remove();


                    //初期値の設定がいらない場合
                    if(domid == "initial_none"){
                        if(json.length == 0){
                            $('<span id="js_initial_none"><b class="red">選択できる施設がありません。</b></span>').insertAfter('#name_list');
                            $('#name_list').hide();
                            $('.save').addClass('disable');
                        }else{
                            $('.save').removeClass('disable');
                        }
                    }else{
                        $('#name_list').append($('<option>').html('----').val(0));
                    }

                    $('#name_list_contactbook > option').remove();
                    $('#name_list_contactbook').append($('<option>').html('----').val(0));

                    //新しい値をセット
                    if (json) {
                        // Object.keys(json).forEach(function (key) {
                        //     var val = this[key];
                        //     $('#name_list').append($('<option>').html(val).val(key));
                        //     $('#name_list_contactbook').append($('<option>').html(val).val(key));
                        // }, json);

                        Object.keys(json).forEach(function (key) {
                            var key_data = this[key]["key"];
                            var val_data = this[key]["val"];

                            $('#name_list').append($('<option>').html(val_data).val(key_data));
                            $('#name_list_contactbook').append($('<option>').html(val_data).val(key_data));
                        }, json);
                    }

                    $(".children_info").html("");
                }

            }

        },
        error: function () {

            alert("通信に失敗しました。");
        }
    });
}


/**
 * ふりがなから名前リストを生成
 * @param mode
 * @param key
 */

$(document).on("change", ".comboBoxStaffJquery", (function() {

    //pageを取得しておく
    var page_name = "";
    //現在のページを取得する
    page_name = window.location.href.split('/').pop();
    page_name = page_name.substring(0, page_name.indexOf("."));

    var hiduke=new Date();

    //年・月・日・曜日を取得する
    var year = hiduke.getFullYear();
    var month_tmp= hiduke.getMonth()+1;
    var month = ('0' +month_tmp).slice(-2);
    var day =('0' + hiduke.getDate()).slice(-2);

    var date = year+'-'+month+'-'+day;


    //退職日の判定などにその日付を取得してみる
    if($("[name=cal_date]").val()){
        var date = $("[name=cal_date]").val();
    }else if($("[name=date]").val()){
        var date = $("[name=date]").val();
    }else if($("[name=s_date]").val()){
        var date = $("[name=s_date]").val();
    }else if($("[name=careplan_date]").val()){
        var date = $("[name=careplan_date]").val();
    }else if($("[name=event_date]").val()){
        var date = $("[name=event_date]").val();
    }else if($("[name=js_use_date]").val()){
        date = $("[name=js_use_date]").val();
    }


    //送迎の編集・一括編集画面の場合
    if($(".js_pickup_f_ary").length){
        //車輌IDを取得する
        if($(this).closest('.js_reference_flights').find(".js_vehicle_area").prop("disabled")){
            var vehicle_info = 0;
        }else{
            var vehicle_info = $(this).closest('.js_reference_flights').find(".js_vehicle_area").val();
            if(vehicle_info == ""){
                vehicle_info = 0;
            }
        }

        //一括編集画面の操作オプション用
        if(vehicle_info == "9999"){
            vehicle_info = 0;
        }

        //車輌IDから選択した車輌の所属施設を取得する
        var f_ary = $("#js_driver_staff_"+vehicle_info).data("staff_facility");

    }else{
        //連結された施設IDを取得
        var f_ary = $("#hidden_f_ary").text();
    }

    //もし指定クラスがあったら勤務情報追加のページ
    if($("th").hasClass("shiftEditDateHeading")){
        var shift_attend_flg = 1;
        var f_id  = $("[name=f_id]").val();
    }else{
        var shift_attend_flg = 0;

        //一括編集等の施設複数表示用
        if($(this).closest("tr").find(".js_get_f_id").length == 1) {
            var f_id = $(this).closest("tr").find(".js_get_f_id").data("f_id");
        }else{

            //今日の利用者は除外する
            if(page_name != "attendance"){
                var f_id  = $("[name=f_id]").val();
            }
        }
    }

    //ページ名が出勤実績表だった場合
    if (page_name == 'staff-attendance'){
        var page_flg = 1;
    //ページ名が出席予定表だった場合
    } else if (page_name == 'shift'){
        var page_flg = 2;
    } else if (page_name == 'record_proceedings') {
        var page_flg = 3;
    } else {
        var page_flg = 0;
    }

    // 月単位の情報を持ってきたい場合のフラグがあるかチェック
    var staff_get_type = "";
    if($('.js_staff_get_type').length){
        staff_get_type = $('.js_staff_get_type').val();
    }

    date = date.replace(/\u002f/g, "-");
    var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(this).val() + "&date="+date+"&saf="+shift_attend_flg+"&fid="+f_id+"&page_flg="+page_flg+"&staff_get_type="+staff_get_type+"&page_name="+page_name;
    var dom = $(this);

    $.ajax({
        type: 'post',
        url: url,
        timeout: 3000,
        dataType: 'jsonp',
        data: {
            "f_ary": f_ary,
        },
        jsonpCallback: 'nameList',
        success: function (json) {
            //必ず要素が隣にあることを利用する
            //隣の要素のoption配列をまず初期化する
            $(dom).next().find("option").remove();

            //pageを取得しておく
            var page_name = "";
            //現在のページを取得する
            page_name = window.location.href.split('/').pop();
            page_name = page_name.substring(0, page_name.indexOf("."));

            //ページ名が出勤実績表だった場合

            if(page_name != "operation_daily_report"){
                $(dom).next().append($('<option>').html('----').val(0));
            }

            //新しい値をセット
            if (json != "none") {
				if(page_name == "operation_daily_report") {
                    $(json).each(function(i, elem) {
                        $(dom).next().append($('<option>').html(elem.name).val(elem.id));
                    });

                } else {
                    Object.keys(json).forEach(function (key) {
                        var val = this[key];
                        $(dom).next().append($('<option>').html(val).val(key));
                    }, json);

                	$("[name=record_staff]").find("option:first").remove();
                	$("[name=staff]").find("option:first").remove();
            	}
            }


        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            console.log("XMLHttpRequest : " + XMLHttpRequest.status);
            console.log("textStatus     : " + textStatus);
            console.log("errorThrown    : " + errorThrown.message);
            alert("通信に失敗しました。");
        }
    });
}));


//日付変更されたとき用の関数
function setStaffCommon(){
    var hiduke=new Date();

    //年・月・日・曜日を取得する
    var year = hiduke.getFullYear();
    var month_tmp= hiduke.getMonth()+1;
    var month = ('0' +month_tmp).slice(-2);
    var day =('0' + hiduke.getDate()).slice(-2);

    var date = year+'-'+month+'-'+day;

    //退職日の判定などにその日付を取得してみる
    if($("[name=cal_date]").val()){
        var date = $("[name=cal_date]").val();
    }else if($("[name=date]").val()){
        var date = $("[name=date]").val();
    }else if($("[name=s_date]").val()){
        var date = $("[name=s_date]").val();
    }else if($("[name=careplan_date]").val()){
        var date = $("[name=careplan_date]").val();
    }else if($("[name=event_date]").val()){
        var date = $("[name=event_date]").val();
    }else{
        var hiduke=new Date();

        //年・月・日・曜日を取得する
        var year = hiduke.getFullYear();
        var month = hiduke.getMonth()+1;
        month = ('0' + month).slice(-2);
        var day =('0' + hiduke.getDate()).slice(-2);

        var date = year+'-'+month+'-'+day;
    }

    date = date.replace(/\u002f/g, "-");
    //pageを取得しておく
    var page_name = "";
    //現在のページを取得する
    page_name = window.location.href.split('/').pop();
    page_name = page_name.substring(0, page_name.indexOf("."));


    if(page_name == "individual_before-meeting"){
        var f_id  = $("[name=f_id]").val();
        var staff_get_type = "";
        if($('.js_staff_get_type').length){
            staff_get_type = $('.js_staff_get_type').val();
        }
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date+"&fid="+f_id+"&staff_get_type="+staff_get_type;
    }else if(page_name == "operation_daily_report"){
        var f_id  = $("[name=f_id]").val();
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date + "&fid="+f_id + "&page_name="+page_name;
        var staff_id = $("[name=staff_id]").val();
    }else{
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date;
    }

    var dom =  $(".comboBoxStaffJquery");
    $.ajax({
        type: 'get',
        url: url,
        timeout: 3000,
        dataType: 'jsonp',
        jsonpCallback: 'nameList',
        success: function (json) {
            //必ず要素が隣にあることを利用する
            //隣の要素のoption配列をまず初期化する
            $(dom).next().find("option").remove();

            //ページ名が出勤実績表だった場合
            if(page_name != "operation_daily_report"){
                $(dom).next().append($('<option>').html('----').val(0));
            }
            //新しい値をセット
            if (json != "none") {
                // 業務日報画面の場合
                if(page_name == "operation_daily_report"){
                    $(json).each(function(i, elem) {
                        $(dom).next().append($('<option>').html(elem.name).val(elem.id));
                    });

                    //selected設定
                    $("[name=staff_id]").val(staff_id);
                    $(".operation_daily_report_staff_err").hide();  // 初回以外は要らないので消す
                }else{
                    Object.keys(json).forEach(function (key) {
                        var val = this[key];
                        $(dom).next().append($('<option>').html(val).val(key));
                    }, json);
                }
            }

            //送迎管理なら、車輛を絞り込む
            if(page_name == "pickup"){

                var url_vehicle = "./ajax/ajax_vehicle.php";
                $.ajax({
                    url: url_vehicle,
                    data:{
                        "date":date
                    },
                    timeout: 3000,
                    dataType: 'text',
                    success: function (data) {
                        $(".js_option_vehicle").html(data);
                    }
                });
            }

            //送迎管理なら、車輛を絞り込む
            if(page_name == "pickup"){

                var url_vehicle = "./ajax/ajax_vehicle.php";
                $.ajax({
                    url: url_vehicle,
                    data:{
                        "date":date
                    },
                    timeout: 3000,
                    dataType: 'text',
                    success: function (data) {
                        $(".js_option_vehicle").html(data);
                    }
                });
            }
        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });
}

// 施設変更された時用のスタッフ取得関数
function setFacilityChangeStaffCommon(){
    var hiduke=new Date();

    //年・月・日・曜日を取得する
    var year = hiduke.getFullYear();
    var month_tmp= hiduke.getMonth()+1;
    var month = ('0' +month_tmp).slice(-2);
    var day =('0' + hiduke.getDate()).slice(-2);

    var date = year+'-'+month+'-'+day;

    //退職日の判定などにその日付を取得してみる
    if($("[name=cal_date]").val()){
        var date = $("[name=cal_date]").val();
    }else if($("[name=date]").val()){
        var date = $("[name=date]").val();
    }else if($("[name=s_date]").val()){
        var date = $("[name=s_date]").val();
    }else if($("[name=careplan_date]").val()){
        var date = $("[name=careplan_date]").val();
    }else if($("[name=event_date]").val()){
        var date = $("[name=event_date]").val();
    }else{
        var hiduke=new Date();

        //年・月・日・曜日を取得する
        var year = hiduke.getFullYear();
        var month = hiduke.getMonth()+1;
        month = ('0' + month).slice(-2);
        var day =('0' + hiduke.getDate()).slice(-2);

        var date = year+'-'+month+'-'+day;
    }

    date = date.replace(/\u002f/g, "-");
    //pageを取得しておく
    var page_name = "";
    //現在のページを取得する
    page_name = window.location.href.split('/').pop();
    page_name = page_name.substring(0, page_name.indexOf("."));


    if(page_name == "individual_before-meeting"){
        var f_id  = $("[name=f_id]").val();
        var staff_get_type = "";
        if($('.js_staff_get_type').length){
            staff_get_type = $('.js_staff_get_type').val();
        }
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date+"&fid="+f_id+"&staff_get_type="+staff_get_type;
    }else if(page_name == "operation_daily_report"){
        var f_id  = $("[name=f_id]").val();
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date + "&fid="+f_id + "&page_name="+page_name;
        var staff_id = $("[name=staff_id]").val();
    }else{
        var url = "./ajax/ajax_staff.php?mode=c_staff&key=" + $(".comboBoxStaffJquery").val() + "&date="+date;
    }

    var dom =  $(".comboBoxStaffJquery");
    $.ajax({
        type: 'get',
        url: url,
        timeout: 3000,
        dataType: 'jsonp',
        jsonpCallback: 'nameList',
        success: function (json) {
            //必ず要素が隣にあることを利用する
            //隣の要素のoption配列をまず初期化する
            $(dom).next().find("option").remove();

            //ページ名が出勤実績表だった場合
            if(page_name != "operation_daily_report"){
                $(dom).next().append($('<option>').html('----').val(0));
            }
            //新しい値をセット
            if (json != "none") {
                // 業務日報画面の場合
                if(page_name == "operation_daily_report"){
                    $(json).each(function(i, elem) {
                        $(dom).next().append($('<option>').html(elem.name).val(elem.id));
                    });

                    //selected設定
                    $("[name=staff_id]").val(staff_id);
                    $(".operation_daily_report_staff_err").hide();  // 初回以外は要らないので消す
                }else{
                    Object.keys(json).forEach(function (key) {
                        var val = this[key];
                        $(dom).next().append($('<option>').html(val).val(key));
                    }, json);
                }
            }

            //送迎管理なら、車輛を絞り込む
            if(page_name == "pickup"){

                var url_vehicle = "./ajax/ajax_vehicle.php";
                $.ajax({
                    url: url_vehicle,
                    data:{
                        "date":date
                    },
                    timeout: 3000,
                    dataType: 'text',
                    success: function (data) {
                        $(".js_option_vehicle").html(data);
                    }
                });
            }

            //送迎管理なら、車輛を絞り込む
            if(page_name == "pickup"){

                var url_vehicle = "./ajax/ajax_vehicle.php";
                $.ajax({
                    url: url_vehicle,
                    data:{
                        "date":date
                    },
                    timeout: 3000,
                    dataType: 'text',
                    success: function (data) {
                        $(".js_option_vehicle").html(data);
                    }
                });
            }
        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });
}

/**
 * 削除確認関数
 * @param url
 * @param mode
 * @param id
 */
function deleteConfirm(url, mode, id) {
    if(window.confirm('削除してよろしいですか？')) {
        location.href='./'+url+'?mode='+mode+'&id='+id;
    }
}


/**
 * シフト情報(月)の削除確認
 * @param url
 * @param mode
 */
function deleteShiftConfirm(url, mode) {
    if(window.confirm('月のシフト情報を削除してよろしいですか？')) {

        location.href='./'+url+mode;
    }
}

/**
 * シフト情報(月)の削除確認
 * @param url
 * @param mode
 */
function deleteShiftAttendanceConfirm(url, mode) {
    if(window.confirm('月の実績情報を削除してよろしいですか？')) {

        location.href='./'+url+mode;
    }
}

/**
 * リセット確認関数
 * @param url
 * @param mode
 * @param id
 */
function resetConfirm(url, mode, id) {
    if(window.confirm('出席情報をリセットしてよろしいですか？')) {
        location.href='./'+url+'?mode='+mode+'&id='+id;
    }
}

/**
 * リセット確認関数
 * @param url
 * @param mode
 * @param id
 */
function resetConfirm2(url, mode, id) {
    if(window.confirm('情報をリセットしてよろしいですか？')) {
        location.href='./'+url+'?mode='+mode+'&id='+id;
    }
}

/**
 * リセット確認関数
 * @param url
 * @param mode
 * @param id
 */
function resetDutyConfirm(url, mode, id) {
    if(window.confirm('勤務時間をリセットしてよろしいですか？')) {
        location.href='./'+url+'?mode='+mode+'&id='+id;
    }
}

function resetDutyConfirm(url, mode, id) {
    if(window.confirm('勤務時間をリセットしてよろしいですか？')) {
        location.href='./'+url+'?mode='+mode+'&id='+id;
    }
}


$(function(){
    // 画面サイズ取得
    var w = $(window).width();
    if (w <= 480) {
        size = 300;
    } else {
        size = 600;
    }

    //　モーダル初期設定
    $('#delete_dialog').dialog({
        autoOpen: false,  // 自動でオープンしない
        width: size,       // 横幅のサイズを設定
        modal: true,      // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        // show: "clip",     // 表示時のエフェクト
        hide: "fade",      // 非表示時のエフェクト
        dialogClass: "dialogOuter",
        buttons: [        // ボタン名 : 処理 を設定
            {
                text: '削除実行',
                click: function(){
                    $("#delete_ok").submit();
                },
                class: 'btn btn-sm delete'
            },
            {
                text: 'キャンセル',
                click: function(){
                    window.history.back();
                },
                class: 'btn btn-sm cancel'
            }
        ]
    });


    $('.jquery_ui_delete').click(function () {
        // 予約IDなど用意

        $('#delete_dialog').dialog('open');
        return false;
    });

    $('#confirm_dialog').dialog({
        autoOpen: false,  // 自動でオープンしない
        width: size,       // 横幅のサイズを設定
        modal: true,      // モーダル表示する
        resizable: false, // リサイズしない
        draggable: false, // ドラッグしない
        // show: "clip",     // 表示時のエフェクト
        hide: "fade",      // 非表示時のエフェクト
        dialogClass: "dialogOuter",
        buttons: [        // ボタン名 : 処理 を設定
            {
                text: '登録データを残したまま保存する',
                click: function(){
                    $("#confirm_ok").submit();
                },
                class: 'btn btn-sm confirm'
            },
            {
                text: '登録データを削除して保存する',
                click: function(){
                    $("#confirm_ok").append('<input type="hidden" name="delete_flg" value="1">');
                    $("#confirm_ok").submit();

                },
                class: 'btn btn-sm confirm'
            },
            {
                text: 'キャンセル',
                click: function(){
                    $(this).dialog( 'close' );
                },
                class: 'btn btn-sm cancel'
            }
        ]
    });
    $('.jquery_ui_confirm').click(function () {
        // 予約IDなど用意

        $('#confirm_dialog').dialog('open');
        return false;
    });


    $('[name=setexpire]').click(function () {
        // 予約IDなど用意
        if($(this).prop("checked")){
            document.cookie = 'setLoginChecked=setChecked';
        }else{
            document.cookie = 'setLoginChecked=noChecked';
        }
    });

    //チェックのやつ
    var setCookie = document.cookie.split(';');
    setCookie.forEach(function(value) {

        //cookie名と値に分ける
        var content = value.split('=');
        content[0] = $.trim(content[0]);
        if(content[0] == "setLoginChecked"){
            if(content[1] == "setChecked"){
                $("[name=setexpire]").prop("checked",true);
            }else{
                $("[name=setexpire]").prop("checked",false);
            }
        }

    });

    // モーダル画面以外のブラウザ領域をクリックで、モーダル非表示
    $(document).on('click', '.ui-widget-overlay', function(){
        $(this).prev().find('.ui-dialog-content').dialog('close');
    });

});

/**
 * 操作オプションにある施設の数が1の場合、ボタンを非表示にする
 */
$(document).ready(function(){
    //施設数をカウント
    var checkbox_len = $("#facility_check").find("input:checkbox").length;

    if(checkbox_len == 1){
        $(".check_dom").hide();
        //表示を元に戻すため、class削除
        $("#facility_check").removeClass("clear dispblo pl15 mb10");
    }

});

/**
 * 操作オプションにある施設のチェックボックスを全てチェックする処理
 */
function FacilityAllCheck(checked, design_flg) {

    //デザインが載ったチェックボックスの場合
    if(design_flg == 1){

        //pageを取得しておく
        var page_name = "";
        //現在のページを取得する
        page_name = window.location.href.split('/').pop();
        page_name = page_name.substring(0, page_name.indexOf("."));

        //請求ページにチェックボックスが非活性になっている場合があるのでそれは除外する
        $("#facility_check > input:checkbox").each(function (x, elem) {
            //請求ページにチェックボックスが非活性になっている場合があるのでそれは除外する
            if (checked) {
                var id = $(elem).attr("id");
                //$("#facility_check").find("[for="+id+"]").hasClass("disabled");
                if($("[for="+id+"]").hasClass("disabled")){
                    return true;
                }else{
                    $(elem).prop("checked", true);
                }
            }else{
                $(elem).prop("checked", false);
            }
        });

        //利用者への請求書・領収書だった場合
        if((page_name == "user-invoice") || (page_name == "user-receipt")){
            //既に請求書・領収書の設定がされた施設をチェックした場合のエラー表示関数
            DisplayDnFacilityError();
            //合わせて出力する施設を変更した場合のエラー表示関数
            changeSelectFacility();
        }

    }else{
        //請求ページにチェックボックスが非活性になっている場合があるのでそれは除外する
        $("#facility_check > label").not('.checkbox-disable').each(function (x, elem) {
            if (checked) {
                $(this).find("input:checkbox").prop("checked", true);
            }else{
                $(this).find("input:checkbox").prop("checked", false);
            }
        });
    }
}

/**
 * クラスを指定してチェックボックスを全て選択/解除する汎用関数
 * @param {boolean} is_checked - チェックを入れる(true)か外す(false)か
 * @param {string} container_class - チェックボックスを含むコンテナのクラス名
 * @param {number} design_flg - デザインフラグ（1=特殊デザイン対応）
 */
function checkboxClassControl(is_checked, container_class, design_flg = 0) {

    // 指定されたクラス名を持つ最初の要素を指定してcontainer変数に格納
    const container = document.querySelector(`.${container_class}`);
    
    // コンテナが存在しない場合はエラーメッセージを表示
    if (!container) {
        console.error(`Container with class '${container_class}' not found.`);
        return;
    }

    // デザインが載ったチェックボックスの場合
    if (design_flg == 1) {
        // 現在のページを取得する
        var page_name = window.location.href.split('/').pop();
        page_name = page_name.substring(0, page_name.indexOf("."));

        // コンテナ内のチェックボックスを処理
        container.querySelectorAll('input[type="checkbox"]').forEach(function(elem) {
            if (is_checked) {
                var element_id = elem.getAttribute("id");
                // 無効化されているチェックボックスは処理をスキップ
                if (element_id && document.querySelector(`[for="${element_id}"]`) && 
                    document.querySelector(`[for="${element_id}"]`).classList.contains("disabled")) {
                    return;
                } else {
                    elem.checked = true;
                }
            } else {
                elem.checked = false;
            }
        });

        // 利用者への請求書・領収書だった場合
        if ((page_name == "user-invoice") || (page_name == "user-receipt")) {
            if (typeof DisplayDnFacilityError === 'function') {
                // 既に請求書・領収書の設定がされた施設をチェックした場合のエラー表示関数
                DisplayDnFacilityError();
            }
            if (typeof changeSelectFacility === 'function') {
                // 合わせて出力する施設を変更した場合のエラー表示関数
                changeSelectFacility();
            }
        }

    } else {
        // 請求ページにチェックボックスが非活性になっている場合があるのでそれは除外する
        container.querySelectorAll('label:not(.checkbox-disable)').forEach(function(elem) {
            const checkbox = elem.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = is_checked;
            }
        });
    }
}

/**
 * 特定のクラスに属するチェックボックスグループを全て選択する
 * @param {string} container_class - チェックボックスを含むコンテナのクラス名 
 * @param {number} design_flg - デザインフラグ
 */
function checkAllByClass(container_class, design_flg = 0) {
    checkboxClassControl(true, container_class, design_flg);
}

/**
 * 特定のクラスに属するチェックボックスグループを全て解除する
 * @param {string} container_class - チェックボックスを含むコンテナのクラス名
 * @param {number} design_flg - デザインフラグ
 */
function uncheckAllByClass(container_class, design_flg = 0) {
    checkboxClassControl(false, container_class, design_flg);
}

//個別支援計画・モニタリングの説明同意日
$(document).on("click", ".visible_agree_date",(function() {
    if ($(this).prop("checked")){
        $("#agree_date").show();
    }else{
        $("#agree_date").hide();
    }
}));

//個別支援計画・モニタリングの保護者サイン欄
$(document).on("click", ".visible_parent_representative",(function() {
    if ($(this).prop("checked")){
        $("#parent_representative").show();
    }else{
        $("#parent_representative").hide();
    }
}));

$(document).on("click", ".setumei_bun",(function() {
    if ($(this).prop("checked")){
        $(this).closest('.js_form_div').next('div').find('.js_explanation1').show();
    }else{
        $(this).closest('.js_form_div').next('div').find('.js_explanation1').hide();
    }
}));
$(document).on("click", ".setumei_bun2",(function() {
    if ($(this).prop("checked")){
        $(this).closest('.js_form_div').next('div').find('.js_explanation2').show();
    }else{
        $(this).closest('.js_form_div').next('div').find('.js_explanation2').hide();
    }
}));

//個別支援計画・モニタリングの保護者サイン欄、「任意のテキスト」のテキストボックス表示非表示
$(document).ready(function() {
    $('.any_text_check').on('change', function() {
        if ($(this).val() === '2' && $(this).prop('checked')) {
            $('#any_text').show();
        } else {
            $('#any_text').hide();
        }
    });
});

$(function(){
    $('.profile_children_error').hide();
    $('.profile_children_error_text').on('click', function() {
        $(this).closest('.error-box').find('.profile_children_error').slideToggle(200);
        $(this).find(".fa-caret-down").toggleClass('up');
    });
});

//半角数字以外削除処理
$(document).on("input", ".js_input_number_only", (function() {

    //制限する桁数取得
    var max_length = $(this).data("max_length");

    //制限する桁数がない場合は、固定値を入れる
    if(max_length < 1){
        max_length = 6;
    }

    // 半角変換
    var halfVal = $(this).val().replace(/[！-～]/g,
        function (tmpStr) {
            // 文字コードをシフト
            return String.fromCharCode(tmpStr.charCodeAt(0) - 0xFEE0);
        }
    );
    // 数字以外の不要な文字を削除
    $(this).val(halfVal.replace(/[^0-9]/g, ''));
    if ($(this).val().length > max_length) {
        $(this).val($(this).val().substr(0,max_length));
    }

}));


$(function(){
    //ページを取得して判定する
    //pageを取得しておく
    var page_name = "";
    //現在のページを取得する
    page_name = window.location.href.split('/').pop();
    page_name = page_name.substring(0, page_name.indexOf("."));

    if ( page_name.match(/mirror/)) {
        var s_year = $("[name=s_year]").val();
        var s_month = $("[name=s_month]").val();
        var start_date = s_year + "-" + ('0' + s_month).slice(-2) + "-01";

        //bodyにclassが付いているか判定
        var class_length =  $("body").attr("class");

        //フローの番号を取得する
        if(class_length){
            var class_length_id = class_length.replace("paymentFlow0", "");
        }

        //何も付いていない又は通常請求の場合は付与する
        if((class_length == "") || (class_length_id == "9") && start_date == "2020-03-01"){
            $("body").attr("class","");
            $("body").addClass("emergency");
            $("h1").after('<div class="emergencyTxt"><p>現在「HUGのサポートに連絡して変更した請求情報」を閲覧中です。</p></div>');
        }
    }
});

// コメント機能用　表示・非表示
$(function(){
    $(document).on('click', '.js_toggle_btn', function() {
        var disp_key = $(this).closest(".js_toggle_data").data("disp_key");
        if ($(this).hasClass("close-p-cmt")) {
            $(".js_toggle_area"+disp_key).slideToggle();
            $(this).closest(".js_toggle_data").find(".js_close_btn").show();
            $(this).hide();

        } else {
            $(".js_toggle_area"+disp_key).slideToggle();
            $(this).closest(".js_toggle_data").find(".close-p-cmt").show();
            $(this).hide();
        }

    });
});





//相談支援事業所一覧取得
function changeSupportOffice(date) {

    var office_name_list_val = $('#office_name_list').val();

    var url = "./ajax/ajax_support_office.php";
    $.ajax({
        url: url,
        data:{
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $("#office_name_list").html(data).val(office_name_list_val);
        }
    });
}


//他施設一覧取得
function changeFacilityOther(date) {

    // 施設idをある分だけ取得
    let selected_facility_other_elm = document.querySelectorAll('.facility_other_list');
    let selected_facility_other_val = [];
    selected_facility_other_elm.forEach(function(elm) {
        selected_facility_other_val.push(elm.value);
    });

    var pagename = $(".pagename").val();

    var url = "./ajax/ajax_facility_other_list.php";
    $.ajax({
        url: url,
        data:{
            "date":date,
            "pagename":pagename
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            selected_facility_other_val.forEach(function (val, key) {
                key = key + 1;
                let $selected_name = $(`select[name="other_facility[${key}]"]`);
                $selected_name.html(data).val(val);
            });
        }
    });
}


//市町村一覧取得
function changeCity(date) {

    var city_list_val = $('.city_list').val();

    var url = "./ajax/ajax_city_list.php";
    $.ajax({
        url: url,
        data:{
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $(".city_list").html(data).val(city_list_val);
        }
    });
}


//学校一覧取得
function changeSchool(date) {

    var school_list_val = $('.school_list').val();

    var url = "./ajax/ajax_school_list.php";
    $.ajax({
        url: url,
        data:{
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $(".school_list").html(data).val(school_list_val);
        }
    });
}

//弁当一覧取得
function changeLunch(date) {

    var lunch_list_val = $('.lunch_list').val();

    var url = "./ajax/ajax_lunch_list.php";
    $.ajax({
        url: url,
        data:{
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $(".lunch_list").html(data).val(lunch_list_val);
        }
    });
}


//シフト一覧取得
function changeShift(fid, date, obj) {

    //var lunch_list_val = $('.shift_list').val();

    var url = "./ajax/ajax_shift_list.php";
    $.ajax({
        url: url,
        data:{
            "fid":fid,
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $(obj).find(".shift_list").html(data);
        }
    });
}


//進捗管理マスタ一覧取得
function changeProgress_master(date) {

    var progress_master_list_val = $('.progress_master_list').val();

    var url = "./ajax/ajax_progress_master_list.php";
    $.ajax({
        url: url,
        data:{
            "date":date
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            $(".progress_master_list").html(data).val(progress_master_list_val);
        }
    });
}


//弁当マスタ
$(function(){
    $(document).on('change', '.cal_date_year, .cal_date_month', function() {
        var year = $('.cal_date_year').val();
        var month = $('.cal_date_month').val();
        var date = year+'-'+month+'-01';

        var url = "./ajax/ajax_lunch_master_list.php";
        $.ajax({
            url: url,
            data:{
                "date":date
            },
            timeout: 3000,
            dataType: 'text',
            success: function (data) {
                $(".lunch_master_list").html(data);
            }
        });

    });
});



$(function(){
    //利用停止のシフトを削除
    $(".deleteClass_datelimit").remove();
});

/**
 * WAF対策
 * php側のデコードは、****WAFProtection関数で置換を行っています
 * 関数内の対象文字列を追加・変更する場合は、****WAFProtection関数の修正もお願いします
 * @param note
 * @returns {*}
 */
function resolveWAF(note, not_comma_check_flag = false){

    var eng_words = ['and','or','where', 'left', 'join', '(', ')', 'like'];

    eng_words.forEach(function( value ) {

        switch (value) {
            case "and":
                var result = note.match(/and/ig);
                break;
            case "or":
                var result = note.match(/or/ig);
                break;
            case "where":
                var result = note.match(/where/ig);
                break;
            case "left":
                var result = note.match(/left/ig);
                break;
            case "join":
                var result = note.match(/join/ig);
                break;
            case "(":
                var result = note.match(/\(/ig);
                break;
            case ")":
                var result = note.match(/\)/ig);
                break;
            case "like":
                var result = note.match(/like/ig);
                break;
        }

        if (result) {
            result.forEach(function( replace_value ) {
                //note = note.replaceAll(replace_value, '*-_-*'+replace_value+'*-_-*');
                note = note.replace(replace_value+' ', '*-_-*'+replace_value+'*-_-* ');
                note = note.replace(' '+replace_value, ' *-_-*'+replace_value+'*-_-*');
                note = note.replace(replace_value+'　', '*-_-*'+replace_value+'*-_-*　');
                note = note.replace('　'+replace_value, '　*-_-*'+replace_value+'*-_-*');
                
                if (not_comma_check_flag === false) {
                    note = note.replace(/"/g, "カンマ");
                    note = note.replace(/”/g, "ゼカンマ");
                    note = note.replace(/\(/g, "カッコマエ");
                    note = note.replace(/\)/g, "カッコアト");
                    note = note.replace(/（/g, "ゼカッコマエ");
                    note = note.replace(/）/g, "ゼカッコアト");
                }
            });
        }
    });

    return note;
}


//
$(document).on("click", "[name='individual_visible[9]']",(function() {
    if ($(this).prop('checked')) {
        $("[name='individual_visible[10]']").closest('label').show();
        $("[name='individual_visible[11]']").closest('label').show();
    }else{
        $("[name='individual_visible[10]']").closest('label').hide();
        $("[name='individual_visible[11]']").closest('label').hide();
    }
}));


//
$(document).on("click", "[name='individual_visible_other_table[9]']",(function() {
    if ($(this).prop('checked')) {
        $("[name='individual_visible_other_table[10]']").closest('label').show();
        $("[name='individual_visible_other_table[11]']").closest('label').show();
    }else{
        $("[name='individual_visible_other_table[10]']").closest('label').hide();
        $("[name='individual_visible_other_table[11]']").closest('label').hide();
    }
}));


/**
 * 週間予定表の曜日チェックボックスを全てチェックする処理
 */
function AllCheckWeek(checked) {

    $(".check_content").each(function (x, elem) {
        if (checked) {
            $(this).prop("checked", true);
        }else{
            $(this).prop("checked", false);
        }
    });
}

/**
 * 事業所番号を半角数字10文字以内にする処理処理
 */
$(document).on("input", ".codenum-input", (function() {
    // 半角変換
    var halfVal = $(this).val().replace(/[！-～]/g,
        function (tmpStr) {
            // 文字コードをシフト
            return String.fromCharCode(tmpStr.charCodeAt(0) - 0xFEE0);
        }
    );
    // 数字以外の不要な文字を削除
    $(this).val(halfVal.replace(/[^0-9]/g, ''));

    if ($(this).val().length > 10) {
        $(this).val($(this).val().substr(0,10));
    }
}));


//時間のプルダウンを変更した場合
$(document).on('change', '.selecttime', function() {
    var hour =$(this).val();
    var min =$(this).next().val();

    if (hour != 0) {
        if (min == 0 || !min) {
            $(this).next().val("0");
        }
    }else{
        $(this).next().val("");
    }
});



function checkDiffTime(select_date, s_hour, s_min, e_hour, e_min) {

    var check_date1 = 0;
    var check_date2 = 0;
    var diff_check_time = null;
    var select_date_ary = select_date.split('-');

    if ($.isNumeric(s_hour) && (s_hour >= 0) && $.isNumeric(s_min) && (s_min >= 0)) {
        var date1 = new Date(select_date_ary[0], select_date_ary[1], select_date_ary[2], s_hour, s_min, 0);
        check_date1 = date1.getTime();
    }

    if ($.isNumeric(e_hour) && (e_hour >= 0) && $.isNumeric(e_min) && (e_min >= 0)) {
        var date2 = new Date(select_date_ary[0], select_date_ary[1], select_date_ary[2], e_hour, e_min, 0);
        check_date2 = date2.getTime();
    }

    if ((check_date1 <= check_date2) && (check_date1 > 0) && (check_date2 > 0)) {
        var diff = check_date2 - check_date1;
        diff_check_time = Math.abs(diff) / (60 * 1000);
    }

    return diff_check_time;

}



//リンクがクリックされた回数を記録する処理
$(document).on('click', '.js_href_clicked', function() {
    
    let info = $(this).data('info');

    let url = "../ajax/ajax_link_click_counts.php";
    $.ajax({
        url: url,
        data:{
            "info":info,
        },
        timeout: 3000,
        dataType: 'text',
        success: function (data) {
            //
        }
    });
});


