//個別編集用の削除機能作成
//一括編集とDOM構成が違いすぎるので別で作成
$(document).ready(() => {

    $('.js-selected-adding-all').each(function () {

        // 加算が選択されているもののみ確認
        let val = $(this).val();
        if (val) {
            if (val == 8) {

                // 医療連携体制加算の区分を全て取得
                target_medical_number = $('.js-selected-adding-all').closest('tr').find('select[name$="[medical_adding_flg]"]');

                target_medical_number.each(function () {
                    //　選択されている医療連携体制加算の区分のname属性と値、算定状況のname属性を取得
                    let select_element = $(this);
                    let selected_name = select_element.attr('name');
                    let selected_medical_adding_number = select_element.val();
                    let selected_adding_status_name = select_element.closest('tr').find('select[name$="[medical_adding_status]"]').attr('name');

                    // 医療連携体制加算の区分のname属性と算定状況のname属性からc_idを取得
                    let adding_flg_c_id_pre = selected_name.match(/\[(\d+)\]/);
                    let adding_flg_c_id = adding_flg_c_id_pre[1];
                    let adding_status_c_id_pre = selected_adding_status_name.match(/\[(\d+)\]/);
                    let adding_status_c_id = adding_status_c_id_pre[1];

                    // 医療連携体制加算の区分のc_idと算定状況のc_idが合致していたら、区分の値によって算定状況を制御
                    if (adding_flg_c_id == adding_status_c_id) {
                        // 医療連携加算が４、５の場合のみ、 算定状況の選択を活性にする
                        if (selected_medical_adding_number == 4 || selected_medical_adding_number == 5) {
                            select_element.closest('tr').find('.medical_adding_status').prop('disabled', false).css('background', '');
                        } else {
                            select_element.closest('tr').find('.medical_adding_status').prop('disabled', true).css('background', '#EEE');
                        }
                    }
                })
            }
        }
    });

    $('.js_adding_warning').hide();

    //色付け用クラス付与
    applyColorClasses();

    // 加算実績テーブル表示時に加算実績テーブルの色分け処理実行（出席実績テーブルで出欠席更新後に加算実績テーブルの色を整える為）
    $(document).on('click', '.js-tableChange', function() {
        // 選択されたラジオボタンの値をチェック
        if ($(this).val() === '2') {
            applyColorClasses();
        }

        //実績OR加算のタグ値の取得
        let tab_value = $('input[name="tableChange"]:checked').val();
        let tab_childcare_value = '';
        if ($('input[name="tableChange_hoiku"]').length) {
            tab_childcare_value = $('input[name="tableChange_hoiku"]:checked').val();
        }

        $.ajax({
            url: './ajax/ajax_attendance.php',
            type: 'GET',
            data: { 
                tab: tab_value,
                tab_childcare: tab_childcare_value 
            },
            success: function(response) {
                //成功時には特に何もしない
            },
            error: function(xhr, status, error) {
                console.error('通信失敗', error);
            }
        });
    });

    //最初に選択されている加算はプルダウンから非表示にさせる処理を走らせる
    $(".js_adding_tr").each(function() {
        updateSelectOptions($(this), 'js-selected-adding-all', true);
    });

    //加算が選択されたら、name属性変更と関連項目の表示
    //エラーチェックも行う
    $(document).on('change', '.js-selected-adding-all', function() {

        const selectedValue = $(this).val();
        const $tr = $(this).closest('tr');
        const $td = $(this).closest('td');
        const $tbody = $(this).closest('tbody');
        const date = $("[name=date]").val();
        let c_id = 0;
        let f_id = 0;

        // 変更前の加算の値を取得
        const name_attr = $(this).attr('name'); // name属性を取得
        const match = name_attr.match(/adding\[\d+\]\[(\d+)\]\[selected_content\]/);
        const extractedValue = match ? parseInt(match[1]) : null;

        //エラーを消す
        $td.find('.err, .err.orange').remove();
        $td.find('button').removeClass('disable');

        // 加算項目プルダウン内の表示を更新
        updateSelectOptions($tr, 'js-selected-adding-all');

        //関連項目を表示する
        handleSelectedAddingChangeItem(selectedValue, $tr);

        //一括編集の場合セレクトの名前変更
        if ($('.edit_all_flg').length > 0) {
            c_id = $tbody.find('.js_cid').val();
            f_id = $tbody.find('.js_f_service').val();
            handleSelectedAddingChangeName(selectedValue, $tr, c_id);
        } else if ($('.edit_single_flg').length > 0) {
            //個別編集画面の場合
            c_id = $('[name="c_id"]').val();
            f_id = $('.js_f_service').val();
            handleSelectedAddingChangeName(selectedValue, $tr, c_id);
        } else {
            //一覧画面の場合(IDのみでいい)
            c_id = $tbody.find('.js_cid').val();
            f_id = $tbody.find('.js_f_service').val();
            //idにextra_unit_flagが含まれている場合、idを再設定する
            const extra_unit_input = $td.find('#extra_unit_flag');
            replaceExtraUnitFlagID(extra_unit_input, selectedValue, c_id);
        }

        //黄色エラーチェック
        checkYellowError($tr, f_id, c_id, selectedValue);

        //上限エラーチェック
        checkLimitError($tr, f_id, c_id, date, selectedValue);

        //併用エラーチェック
        checkConcurrentUse($tbody, extractedValue);

        //エラーの有無で保存ボタンの活性状況を操作（個別編集でのみ実行）
        if ($('.edit_all_flg').length === 0) {
            checkErrorsAndUpdateSaveButton($tr);
        }

        //CSアカウント用処理
        if ($('.headerMenu b').text().trim() === 'ネットアーツサポート用') {
            $(".js_hidden_btn").addClass("disable");
        }
    });

    //加算が選択されたら、name属性変更と関連項目の表示
    //エラーチェックも行う
    $(document).on('change', '.js-selected-adding-options', function() {

        const selected_value = $(this).val();
        const tr = $(this).closest('tr');
        const td = $(this).closest('td');
        const tbody = $(this).closest('tbody');

        //エラーを消す
        td.find('.err, .err.orange').remove();
        td.find('button').removeClass('disable');

        // 加算項目プルダウン内の表示を更新
        updateSelectOptions(tr, 'js-selected-adding-options');

        //関連項目を表示する
        handleSelectedAddingChangeItem(selected_value, tr);

        //セレクトの名前変更
        handleSelectedAddingChangeName(selected_value, tr, 0);

        //CSアカウント用処理
        if ($('.headerMenu b').text().trim() === 'ネットアーツサポート用') {
            $('.js_hidden_btn').addClass('disable');
        }

        //警告文表示・非表示の制御
        //まず非表示にする
        $('.js_adding_warning', $(tbody).closest('div')).hide();

        //13:人工内耳装用児支援加算
        //38:個別サポート加算（Ⅱ）
        //53:個別サポート加算（Ⅲ）
        //9:強度行動障害児支援加算（Ⅰ）
        //71:強度行動障害児支援加算（Ⅱ）
        //74:共生型サービス医療的ケア児支援加算
        let selected_values_check = [13, 38, 53, 9, 71, 74];
        //67:ケアニーズ対応加算
        //68:強度行動障害児支援加算
        if ($(tbody).hasClass('js_hoiku')) {
            selected_values_check = [67, 68];
        }

        let selected_values = [];
        $('.js-selected-adding-options', tbody).each(function() {
            if ($(this).val()) {
                selected_values.push($(this).val());
            }
        });

        // selected_valuesに含まれる値がselected_values_checkに含まれているかどうかをチェック
        if (selected_values.length > 0) {
            selected_values.forEach(function(value) {
                if (selected_values_check.includes(parseInt(value))) {
                    $('.js_adding_warning', $(tbody).closest('div')).show();
                }
            });
        }

        //必須の表記を削除する
        $(this).closest('.reserveOption').find('.hissu').remove();
        
    });

    // 一括編集の操作オプションの反映ボタン押下時の処理（加算項目）
    $(document).on('click', '.allSetBtn_adding', (event) => {
        event.preventDefault(); // デフォルトのアンカー動作を防止

        // 加算の時間、年月日のエラーチェックを実行
        const selected_adding_options = $('.js-selected-adding-options');
        const adding_item_all = selected_adding_options.length;
        let selected_contents_numbers = []; //一括反映する加算
        let childcare_selected_contents_numbers = []; //一括反映する加算

        let contents_count = 0;
        if (adding_item_all) {
            selected_adding_options.each(function(i, elem) {
                const selected_contents = $(elem).val(); // 加算の値

                if (selected_contents) {
                    if ($(this).closest('tbody').hasClass('js_hoiku')) {
                        childcare_selected_contents_numbers.push(selected_contents);
                    } else {
                        selected_contents_numbers.push(selected_contents);
                    }

                    contents_count++;
                }
            });
        }

        // 一括反映する項目が1件もなければ、処理を行わない
        if (contents_count === 0) {
            return false;
        }

        if (window.confirm('現在、記録されている情報がある場合、追加して加算が入力されますが、よろしいですか？')) {
            // 操作オプション内の全てのテーブルを取得
            let option_tables = $('.adding_options_tbody');
            
            // 加算実績テーブルの全てのテーブルを取得
            let adding_tables = $('.js_adding_table');

            // 最初の操作オプションテーブルを最初の加算実績テーブルに反映（放デイ用）
            if (selected_contents_numbers.length > 0) {
                reflectionAddingTable(option_tables.first(), adding_tables.first());
            }

            // 最後の操作オプションテーブルを最後の加算実績テーブルに反映（保育所用）
            if (childcare_selected_contents_numbers.length > 0) {
                reflectionAddingTable(option_tables.last(), adding_tables.last());
            }
        }
    });


    /**
     * 一括編集画面で指定された操作オプションの入力内容を、
     * 加算実績テーブルに反映する処理を行います。
     *
     * @param array $option_table 入力された操作オプションの内容（編集元データ）
     * @param array $adding_table 加算実績として反映する対象のテーブル（編集先データ）
     *
     * @return void
     */
    function reflectionAddingTable($option_table, $adding_table) {
        const cid_arr = []; // 反映先の児童のid格納
        const fid_arr = []; // 反映先の施設id格納
        const mix_info_arr = []; // 反映先の施設id格納
        const date = $("input[name='date']").val(); // 表示年月日格納

        // 操作オプションのselect要素の現在の選択値を取得
        let selected_values = {};
        let options_medical_adding_val = 0;
        $option_table.find('select:visible').each(function() {
            selected_values[this.name] = $(this).val();

            if (this.name.match(/\[medical_adding_flg\]/)) {
                options_medical_adding_val = $(this).val();
            }
        });

        //操作オプションのinput要素の値
        let input_values = {};
        $option_table.find('input:visible').each(function() {
            input_values[this.name] = $(this).val();
        });

        // 操作オプションのDatePickerの値を取得
        let datePicker_values = {};
        $option_table.find('.newDatePickerJs').each(function() {
            datePicker_values[this.name] = $(this).val();
        });

        //500単位の値を取得
        let extra_unit_flags = {};
        $option_table.find('[id^="extra_unit_flag"]').each(function() {
            if ($(this).prop('checked')) {
                extra_unit_flags[$(this).val()] = 1;
            } else {
                extra_unit_flags[$(this).val()] = 0;
            }
        });

        // 加算実績テーブルの処理
        $adding_table.find('.all_adding_hanei_flg:checked').each(function() {

            // 加算は編集権限のあるものだけにする
            if ($(this).closest('tbody').hasClass('js_no_edit_adding')) {
                return true;
            }

            //請求情報確定後の情報を編集できないようになっている対象を飛ばす
            if ($(this).closest('tbody').find('.js-selected-adding-all').hasClass('authority_disable')) {
                return true;
            }

            let existing_flg = 0; // 加算選択済みフラグ
            // 操作オプションのtable要素をクローン
            let $cloned_table = $option_table.clone();

            // 挿入先のtbodyを取得
            let $tbody = $(this).closest('tbody');
            let $tr = $(this).closest('tr');

            // 人工内耳装用時支援加算の区分判定用で児童の利用サービスと施設の種別を取得
            const use_service = parseInt($tbody.find('[name="use_services"]').val());
            const center_flg = parseInt($tbody.find('.js_f_service').data('f_center'));

            //医療的ケア児
            let medical_care_flg = 0;
            if ($tbody.find('.iryoucare').length > 0) {
                medical_care_flg = 1;
            }

            // 挿入先の加算項目に未選択のものがあるか確認し、存在する場合は最初の行以外削除
            $tbody.find('.js-selected-adding-all').each(function() {

                let $select = $(this);

                // $selectの親trを取得
                let $parent_tr = $select.closest('tr');

                // 未選択の場合、行を削除する
                if (!$select.val()) {
                    $parent_tr.find('.js_delete').click();
                }
            });

            // 挿入先の最初の加算項目プルダウンから全てのオプションの値を取得
            let first_select_vals = $tbody.find('.js-selected-adding-all').last().find('option').map(function() {
                return $(this).val(); // オプションの値を取得
            }).get(); // jQueryのgetメソッドで配列に変換

            // 挿入先の加算項目に選択されている加算を取得
            let existing_sele_vals = $tbody.find('.js-selected-adding-all').map(function() {
                let value = $(this).val(); // 選択値を取得
                // 空文字（未選択）でない値だけを返す
                if (value !== '') {
                    return value;
                }
            }).get().filter(function(val) {
                // filterを使用してundefinedを除外（map内でreturnされなかった場合はundefinedになる）
                return val !== undefined;
            });
            // 加算選択済みフラグを格納
            existing_flg = (existing_sele_vals.length > 0) ? 1 : 0;

            // 挿入する操作オプションに、挿入先の加算プルダウン内の値が含まれていないか、選択加算が含まれているかチェック
            // クローンした物だとなぜか値が取得できない為、nameから加算の値を取得
            $cloned_table.find('.js-selected-adding-options').each(function(index) {
                let $select = $(this);
                // name属性から加算のIDを取得する正規表現マッチング
                const name_match = $select.attr('name').match(/\[(\d+)\]\[(\d+)\]/);

                if (name_match && name_match.length > 1) {
                    const adding_id = name_match[2]; // 加算のIDを取得
                    // first_select_valsに含まれていない、またはexisting_sele_valsに含まれている加算IDの場合に削除
                    if (!first_select_vals.includes(adding_id) || (existing_sele_vals.includes(adding_id))) {
                        // 条件に一致する場合、親trを削除
                        $select.closest('tr').remove();
                    }
                }
            });

            // $cloned_table内の各加算プルダウン('.js-selected-adding-options')に対して処理を実行
            $cloned_table.find('.js-selected-adding-options').each(function() {
                const $select = $(this); // 現在のselect要素を取得
                $select.find('option').each(function() {
                    const option_value = $(this).val(); // 現在のoptionの値を取得
                    // first_select_valsに含まれていない場合、そのoptionを削除
                    if (!first_select_vals.includes(option_value)) {
                        $(this).remove();
                    }
                    if (existing_sele_vals.includes(option_value)) {
                        // 重複している場合、そのselect要素のセレクターまたは一意の識別子を配列に追加
                        $(this).remove();
                    }
                });
            });

            // 挿入する操作オプションの加算項目数を取得
            const option_tr_count = $cloned_table.find('tr').length;
            // 挿入先の最初のtrを取得
            const $first_tr = $tbody.find('tr:first');

            // ajaxでのエラーチェックの準備
            const r_id = $first_tr.data('rid');
            const c_id = $tbody.find('input[name="c_id"]').val();
            const f_id = $tbody.find('.f_id').val();
            // 児童id追加
            cid_arr.push(c_id);
            //
            mix_info_arr.push(c_id+'_'+r_id+'_'+f_id);
            // fidが配列にまだ存在しない場合のみfidを追加
            if (!fid_arr.includes(f_id)) {
                fid_arr.push(f_id);
            }
            // ajaxでのエラーチェックの準備ここまで

            if ($cloned_table.find('.js-selected-adding-options').length > 0) {
                // 挿入先の加算項目内に加算が選択済みの場合
                if (existing_flg) {
                    $cloned_table.find('tr').each(function () {
                        // 現在の行が人工内耳装用児支援加算（ID:13）の場合のみチェック
                        if ($(this).find('[name*="[cochlea_implant_adding_flg]"]')) {
                            // 利用サービスが放デイ または 施設がセンターでない
                                if (use_service === 1 || center_flg === 0) {
                                    //センターでないまたは放デイのときは区分が1のものは表示しない
                                    $(this).find('[name*="cochlea_implant_adding_flg"]').find('option[value="1"]').remove();
                                    //2を選択しておく
                                    $(this).find('[name*="cochlea_implant_adding_flg"]').val(2);
                                }
                        }

                        //1、2、3、4、5は医療連携体制加算の区分
                        //医療的ケア児ではない児童に４、５の区分が反映されないように
                        //医療的ケア児に１、２、３の区分が反映されないように
                        if ($(this).find('[name*="medical_adding_flg"]')) {
                            if (['4', '5'].includes(options_medical_adding_val) && medical_care_flg != 1) {
                                return true;
                            }

                            if (['1', '2', '3'].includes(options_medical_adding_val) && medical_care_flg == 1) {
                                return true;
                            }
                        }

                        let $clone_tr = $(this).clone(); // trをクローン
                        $clone_tr.find('.js_adding_button').removeClass('td-l'); //真ん中寄せにする
                        $tbody.append($clone_tr); // $tbodyの最後にクローンしたtrを追加*/
                    });
                } else {
                    // 加算未選択の場合
                    let first_insert_flg = 1;

                    if ($cloned_table.find('tr:first').find('[name*="medical_adding_flg"]')) {
                        if (['4', '5'].includes(options_medical_adding_val) && medical_care_flg != 1) {
                            first_insert_flg = 0;
                        }

                        if (['1', '2', '3'].includes(options_medical_adding_val) && medical_care_flg == 1) {
                            first_insert_flg = 0;
                        }
                    }

                    if (first_insert_flg === 1) {
                        // 最初のtr内の特定クラスが付いていないtdを削除
                        $first_tr.find('.js_clone_obj').remove();

                        // 操作オプションのtableから最初のtrのtdを挿入
                        $first_tr.find('.js_reset_clone_obj').before($cloned_table.find('tr:first').html());
                    }
                    
                    // 操作オプションの2つ目以降のtrがある場合、それらを挿入
                    if (option_tr_count > 1) {
                        $cloned_table.find('tr').not(':first').each(function() {

                            if ($(this).find('[name*="medical_adding_flg"]')) {
                                if (['4', '5'].includes(options_medical_adding_val) && medical_care_flg != 1) {
                                    return true;
                                }

                                if (['1', '2', '3'].includes(options_medical_adding_val) && medical_care_flg == 1) {
                                    return true;
                                }
                            }
                            
                            let $clone_tr = $(this).clone(); // trをクローン
                            $clone_tr.find('.js_adding_button').removeClass('td-l'); //真ん中寄せにする
                            $first_tr.after($clone_tr); // $first_trの直後にクローンしたtrを追加
                        });
                    }
                }

                // HTML挿入後の$tbody内のtrの数を取得
                let updated_tbody_tr_count = $tbody.find('tr').length;
                // 更新されたtrの数に基づいてrowspanを設定
                $first_tr.find('th, td').not('.js_adding_td').attr('rowspan', updated_tbody_tr_count);

                // クローンした操作オプションの選択値を設定（挿入後に行う）
                $first_tr.nextAll().addBack().find('select, input').each(function() {


                    if (selected_values[this.name]) {
                        $(this).val(selected_values[this.name]);
                    }

                    if (input_values[this.name]) {
                        $(this).val(input_values[this.name]);
                    }

                    // select要素のname属性を更新
                    let name_attr = $(this).attr('name');
                    if (name_attr && name_attr.startsWith('adding[')) {
                        name_attr = name_attr.replace(/adding\[\d+\]/, `adding[${c_id}]`);
                        $(this).attr('name', name_attr);
                    }

                    // .js-selected-adding_options クラスを .js-selected-adding-all に変更（連動加算用）
                    if ($(this).hasClass('js-selected-adding-options')) {
                        $(this).removeClass('js-selected-adding-options').addClass('js-selected-adding-all');
                    }

                    // 現在の要素が人工内耳装用児支援加算のselect要素であるかをチェック
                    if (name_attr.match(/\[cochlea_implant_adding_flg\]/)) {
                        // 利用サービスが放デイ または 施設がセンターでない
                        if (use_service === 1 || center_flg === 0) {
                            // センターでないまたは放デイのときは区分が1のものは表示しない
                            $(this).find('option[value="1"]').remove();
                            // 2を選択しておく
                            $(this).val(2);
                        }
                    }

                    //500単位の加算を算定するチェックボックスの制御
                    //初回加算のエラーチェック 12
                    //専門的支援実施加算の記載を表示する処理 55
                    if (this.name.match(/extra_unit_flag/) || this.name.match(/\]\[55\]\[/) || this.name.match(/\]\[12\]\[/)) {
                        $('.js-selected-adding-all', $(this).closest('tr')).change();

                        //500単位の加算を算定する・しないの反映
                        if (this.name.match(/extra_unit_flag/)) {
                            if (extra_unit_flags[$(this).val()] != 1) {
                                $(`#extra_unit_flag${$(this).val()}_${c_id}`).prop('checked', false);
                            } else {
                                $(`#extra_unit_flag${$(this).val()}_${c_id}`).prop('checked', true);
                            }
                        }
                    }
                });

                // クローンしたDatePickerの選択値を設定（挿入後に行う）
                $first_tr.nextAll().addBack().find('.newDatePickerJs').each(function() {
                    const date_picker_id = $(this).attr('id');
                    if (date_picker_id) {
                        // IDが重複するとdatepickerのカレンダーが開かなくなるため、IDを再生成
                        // 新しいIDを生成（例: 元のIDにc_idを付与）
                        const new_date_picker_id = date_picker_id + '_' + c_id;
                        $(this).attr('id', new_date_picker_id);

                        // 以前にDatePickerが初期化されていた場合、その初期化を解除
                        if ($(this).hasClass('hasDatepicker')) {
                            $(this).removeClass('hasDatepicker');
                            $(this).removeAttr('id');
                        }

                        // DatePickerを新しいIDで初期化
                        $(this).datepicker({ dateFormat: 'yy/mm/dd' });

                        // name属性も更新（前のコードと同様）
                        let date_picker_name = $(this).attr('name');
                        if (date_picker_name && date_picker_name.startsWith('adding[')) {
                            date_picker_name = date_picker_name.replace('adding[]', `adding[${c_id}]`);
                            $(this).attr('name', date_picker_name);

                            const original_name = date_picker_name.replace(`adding[${c_id}]`, 'adding[]');
                            if (datePicker_values[original_name]) {
                                $(this).val(datePicker_values[original_name]);
                            }
                        }
                    }
                });
            }

            //全児童で１〜６を算定できるように独自処理が入っていない場合
            if ($('.medical_care_except_flg').val() != 1) {
                //1、2、3、4、5は医療連携体制加算の区分
                //医療的ケア児の区分選択肢に１、２、３を削除
                //医療的ケア児ではない児童の区分選択肢に４、５を削除
                if (medical_care_flg == 1) {
                    $('[name*="medical_adding_flg"]', $tbody).find('option').filter(function() {
                        return ['1', '2', '3'].includes($(this).val());
                    }).remove();

                    $tbody.find('.js_hidden_content:visible').find('.medical_adding_status').removeClass('disable');
                } else {
                    $('[name*="medical_adding_flg"]', $tbody).find('option').filter(function() {
                        return ['4', '5'].includes($(this).val());
                    }).remove();
                }
            }

            //通所自立支援加算の場合は、９０日超えのエラーをチェック
            if ($('.js-selected-adding-all', $tr).val() == 57) {
                checkLimitError($tr, f_id, c_id, date, 57);
            }

        });

        //色付け用クラス付与
        applyColorClasses();
    }

    //画面読み込み時に黄色エラーチェック
    $('.js-selected-adding-all').each(function() {
        const $tr = $(this).closest('tr');
        const $tbody = $(this).closest('tbody');
        const date = $("[name=date]").val();
        const selectedValue = $tr.find('.js-selected-adding-all').val();
        let c_id = 0;
        let f_id = 0;

        if ($('.edit_single_flg').length > 0) {
            //個別編集画面の場合
            c_id = $('[name="c_id"]').val();
            f_id = $('.js_f_service').val();
        } else {
            //一覧画面の場合(IDのみでいい)
            c_id = $tbody.find('.js_cid').val();
            f_id = $tbody.find('.js_f_service').val();
        }

        //黄色エラーチェック
        checkYellowError($tr, f_id, c_id, selectedValue);
    });

    //区分が変更された場合
    $(document).on('change', '.js_classification', function() {
        const $tr = $(this).closest('tr');
        const $tbody = $(this).closest('tbody');
        const date = $("[name=date]").val();
        const selectedValue = $tr.find('.js-selected-adding-all').val();
        let c_id = 0;
        let f_id = 0;

        if ($('.edit_single_flg').length > 0) {
            //個別編集画面の場合
            c_id = $('[name="c_id"]').val();
            f_id = $('.js_f_service').val();
        } else {
            //一覧画面の場合(IDのみでいい)
            c_id = $tbody.find('.js_cid').val();
            f_id = $tbody.find('.js_f_service').val();
        }

        //黄色エラーチェック
        checkYellowError($tr, f_id, c_id, selectedValue);

        //上限エラーチェック
        checkLimitError($tr, f_id, c_id, date, selectedValue);

        //個別サポート加算１の場合
        if (selectedValue == 37) {
            //エラーを削除する
            $tr.find('.js_support_one_err').remove();

            //併用エラーチェック
            checkSupport1_2AndStrongBehavior($tbody);
        }

        // 医療体制加算の場合
        if (selectedValue == 8) {

            let selected_medical_adding_number = $tr.find('.js_classification').val();

            // 医療連携加算が４、５の場合のみ、 算定状況の選択を活性にする
            if (selected_medical_adding_number == 4 || selected_medical_adding_number == 5) {
                $tr.find('.medical_adding_status').prop('disabled', false).css('background', '');
            } else {
                $tr.find('.medical_adding_status').prop('disabled', true).css('background', '#EEE');
            }
        }
    });

    // 加算登録ボタン押下時の処理（一覧用）
    $(document).on('click', '.js_hidden_btn', function() {

        // ボタンが属する最も近いtd要素を取得
        const $parentTd = $(this).closest('td');
        let adding = {}; // 加算情報格納用オブジェクト

        const $tbody = $(this).closest('tbody');
        // tbody内でname属性がc_idの要素の値を取得
        let c_id = $tbody.find('[name="c_id"]').val();
        // tbody内でname属性がf_idの要素の値を取得
        let f_id = $tbody.find('[name="f_id"]').val();
        let hoiku_flg = $tbody.find('[name="hoiku_flg"]').val();
        let date = $("[name=date]").val();

        //加算データを取得してaddingに入れる
        $parentTd.find('select, input').each(function() {
            const name = $(this).attr('name');
            const value = $(this).val();
            adding[name] = value;
        });

        // 追加単位のチェックボックスの状態を取得
        const addingValue = adding['selected_content'];
        if (adding['extra_unit_flag']) {
            const extraUnitFlagInputTag = `#extra_unit_flag${addingValue}_${c_id}`;
            adding['extra_unit_flag'] = checkedExtraUnitFlag(extraUnitFlagInputTag, addingValue);
        }

        // 通所自立支援加算の場合
        if (adding['day_school_independence_support_flg']) {
            const over_ninety_key = `adding[${c_id}][57][over_ninety]`;
            const get_flg_key = `adding[${c_id}][57][get_over_ninety_flg]`;
            
            // 構造をajax用に書き換える
            if (adding[over_ninety_key]) {
                adding['over_ninety'] = adding[over_ninety_key];
                adding['get_over_ninety_flg'] = adding[get_flg_key] || '';

                delete adding[over_ninety_key];
                delete adding[get_flg_key];
            }
        }

        // 医療連携体制加算の場合区分が４、５以外の場合、算定状況は不要
        if (adding['medical_adding_flg'] != 4 && adding['medical_adding_flg'] != 5 ) {
            delete(adding['medical_adding_status']);
        }

        // 全ての取得情報をオブジェクトへ格納
        let data = {adding, c_id, f_id, hoiku_flg, date};

        // ログ出力のためにmode=registを設定
        data["mode"] = "regist";

        //エラーチェック
        let contents_err = checkAddingContentsError($parentTd);

        //エラーがあれば表示
        if (contents_err) {
            $parentTd.prepend('<p class="err">'+contents_err+'</p>');
        } else {
            // サーバーにデータを送信
            sendDataToServer(data, $parentTd);
        }
    });


    // 加算項目追加処理
    //一覧と一括共通
    $(document).on('click', '.js_add', function() {

        // 現在の行を取得
        const currentTbody = $(this).closest('tbody');
        const currentTr = $(this).closest('tr');

        //追加ボタンを非表示にする
        currentTbody.find('.js_add').hide();

        //クローン処理は一覧と一括違うので、それぞれ処理する
        //一覧の場合
        if ($('.edit_detail_flg').length) {
            currentTbody.append(currentTbody.find('.js_clone_base').clone());
            currentTbody.find('tr:last').show().removeClass('js_clone_base');
        }else{
            currentTbody.append(currentTr.clone());
            const currentTrLast = currentTbody.find('tr:last');
            currentTrLast.find('th, td').not('.js_clone_obj').remove();

            // 編集権限を取得
            const tbodyClass = currentTbody.attr('class');
            const no_edit_adding_flg = tbodyClass === 'js_no_edit_adding' ? true : false;
            if (!no_edit_adding_flg) {
                // 編集権限がある場合のみ表示
                currentTrLast.find('.js_add').show();
            }
            currentTrLast.find('[class*="js-selected-adding"]').val('').change();
        }

        //最初の行のrowspanの再設定
        var rowCount = currentTbody.find('tr').length;

        //一覧の場合、clone用のtrを除く
        if ($('.edit_detail_flg').length) {
            rowCount--;
        }
        currentTbody.find('tr:first').find('th, td').not('.js_adding_td').attr('rowspan', rowCount);

    });

    //一括編集　加算削除
    $(document).on('click', '.js_delete', function() {

        // 現在の行を取得
        const currentTbody = $(this).closest('tbody');
        const currentTr = $(this).closest('tr');
        // 削除する加算の値を取得
        const selectedValue = parseInt(currentTr.find('.js-selected-adding-all').val());

        //trのlength取得
        let rowCount = currentTbody.find('tr').length;

        //エラーの削除
        currentTr.find('.err, .orang').remove();

        if (rowCount == 1) {
            currentTr.find('.js-selected-adding-all').val('').change();

            //操作オプションの加算をリセットする
            if (currentTr.find('.js-selected-adding-options')) {
                currentTr.find('.js-selected-adding-options').val('').change();
            }
        }else{

            //該当trのcurrentTbody内のインデックス取得
            const index = currentTbody.find('tr').index(currentTr);

            //最初TRの場合
            if (index == 0) {
                //すべて解除～出欠席
                const part1 = currentTr.find('th, td').not('.js_adding_td, .js_reset_clone_obj').clone();
                //リセットボタン
                const part2 = currentTr.find('.js_reset_clone_obj').clone();

                currentTr.remove();
                currentTbody.find('tr:first').prepend(part1);
                currentTbody.find('tr:first').append(part2);
            }else{
                currentTr.remove();
            }

            //最終行の追加ボタンを表示する
            const currentTrLast = currentTbody.find('tr:last');
            currentTrLast.find('.js_add').show();

            // 加算の併用エラーチェック
            checkConcurrentUse(currentTbody, selectedValue);

            //最初の行のrowspanの再設定
            rowCount--;
            currentTbody.find('tr:first').find('th, td').not('.js_adding_td').attr('rowspan', rowCount);
        }

        // 加算項目プルダウン内の表示を更新
        //削除した加算を選択できるようにアップデートする
        currentTbody.find('.js_adding_tr').each(function() {
            updateSelectOptions($(this), 'js-selected-adding-all');
        });

        //個別サポート加算１の２と強度行動障害児加算の併用チェック
        currentTbody.find('.js_support_one_err').remove();
        checkSupport1_2AndStrongBehavior(currentTbody);

        // エラーの有無で保存ボタンの活性状況を操作
        checkErrorsAndUpdateSaveButton(currentTbody.find('.js_adding_tr').first());

    });


    // 加算項目追加処理
    // 個別編集
    $(document).on('click', '.js_add_single', function() {

        const currentTbody = $(this).closest('tbody');

        // 現在の行を取得
        const currentTr = $(this).closest('tr');

        //クローン処理
        currentTr.after(currentTr.clone());

        //追加ボタンを非表示にする
        currentTr.find('.js_add_single').hide();

        //選択済みの加算をリセットする
        const currentTrLast = currentTbody.find('.js_adding_tr:last');
        currentTrLast.find('th').remove();
        currentTrLast.find('.js-selected-adding-all').val('').change();

        //エラーを削除
        currentTrLast.find('.err').remove();

        //最初の行のrowspanの再設定
        var rowCount = currentTbody.find('.js_adding_tr').length;
        currentTbody.find('.js_adding_tr:first').find('th').attr('rowspan', rowCount);

    });

    //個別編集　加算削除
    $(document).on('click', '.js_delete_single', function() {

        // 現在の行を取得
        const currentTbody = $(this).closest('tbody');
        const currentTr = $(this).closest('tr');
        // 削除する加算の値を取得
        const selectedValue = parseInt(currentTr.find('.js-selected-adding-all').val());

        //trのlength取得
        let rowCount = currentTbody.find('.js_adding_tr').length;

        //エラーの削除
        currentTr.find('.err, .orang').remove();

        if (rowCount == 1) {
            currentTr.find('.js-selected-adding-all').val('').change();
        }else{

            //該当trのcurrentTbody内のインデックス取得
            const index = currentTbody.find('.js_adding_tr').index(currentTr);

            //最初TRの場合
            if (index == 0) {
                //加算項目名
                const part = currentTr.find('th').clone();

                currentTr.remove();
                currentTbody.find('.js_adding_tr:first').prepend(part);
            }else{
                currentTr.remove();
            }

            //最終行の追加ボタンを表示する
            const currentTrLast = currentTbody.find('.js_adding_tr:last');
            currentTrLast.find('.js_add_single').show();

            // 加算の併用エラーチェック
            checkConcurrentUse(currentTbody, selectedValue);

            //最初の行のrowspanの再設定
            rowCount--;
            currentTbody.find('.js_adding_tr:first').find('th').attr('rowspan', rowCount);
        }

        //削除した加算を選択できるようにアップデートする
        currentTbody.find('.js_adding_tr').each(function() {
            updateSelectOptions($(this), 'js-selected-adding-all');
        });

        //個別サポート加算１の２と強度行動障害児加算の併用チェック
        currentTbody.find('.js_support_one_err').remove();
        checkSupport1_2AndStrongBehavior(currentTbody);

        // エラーの有無で保存ボタンの活性状況を操作
        checkErrorsAndUpdateSaveButton(currentTbody.find('.js_adding_tr').first());
    });

    //一括リセット用（加算項目）
    $(document).on('click', '.allResetBtn_adding', function () {
        if (window.confirm('現在、記録されている情報がある場合、すべてリセットされますがよろしいですか？')) {

            $('.js_adding_table').find('tbody').each(function () {
                if ($(this).find(".all_adding_hanei_flg").prop("checked") && !$(this).hasClass('js_no_edit_adding')) {

                    //エラーの削除
                    $(this).find('tr').find('.err, .orang').remove();

                    // 最初の行以外のすべての行を削除
                    $(this).find('tr').not(':first').remove();

                    //最初の選択肢をリセットする
                    $(this).find('.js-selected-adding-all').val('').change();
                }
            });
        }
    });

    //一括編集の保存処理
    $(document).on('click', '.js_save_btn_all', function() {

        //エラーフラグ
        let err_flg = 0;

        if (!err_flg) {
            postProcess(); // エラーがなければ attendance.js のpost用JS実行
        }
    });

    // 個別編集画面
    // 保存ボタンが押されたら時間と日付のエラーチェックを実行
    $(document).on('click', '.js_save_btn', function() {

        let err_flg = 0;

        if (!err_flg) {
            $('#form').submit();
        }
    });


    //個別編集画面
    //加算連動機能
    $(document).on('change', 'input[name="attend"], input[name="providing_type"], select[name="s_hour"]', function() {

        //選択されている値を取得
        const changedName = $(this).attr('name');
        const changedValue = $(this).val();
        const providing_type = $('[name="providing_type"]:checked').val();
        const s_hour = $('[name="s_hour"]').val();
        let attend_flg = false;

        //加算連動実行するかどうかのフラグの初期化
        let exec_flg = 0;

        // 変更した内容に応じてチェックする要素を変更して、実行フラグを格納
        if (changedName === "attend" && changedValue == 1) { // 出欠席の場合
            if (s_hour && (!providing_type || providing_type == 1 || providing_type == 2)) {
                exec_flg = 1;
            }
        } else if (changedName === "providing_type" && (changedValue == 1 || changedValue == 2)) { // 提供形態の場合
            exec_flg = 1;

        } else if (changedName === "s_hour" && changedValue) { // 入室時間の場合
            if (s_hour && (!providing_type || providing_type == 1 || providing_type == 2)) {
                exec_flg = 1;
            }
        }

        //連動する加算の追加
        if (exec_flg === 1) {
            setInterlockingAdding('');
        //連動する加算の削除
        }else{
            clearInterlockingAdding('');
        }

    });


    //保育所
    //個別編集画面
    //加算連動機能
    $(document).on('change', 'select[name="hoiku_start_hour"], select[name="hoiku_start_time"], input[name="hoiku_attend_flg"]', function() {

        //選択されている値を取得
        const s_hour = $('[name="hoiku_start_hour"]').val();
        const s_min = $('[name="hoiku_start_time"]').val();

        //キャンセルのチェックボックスの状態を取得
        const checkedFlg = $('input[name="hoiku_attend_flg"]').prop('checked');

        //加算連動実行するかどうかのフラグの初期化
        let exec_flg = 0;

        //キャンセルにチェックが入っておらず、且つ入実時間が入力されている場合
        if ((checkedFlg === false) && s_hour ) {
            exec_flg = 1;
        }

        //連動する加算の追加
        if (exec_flg === 1) {
            setInterlockingAdding('');
        //連動する加算の削除
        }else{
            clearInterlockingAdding('');
        }
    });

    // すべてチェック(解除)リンクを押下時に、加算実績テーブル内のチェックボックスの状態を操作する処理
    $(document).on('click', '.checkAll_adding_hanei', function(event) {
        event.preventDefault(); // デフォルトのアンカー動作を防止

        // テキストを切り替え
        if ($(this).html().includes('解除')) {
            $(this).html('すべて<br>チェック');
        } else {
            $(this).html('すべて<br>解除');
        }

        // 同じテーブル内のチェックボックスの状態を切り替え
        let $table = $(this).closest('table');
        let isChecked = $(this).html().includes('解除');
        $table.find('.all_adding_hanei_flg').each(function() {
            $(this).prop('checked', isChecked);
        });
    });


    // 一括編集画面のリセットボタン押下時の処理
    $(document).on('click', '.js_reset_clone_obj', function() {
        if ($(this).find('.authority_disable').length > 0) {
            return; // 編集権限がない場合は処理を中断
        } else {
            // リセットボタンがある行を取得
            const $row = $(this).closest('tr.js_adding_tr');

            // 確認ダイアログを表示
            if (confirm('登録情報をリセットしてよろしいですか？')) {
                // 最初の行のすべての select 要素をリセット
                $row.find('select').val('');

                // 現在の行の親の tbody を取得
                const $tbody = $row.closest('tbody');

                // tbody内の .err クラス要素を削除
                $tbody.find('.err').remove();

                // 最初の行以外のすべての行を削除
                $tbody.find('tr.js_adding_tr').not(':first').remove();

                $tbody.find('option:first').trigger('change');

                //追加ボタンを表示する
                $tbody.find('.js_add').show();
            }
        }
    });

    /*加算の表示切り替え処理まとめ*/
    //家族支援加算表示切り替え処理
    $(document).on('change','[name*="family_support_flg"]',function(){
        const classification = $(this).val();
        const family_support_place = $(this).closest('td').find('[name*="family_support_place"]');
        if (classification == 2) {
            //区分が2のときはoptionの値が1のものを非表示にする
            family_support_place.find('option[value="1"]').prop('disabled', true).hide();
            //2を選択しておく
            family_support_place.val(2);
        } else {
            //区分が1のときは居宅訪問を表示する
            family_support_place.find('option[value="1"]').prop('disabled', false).show();
        }
    });

    $(document).on('change','.js-selected-adding-all',function(){
        const selected_contents = parseInt($(this).val());
        //人工内耳装用児支援加算表示切り替え処理
        if (selected_contents === 13) {
            const cochlea_implant_adding_pulldown = $(this).closest('tr').find('[name*="cochlea_implant_adding_flg"]');
            //利用サービスを取得（編集画面は直でnameを指定する）
            let use_service = $(this).closest('tbody').find('[name="use_services"]').val();
            use_service = use_service ? parseInt(use_service) : parseInt($('[name="use_services"]').val());
            //施設のセンターかどうかのフラグを取得
            let center_flg = $(this).closest('tbody').find('.js_f_service').data('f_center');
            center_flg = center_flg ? parseInt(center_flg) : parseInt($('.js_f_service').data('f_center'));

            if (use_service === 1 || center_flg === 0) {
                //センターでないまたは放デイのときは区分が1のものを非表示にする
                cochlea_implant_adding_pulldown.find('option[value="1"]').prop('disabled', true).hide();
                //2を選択しておく
                cochlea_implant_adding_pulldown.val(2);
            } else {
                //センターの場合は区分1と2を表示する
                cochlea_implant_adding_pulldown.find('option[value="1"]').prop('disabled', false).show();
                cochlea_implant_adding_pulldown.find('option[value="2"]').prop('disabled', false).show();
            }
        }

        //個別サポート加算(Ⅰ)区分表示切り替え処理
        if (selected_contents === 37) {
            const individual_support_one_pulldown = $(this).closest('tr').find('[name*="individual_support_one_flg"]');
            //利用サービスを取得（編集画面は直でnameを指定する）
            let use_service = $(this).closest('tbody').find('[name="use_services"]').val();
            use_service = use_service ? parseInt(use_service) : parseInt($('[name="use_services"]').val());
            //個別サポート加算のフラグを取得
            let support_one_flg = 0;
            if ($('.edit_all_flg').length || $('.edit_detail_flg').length) {
                support_one_flg = parseInt($(this).closest('tbody').find('.js_individual_support_one_flg').val());
            } else {
                support_one_flg = parseInt($('.js_individual_support_one_flg').val());
            }

            if (use_service === 2) {
                //児発のときは区分が2と重度のものを非表示にする
                individual_support_one_pulldown.find('option[value="2"], option[value="3"]').prop('disabled', true).hide();
                //2を選択しておく
                individual_support_one_pulldown.val(1);
            } else {
                //放デイ
                //児童が個別サポート加算(Ⅰ)重度を登録している場合
                if (support_one_flg === 3) {
                    //重度のときは区分が1と2のものを非表示にする
                    individual_support_one_pulldown.find('option[value="1"], option[value="2"]').prop('disabled', true).hide();
                    //重度を表示させる
                    individual_support_one_pulldown.find('option[value="3"]').prop('disabled', false).show();
                    //3を選択しておく
                    individual_support_one_pulldown.val(3);
                } else {
                    //区分1と2を表示する
                    individual_support_one_pulldown.find('option[value="1"], option[value="2"]').prop('disabled', false).show();
                    //重度を非表示にさせる
                    individual_support_one_pulldown.find('option[value="3"]').prop('disabled', true).hide();
                }
            }
        }

        //強度行動障害児加算表示切り替え処理
        const $tbody = $(this).closest('tbody');
        $tbody.find('.js_support_one_err').remove();

        //個別サポート加算１の２と強度行動障害児加算の併用チェック
        checkSupport1_2AndStrongBehavior($tbody);

    });
    /*加算の表示切り替え処理まとめ終わり*/
});


//連動加算追加
function setInterlockingAdding(r_id, all_hoiku_flg = null){
    const conditions = [
        { flag: '.js_support_required_flg', value: '37' },
        { flag: '.js_need_protection_flg', value: '38' },
        { flag: '.js_strength_action_flg', value: '9' },
        { flag: '.js_strength_action_two_flg', value: '71' },
        { flag: '.js_special_support_add', value: '7' },
        /*{ flag: '.js_extension', value: '3' },*/
        { flag: '.js_hoiku_special_visitor', value: '64' },
        { flag: '.js_hoiku_care_needs_flg', value: '67' },
        { flag: '.js_school_refusal_support_flg', value: '53' }
    ];

    // 個別編集の場合
    let tbody_obj = $('form');
    let add_btn_class = '.js_add_single';

    // 一括編集画面の場合
    if (r_id) {
        tbody_obj = $('.ibox-inner').find('#js_related_class' + r_id);
        add_btn_class = '.js_add';
    }

    // 児発・放デイと保育所どちらも予約がある場合、選択したサービスのみを連動
    if (r_id && tbody_obj.length === 2) {
        if (all_hoiku_flg === 1) {
            tbody_obj = tbody_obj.eq(1); // 2つ目のtbody_objを対象とする
        } else if (all_hoiku_flg === null) {
            tbody_obj = tbody_obj.eq(0); // 1つ目のtbody_objを対象とする
        }
    }

    conditions.forEach(condition => {
        //加算連動フラグがあれば
        if ($(condition.flag, tbody_obj).val() === '1' || condition.value == 64 && $(condition.flag, tbody_obj).val()) {
            // 指定された加算の値が既にプルダウンに存在するかチェック
            const isValueExists = $('.js-selected-adding-all', tbody_obj).filter(function() {
                return $(this).val() == condition.value;
            }).length > 0;

            //該当連動加算が未登録なら
            if (!isValueExists) {

                const selectedBlankElements = $('.js-selected-adding-all', tbody_obj).filter(function() {
                    return !$(this).val();
                });

                const selectedElement = selectedBlankElements.length > 0 ? selectedBlankElements.eq(0) : null;

                //空プルダウンがあれば
                if (selectedElement) {
                    selectedElement.val(condition.value).change();
                }else{
                    $(add_btn_class + ':last', tbody_obj).click();
                    $('.js-selected-adding-all:last', tbody_obj).val(condition.value).change();
                }
            }
        }
    });

}


//連動加算削除
function clearInterlockingAdding(r_id, all_hoiku_flg = null) {

    const conditions = [
        { flag: '.js_support_required_flg', value: '37' },
        { flag: '.js_need_protection_flg', value: '38' },
        { flag: '.js_strength_action_flg', value: '9' },
        { flag: '.js_strength_action_two_flg', value: '71' },
        { flag: '.js_special_support_add', value: '7' },
        { flag: '.js_extension', value: '3' },
        { flag: '.js_hoiku_special_visitor', value: '64' },
        { flag: '.js_hoiku_care_needs_flg', value: '67' },
        { flag: '.js_school_refusal_support_flg', value: '53' }
    ];

    let tbody_obj = $('form');
    let del_btn_class = '.js_delete_single';

    if (r_id) {
        tbody_obj = $('.ibox-inner').find('#js_related_class' + r_id);
        del_btn_class = '.js_delete';
    }

    // 児発・放デイと保育所どちらも予約がある場合、選択したサービスのみを連動
    if (r_id && tbody_obj.length === 2) {
        if (all_hoiku_flg === 1) {
            tbody_obj = tbody_obj.eq(1); // 2つ目のtbody_objを対象とする
        } else if (all_hoiku_flg === null) {
            tbody_obj = tbody_obj.eq(0); // 1つ目のtbody_objを対象とする
        }
    }

    conditions.forEach(condition => {

        //該当加算の存在チェック
        const selectedElements = $('.js-selected-adding-all', tbody_obj).filter(function() {
            return $(this).val() == condition.value;
        });

        const selectedElement = selectedElements.length > 0 ? selectedElements.eq(0) : null;

        //加算が選択されているなら、削除する
        if (selectedElement) {
            if (r_id) {
                selectedElement.closest('tr').find(del_btn_class).click();
            }else{
                selectedElement.closest('td').find(del_btn_class).click();
            }
        }
    });
}

// データを収集してサーバーに送信する関数
function sendDataToServer(data, $parentTd) {

    var rid = $parentTd.closest('tbody').find('[name="r_id"]').val();

    var fix = '';
    if (data['hoiku_flg']) {
        fix = '_hoiku';
    }

    $.ajax({
        url: './ajax/ajax_adding_contents_2024.php',
        type: 'POST',
        data: data,
        success: function(response) {

            //要素をloadする
            $.ajax({
                type: 'GET',
                url: 'attendance.php?mode=detail&date=' + data["date"],
                dataType: 'html',
                success: function (data) {
                    $('#js_adding_list' + rid + fix).html($(data).find('#js_adding_list' + rid + fix).html());

                    //色付け用クラス付与
                    applyColorClasses();
                }
            });
        },
        error: function(xhr, status, error) {
            console.error('通信失敗', error);
        }
    });
}



// 加算項目プルダウン内の表示操作処理
// 選択箇所の親tbodyないにある全ての加算項目プルダウンを更新
function updateSelectOptions(currentRow, className, adding_disable_check_flg = false) {

    const tbody = currentRow.closest('tbody');
    const selectedOptions = [];

    // 非活性化している加算の要素を格納する配列
    const authority_disable_elements = []; // authority_disableクラスを持つ要素を格納

    // 現在選択されているプルダウンの値を取得
    tbody.find('.' + className).each(function() {
        const selectedValue = $(this).val();
        // 選択されている値の要素のクラスを取得して配列へ格納（加算の非活性チェック用）
        const class_list = $(this).attr('class');
        const class_array = class_list.split(' ');

        if (selectedValue) {
            selectedOptions.push(selectedValue);

            // authority_disableクラス（非活性グレー表示）を持つ要素を配列へ格納
            if (class_array.includes('authority_disable')) {
                authority_disable_elements.push($(this));
            }
        }
    });

    // 画面表示時のみ実行（adding_disable_check_flg）
    // 加算が非活性化している場合、詳細のプルダウンも非活性化する処理（加算項目管理：閲覧アカウントの為）
    if (adding_disable_check_flg && authority_disable_elements.length > 0) {
        authority_disable_elements.forEach(function(element) {
            // 加算プルダウンの親tdを取得
            const parent_td = element.closest('td');
            // 対象要素の次のtd（加算の詳細）内 のselect, input, label へクラスを追加
            parent_td.next('td').find('select, input, label').each(function() {
                if (!$(this).hasClass('authority_disable')) {
                    $(this).addClass('authority_disable');
                }
            });
        });
    }

    // 各プルダウンの選択肢を更新
    tbody.find('.' + className).each(function() {
        const currentSelect = $(this);
        const currentSelectedValue = currentSelect.val();

        // 他のプルダウンで選択されている選択肢を除外
        currentSelect.find('option').each(function() {
            const option_value = $(this).val();
            if (option_value !== "" && option_value !== currentSelectedValue && selectedOptions.includes(option_value)) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });
    });
}



// 加算実績テーブルの色付け用の関数
function applyColorClasses() {
    document.querySelectorAll('.js_adding_table').forEach(table => {
        let isOdd = true; // 最初のtbodyがoddクラスを持つかどうか

        table.querySelectorAll('tbody').forEach(tbody => {
            // このtbody内の全てのtr要素に同じクラスを適用
            tbody.querySelectorAll('tr').forEach(tr => {
                tr.classList.remove('odd', 'even'); // 既存のクラスを削除
                tr.classList.add(isOdd ? 'odd' : 'even');
            });
            // 次のtbodyには異なるクラスを適用する
            isOdd = !isOdd;
        });
    });
}


//セレクトの名前変更
//ターゲットがtbodyの場合になったり、tdの場合になったりするので、引数に$targetを渡す
function handleSelectedAddingChangeName(selectedValue, $target, c_id) {

    // 同じ要素内のすべてのフォーム要素をループ処理
    $target.find('input, select, input[type="text"], .newDatePickerJs').each(function() {
        const name_attr = $(this).attr('name');
        if (name_attr) {
            // name属性を分割して、特定の部分を書き換え
            const nameParts = name_attr.split('][');
            if (nameParts.length >= 2) {
                nameParts[0] = 'adding['+c_id;
                nameParts[1] = selectedValue;
                const new_name_attr = nameParts.join('][');
                $(this).attr('name', new_name_attr);
            }
        }

        //idにextra_unit_flagが含まれている場合、idを再設定する
        replaceExtraUnitFlagID ($(this), selectedValue, c_id);
    });
}

/**
 * extra_unit_flagのIDを置き換える処理
 */
function replaceExtraUnitFlagID (value, selected_value, c_id) {
    //idにextra_unit_flagが含まれている場合、idを再設定する
    const id = $(value).attr('id');
    if (id && id.includes('extra_unit_flag')) {
        const extra_unit_label = $(value).closest('.js_extra_unit_flag').find('label');
        const new_id = `extra_unit_flag${selected_value}_${c_id}`;
        $(value).attr('id', new_id);
        extra_unit_label.attr('for', new_id);
    }
}


//フォームの出し入れ関数
//ターゲットがtbodyの場合になったり、tdの場合になったりするので、引数に$targetを渡す
//一覧と一括編集画面の共通処理
function handleSelectedAddingChangeItem(selectedValue, $target) {

    //先に加算関連項目を削除する
    $target.find('.js_adding_relation').children().remove();

    // 一覧画面のみ、一旦指定tr内の全ての「（加算を）登録する」ボタンを非表示にする
    if ($('.edit_detail_flg').length ) {
        $target.find('button.js_hidden_btn').hide();
    }

    //「今日の利用者一括編集」のときのみ、専門的支援実施加算出力場所が異なるので個別で削除
    if ($('.edit_all_flg').length) {

        $target.find('.js_implement_professional_support_span, .js_implement_professional_support_tooltip').remove();

    }

    //関連項目をクローンして入れる
    if ($('.js_adding' + selectedValue).length && selectedValue) {

        //ツールチップのclass初期化設定　baseに残っている大元のツールチップ要素から「smallipop-initialized,smallipop+数字」classを削除しないと動的に生成した際に
        //「smallipop-initialized,smallipop+数字」が要素全体で重複しているとツールチップ使用できないので、ここで対象classを削除する
        if ($('.js_adding' + selectedValue).find('.smallipop').length) {

            // ツールチップの要素から、smallipop+数字のclass名を取得し、その後smallipop-initializedと一緒に削除する
            const remove_smallipop_class = ($('.js_adding'+selectedValue).find('.smallipop').attr('class').match(/smallipop\d+/g) || []).join(' ');
            $('.js_adding' + selectedValue).find('.smallipop').removeClass(`smallipop-initialized ${remove_smallipop_class}`);

        }

        //選択された番号のクラスをクローンし、変数に格納
        const clone_elm = $('.js_adding'+selectedValue).clone();

        //加算セレクトボックスの専門的支援実施加算が選択されたとき
        if (selectedValue == 55) {

            //対象児童の取得（編集画面は直でnameを指定する）
            //一覧・一括編集用
            let selected_child = $target.closest('tbody').find('[name="c_id"]').val();
            //一覧・一括編集用で取得できなかった場合は、個別編集の直接name指定
            selected_child = selected_child ? parseInt(selected_child) : parseInt($('[name="c_id"]').val());

            //対象児童の専門的実施加算関連日数を取得
            const selected_child_implement_professional_support_days = $('#js_target_child_id'+ selected_child).clone();

            //対象児童の専門的支援実施加算の算定回数を取得
            let implement_professional_support_count = $('#js_implement_professional_support_count' + selected_child).text();

            //クローンした対象児童の専門的支援実施加算の算定回数をカウントアップして上書き
            const set_time_item = $(selected_child_implement_professional_support_days).find('#js_implement_professional_support_count'+ selected_child);

            //要素の背景色をアニメーションで変更
            $(set_time_item).animate({ backgroundColor: '#ffe695' }, 1000, function () {

                //算定数をカウントアップする
                set_time_item.text(parseInt(implement_professional_support_count) + 1);

                //アニメーションが完了したら元の背景色に戻す
                $(set_time_item).animate({ backgroundColor: 'transparent' }, 1000);

            });

            //デザイン上注釈が下に落ちてしまうため、CSSクラスのdibをclassに追加している
            $(clone_elm).addClass('dib').find('.js_implement_professional_support_span').remove()
                .end().find('#js_implement_professional_support_select').append(selected_child_implement_professional_support_days);

            //「今日の利用者一括編集」のとき、専門的支援実施加算関連日数の出力場所が異なるため個別で場所指定してクローン追加
            if ($('.edit_all_flg').length) {

                //対象場所に選択された番号のクラスを追加する
                $target.find('.js-selected-adding-all').after(clone_elm);

            } else {

                //「今日の利用者一括編集」以外で専門的支援実施加算を通るとき
                //対象場所に選択された番号のクラスを追加する
                $target.find('.js_adding_relation').append(clone_elm);

            }

        } else {

            //専門的支援実施加算以外のとき
            //対象場所に選択された番号のクラスを追加する
            $target.find('.js_adding_relation').append(clone_elm);

            //医療連携体制加算のⅠ～Ⅶまでの選択肢の制御（一括設定の選択肢を除外する）
            if (selectedValue == 8 && !$target.closest('tbody').hasClass('adding_options_tbody')) {
                //医療的ケア児の場合は、Ⅰ、ⅡとⅢのoptionを削除する
                //一覧、一括編集：tr　OR　個別編集：tbody　に医療的ケア児のアイコンがある
                if ($('.iryoucare', $target.closest('tbody')).length > 0 || $('.edit_single_flg').length && $('.iryoucare', $target.closest('tbody')).length > 0) {
                    $('[name*="medical_adding_flg"]', $target).find('option').filter(function() {
                        return ['1', '2', '3'].includes($(this).val());
                    }).remove();
                } else {
                    //医療的ケア児ではない場合は、ⅣとⅤのoptionを削除する
                    $('[name*="medical_adding_flg"]', $target).find('option').filter(function() {
                        return ['4', '5'].includes($(this).val());
                    }).remove();
                }
                
            }

        }

        // 一括編集
        if ($target.data('rid')) {
            // 加算項目管理の権限を取得
            const tbodyClass = $target.closest('tbody').attr('class');
            const no_edit_adding_flg = tbodyClass === 'js_no_edit_adding' ? true : false;
            // 権限が無い場合
            if (no_edit_adding_flg) {
                // 挿入した要素へクラスを追加（グレー表示処理）
                $target.find('.js_adding_relation .js_adding'+selectedValue).find('select').addClass('authority_disable');
            }
        }

        if (['5', '6', '69', '70'].includes(selectedValue)) {
            $target.find('.js_adding'+selectedValue).show().removeClass('js_adding5').removeClass('js_adding6').removeClass('js_adding69').removeClass('js_adding70');
        }else{
            $target.find('.js_adding'+selectedValue).show().removeClass('js_adding'+selectedValue);
        }

        //個別サポート加算１
        if (selectedValue == 37) {
            let support_one_flg = 0;
            if ($('.edit_all_flg').length) {
                support_one_flg = $target.closest('tbody').find('.js_individual_support_one_flg').val();
            }else{
                support_one_flg = $('.js_individual_support_one_flg').val();
            }

            let strength_action_flg = 0;
            let strength_action_two_flg = 0;
            //一括編集
            if ($target.data('rid')) {
                const rid = $target.data('rid');
                strength_action_flg = $('#js_related_class'+rid).find('.js_strength_action_flg').val();
                strength_action_two_flg = $('#js_related_class'+rid).find('.js_strength_action_two_flg').val();
            //個別編集
            }else{
                strength_action_flg = $('.js_strength_action_flg').val();
                strength_action_two_flg = $('.js_strength_action_two_flg').val();
            }

            //強度行動障害児支援加算と連動あり 個別サポート加算１－２の場合、１－１にする
            if ((strength_action_flg == 1 || strength_action_two_flg == 1) && support_one_flg == 2) {
                support_one_flg = 1;
            }

            $target.find('.js_adding_relation').find('select').val(support_one_flg);
        }

        //訪問支援員特別加算
        if (selectedValue == 64) {
            let hoiku_special_visitor_flg = 0
            //一括
            if ($('.edit_all_flg').length) {
                hoiku_special_visitor_flg = $target.closest('tbody').find('.js_hoiku_special_visitor').val();
            }else{
                //個別
                hoiku_special_visitor_flg = $('.js_hoiku_special_visitor').val();
            }

            $target.find('.js_adding_relation').find('select').val(hoiku_special_visitor_flg);
        }

        // 医療連携加算
        if (selectedValue == 8) {

            let selected_medical_adding_number = undefined;
            selected_medical_adding_number = $target.find('select[name$="[medical_adding_flg]"]').val();

            if (selected_medical_adding_number === undefined) {

                selected_medical_adding_number = $target.find('select[name$="medical_adding_flg"]').val();
            }

            // 医療連携加算が４、５の場合のみ、 算定状況の選択を活性にする
            if (selected_medical_adding_number == 4 || selected_medical_adding_number == 5) {
                $target.find('.medical_adding_status').prop('disabled', false).css('background', '');
            } else {
                $target.find('.medical_adding_status').prop('disabled', true).css('background', '#EEE');
            }
        }

        // Datepickerを再初期化
        $target.find('.newDatePickerJs').removeAttr('id').removeClass('hasDatepicker').datepicker();

    }else{
        /*一覧画面の場合*/
        if ($('.edit_detail_flg').length && selectedValue) {
            $target.find('button').show();
        }
    }

}

/**
 * 加算項目のエラーチェック
 * @param adding_contents 加算項目td
 * @return void エラーがある場合はエラーメッセージを返す
 */
function checkAddingContentsError (adding_contents) {
    const time_check_contents = [1, 3, 4, 35, 54, 63, 72, 73]; // 時間が必須の加算項目ID
    let contents_err = ''; // エラー内容を格納する変数
    const time_array = []; // 時間を格納する配列
    const selected_contents = $(adding_contents).find('.js-selected-adding-all').val(); // 選択された加算項目の値を取得

    let same_code_flg = 0;
    if (parseInt(selected_contents) === 57) {
        const $td = $(adding_contents).closest('td');
    
        // テキスト内容で検索
        const td_text = $td.text();
        same_code_flg = td_text.includes('同一事業所番号') && td_text.includes('同日に算定している');
    }
    //まずはエラーを削除
    $(adding_contents).find('.err').remove();

    // 時間の数を数える
    const time_count = $(adding_contents).find('.js_adding_time').length / 4;
    // 指定された各時間セットに対して処理
    for (let i = 0; i < time_count; i++) {
        // 時間の開始と終了を取得
        const s_hour = $(adding_contents).find(`[name="s_hour${i+1}"]`).val();
        const s_min = $(adding_contents).find(`[name="s_min${i+1}"]`).val();
        const e_hour = $(adding_contents).find(`[name="e_hour${i+1}"]`).val();
        const e_min = $(adding_contents).find(`[name="e_min${i+1}"]`).val();

        // 時間が正しく選択されているか確認
        if (s_hour && s_min && e_hour && e_min) {
            const start_time = s_hour.padStart(2, '0')  + s_min.padStart(2, '0');
            const end_time = e_hour.padStart(2, '0')  + e_min.padStart(2, '0');
            // 配列に時間のオブジェクトを追加
            time_array[i] = { start_time, end_time };
        }
    }

    // 時間のエラーチェック
    if (time_array && time_array.length > 0) {
        // 時間の数だけループ
        time_array.forEach((element, index) => {
            // 時間の開始と終了を取得
            const start_time = element.start_time;
            const end_time = element.end_time;
            // 時間のエラーチェック
            if (start_time >= end_time) {
                contents_err = '開始時間は終了時間よりも前に設定してください。';
            }
            // 時間の重複チェック
            for (let i = index + 1; i < time_array.length; i++) {
                const next_start_time = time_array[i].start_time;
                const next_end_time = time_array[i].end_time;

                if ((start_time >= next_start_time && start_time < next_end_time) || (end_time > next_start_time && end_time <= next_end_time)) {
                    contents_err = '時間が重複しています。';
                }
            }
        });
    } else if (time_check_contents.includes(parseInt(selected_contents))) {
        // 時間が必須の場合はエラー
        contents_err = '時間の入力は必須です。';
    }

    // 保育・教育等移行支援の日付チェック
    if (parseInt(selected_contents) === 10) {
        let err_text = '';
        const nursing_move_date = $(adding_contents).find('[name="nursing_move_date"]').val();
        const nursing_add_date = $(adding_contents).find('[name="nursing_add_date"]').val();
        // 移行日と移行後算定日が入力されているかチェック
        if (!nursing_move_date) {
            err_text = '移行日';
        }
        if (!nursing_add_date) {
            err_text = err_text ? err_text + 'と移行後算定日' : '移行後算定日';
        }

        if (err_text !== '') {
            contents_err = err_text + 'を入力してください';
        }

        if (nursing_move_date && nursing_add_date) {
            let move_date = new Date(nursing_move_date);
            let add_date = new Date(nursing_add_date);

            // 移行後算定日より前の日付を選択している場合エラー
            if (move_date > add_date) {
                contents_err = '移行後算定日より前の日付を選択してください。';
            }

            // 移行後算定日は移行日から30日以内で選択していない場合エラー
            let days_diff = (add_date - move_date) / (1000 * 60 * 60 * 24);
            if (days_diff > 30) {
                contents_err = '移行後算定日は移行日から30日以内で選択してください。';
            }
        }
    }

    // 家族支援加算は支援場所の存在チェック
    if (parseInt(selected_contents) === 54 || parseInt(selected_contents) === 63 || parseInt(selected_contents) === 72 || parseInt(selected_contents) === 73) {
        if ($(adding_contents).find('[name="family_support_place"]').val() === '') {
            contents_err = '家族支援加算の支援場所を選択してください';
        }
    }

    // 強度行動障害児支援加算の併用チェック
    if (parseInt(selected_contents) === 9 || parseInt(selected_contents) === 71  || parseInt(selected_contents) === 37) {
        // 登録済みの加算を格納する配列
        let checked_adding_array = [];
        // 親のtbodyを取得
        let parent_tbody = adding_contents.closest('tbody');

        // 登録済みの加算を取得
        parent_tbody.find('input[type="hidden"][name^="adding"]').each(function() {
            //加算項目の値をname属性から取得
            let save_adding = $(this).attr('name');
            //取得したname内の最初の'adding[]['というの文字列と、最後にある'][id]'という文字列を削除
            let save_adding_val = save_adding.replace('adding[][', '').replace('][id]', '');

            //個別サポート加算１の場合
            if (save_adding_val == 37) {
                $(parent_tbody).find('.green').each(function() {
                    var adding_html = $(this).html();
                    if (adding_html.indexOf('個別サポート加算（Ⅰ）') != -1 && adding_html.indexOf('②') != -1) {
                        checked_adding_array.push('37-2');
                    }
                });

                if ($(adding_contents).closest('tbody')) {}
            }
            //加算項目の値を配列へ格納
            checked_adding_array.push(save_adding_val);
        });

        //
        if ((checked_adding_array.includes('9') || checked_adding_array.includes('71')) && parseInt(selected_contents) === 37 && $(adding_contents).find('.js_classification').val() == 2) {
            contents_err = '個別サポート加算（Ⅰ）の②と強度行動障害児支援加算は一緒に算定できません';
        }

        if (checked_adding_array.includes('37-2') && (parseInt(selected_contents) === 9 || parseInt(selected_contents) === 71)) {
            contents_err = '強度行動障害児支援加算と個別サポート加算（Ⅰ）の②は一緒に算定できません';
        }

        //登録済みの加算と登録しようとしている加算の併用チェックに引っかかった場合はエラー
        if ((checked_adding_array.includes('9') && parseInt(selected_contents) === 71) || (checked_adding_array.includes('71') && parseInt(selected_contents) === 9)) {
            contents_err = '強度行動障害児支援加算(Ⅰ)と強度行動障害児支援加算(Ⅱ)は同一日には一緒に登録できません';
        }
    }

    // 通所自立支援加算の90日超えチェック
    if (parseInt(selected_contents) === 57) {
        const checkbox = $(adding_contents).find('input[type="checkbox"][name*="get_over_ninety_flg"]');

        // テキストから初回算定日を取り出す
        const msg_txt = $(adding_contents).find('span.message.ml5').text();
        const over_ninety_before = $(adding_contents).find('input[name$="[over_ninety_before]"]');

        if (same_code_flg) {
            contents_err = '▼同一事業所番号の施設で、同日に算定している為登録できません。';
        } else if (msg_txt) {
            if (over_ninety_before.length !== 0) {
                // 初回算定日が今日の日付より後だったら
                contents_err = '最新の日付より90日を超えた前日での登録は行えません。';
            } else if (checkbox.length > 0 && !checkbox.is(':checked')) {
                // 初回算定日から90日を超えている && チェックが無い時
                contents_err = '90日を超えて算定する場合はチェックを入れてください。';
            }
        }
    }

    return contents_err;
}

/**
 * 上限エラーチェック
 * @param elements 加算項目td
 * @param f_id 施設ID
 * @param c_id 児童ID
 * @param date 日付
 */
function checkLimitError(elements, f_id, c_id, date, selectedValue) {
    // 選択されたオプションの加算名を取得
    const adding_name = elements.find('.js-selected-adding-all').find(':selected').data('adding_name');
    //区分取得
    let classification = 1;
    if (elements.find('.js_classification').length) {
        classification = elements.find('.js_classification').val();
    } else if (adding_name === 'relation_add_school') {
        //関係機関連携加算は自身のバリュー値で区分を取得
        //区分配列作成
        let classification_array = { 5: 1, 6: 2, 69: 3, 70: 4 };
        classification = classification_array[selectedValue];
    }

    //上限エラーチェック
    if (selectedValue) {
        let limits = getAddingCount(f_id, c_id, date, adding_name, classification);

        //90日以内のチェックがあれば追加単位項目にチェックをつける
        if (limits['ninety_days'][f_id][c_id][selectedValue]) {
            const first_date = limits['ninety_days'][f_id][c_id][selectedValue]['first_date'];
            const check_flag = limits['ninety_days'][f_id][c_id][selectedValue]['is_past'];
            const pass_days = limits['ninety_days'][f_id][c_id][selectedValue]['pass_days'];
            //初回算定日があれば表示させる
            if (first_date) {
                $(elements).find('.js_first_date').text(`初回算定日：${first_date}（${pass_days}日経過）`);
            }
            //追加単位項目のIDを取得
            extra_unit_flag_id = `#extra_unit_flag${selectedValue}_${c_id}`;

            if (check_flag === true) {
                $(extra_unit_flag_id).prop('checked', true);
            } else {
                $(extra_unit_flag_id).prop('checked', false);
            }
        }

        // キーがadding_nameのものが見つかるまで探し続ける
        while (limits && !limits.hasOwnProperty(adding_name)) {
            // limitsが配列の場合は、配列の中から探す
            if (Array.isArray(limits)) {
                limits = limits.find(obj => obj.hasOwnProperty(adding_name));
            // limitsがオブジェクトの場合は、オブジェクトの中から探す
            } else if (typeof limits === 'object') {
                limits = Object.values(limits).find(obj => obj.hasOwnProperty(adding_name));
            // もし見つからなかったらループを抜ける
            } else {
                break;
            }
        }

        //一度エラーメッセージを削除
        elements.find('.err').remove();
        // エラーが見つかった場合はエラーメッセージを取得
        // 延長支援加算のみ連動加算の関係でjs側のエラーメッセージが必要ないため、PHP側で行う(個別編集と一括編集)
        const index_flag = $('.edit_detail_flg').length ? 1 : 0;
        if (limits && limits.hasOwnProperty(adding_name) && (adding_name !== 'extension_adding' || index_flag) ) {
            // 通所自立支援加算の場合
            if (adding_name === 'day_school_independence_support') {
                const day_school = limits.day_school_independence_support;
                let oldest_key = null;
                let oldest_date_obj = null;
                
                // 1(片道)と2(往復)の中で、より古い方の日付を取得
                for (const key in day_school) {
                    const current = day_school[key];
                    if (!current.oldest_date) {
                        continue;
                    }
                    const current_date_obj = new Date(current.oldest_date);
                    // まだ未設定 or より古い日付なら更新
                    if (!oldest_date_obj || current_date_obj < oldest_date_obj) {
                        oldest_date_obj = current_date_obj;
                        oldest_key = key;
                    }
                }

                if ($('.edit_all_flg').length === 0 && $('.edit_detail_flg').length === 0) {
                    const $td_element = elements.find('.js-selected-adding-all').closest('td');
                    // 変更前のチェックボックスの状態を取得(片道 ↔ 往復の変更時用)
                    const check_info = checkNinetyDaysCheckbox($td_element);
                    $td_element.find('p.err_check_flg').remove();

                    // 同一日に同一事業所番号で算定されている場合(出席表ページの為、本来はあり得ないが、万が一の為)
                    if (day_school['same_code']) {
                        const err_msg = `<p class="err err_check_flg ml10">▼${day_school[1]}</p>`;
                        $td_element.prepend(err_msg);
                    } else if (day_school[oldest_key] && day_school[oldest_key]['days_msg']) {
                        const ninety_flg = day_school[oldest_key]['ninety_days_flg'];
                        const ninety_days_before_flg = day_school[oldest_key]['over_ninety_days_before'];
                        const $container = $td_element.find('.js_adding_relation .js_hidden_content');
                        
                        // 既存の関連要素を削除
                        $container.find('.message, label.checkbox05, p.err_check_flg, span.js_days_school').remove();
                        const $select_classification = $container.find('select.js_classification');
                        
                        // エラーメッセージを準備
                        let error_msg = '';
                        
                        // 90日を超えている場合
                        if (ninety_flg) {
                            // 90日チェックボックスにチェックが無い時
                            if ($('.edit_detail_flg').length === 0 && check_info.is_checked === false) {
                                error_msg = `<p class="err err_check_flg ml10">▼90日を超えて算定する場合はチェックを入れてください。</p>`;
                            }
                        } else if (ninety_days_before_flg) {
                            // 90日を超えた前日の場合
                            error_msg = `<p class="err err_check_flg ml10 over_first_day">▼最新の算定日より90日を超えた前日での登録は行えません。</p>`;
                        }
                        
                        // コンテナを空にする
                        $container.empty();
                        
                        // 要素を順番に追加（左から右へ）
                        $container.append($select_classification);
                        
                        // チェックボックスがある場合は追加
                        if (ninety_flg) {
                            // 元々チェックされてた場合はその状態を引き継ぐ
                            const check_status = check_info.is_checked ? 'checked' : '';
                            $container.append(`
                                <label class="checkbox05 ml5">
                                    <input type="checkbox" name="adding[${c_id}][57][get_over_ninety_flg]" value="1" ${check_status}>90日超えても算定する
                                </label>
                            `);
                        }
                        
                        // 日数メッセージを追加
                        $container.append(`<span class="message ml5">${day_school[oldest_key]['days_msg']}</span>`);
                        
                        // hidden入力を追加
                        $container.append(`<input type="hidden" name="adding[${c_id}][57][over_ninety]" value="${ninety_flg}">`);
                        
                        if (ninety_days_before_flg) {
                            $container.append(`<input type="hidden" name="adding[${c_id}][57][over_ninety_before]" value="${ninety_days_before_flg}">`);
                        }
                        
                        // エラーメッセージを td 要素の先頭に配置
                        if (error_msg) {
                            $td_element.prepend(error_msg);
                        }
                    }

                    // 個別画面のエラーチェック
                    checkErrorsAndUpdateSaveButton($('.js-selected-adding-all').closest('tr'));
                } else {
                    elements.find('select[name*="day_school_independence_support_flg"].js_classification').each(function() {
                        const $select = $(this);
                        const $td = $select.closest('td');
                    
                        // 変更前のチェックボックスの状態を取得(片道 ↔ 往復の変更時用)
                        const check_info = checkNinetyDaysCheckbox($td);
                        
                        // まず、既存のhidden入力を削除
                        $select.nextAll('input[type="hidden"]').remove();
                        
                        // 既に表示されているその他のメッセージ等も消してから表示
                        $select.nextAll('.message, label.checkbox05, p.err_check_flg, span.js_days_school').remove();
                        
                        // td内に直接配置されたエラーメッセージも削除
                        $td.find('> p.err_check_flg').remove();

                        // 同一事業所番号で同一日に算定されている場合
                        if (day_school['same_code']) {
                            const err_msg = `<p class="err err_check_flg ml10" data-error-type="same-code">▼${day_school[1]}</p>`;
                            $td.prepend(err_msg);
                            $td.prepend(`<input type="hidden" name="adding[${c_id}][57][same_code]" value="1">`);
                        } else if (day_school[oldest_key] && day_school[oldest_key]['days_msg']) {
                            const ninety_flg = day_school[oldest_key]['ninety_days_flg'];
                            const ninety_days_before_flg = day_school[oldest_key]['over_ninety_days_before'];
                            
                            // 追加する要素を変数に格納
                            let elements_to_add = [];
                            
                            // 順序を調整：チェックボックス -> メッセージ -> hidden値 の順に格納
                            if (ninety_flg) {
                                // 元々のチェック状態を保持
                                const check_status = check_info.is_checked ? 'checked' : '';
                                elements_to_add.push(`
                                    <label class="checkbox05 ml5">
                                        <input type="checkbox" name="adding[${c_id}][57][get_over_ninety_flg]" value="1" ${check_status}>90日超えても算定する
                                    </label>
                                `);
                            }
                            
                            // メッセージを追加
                            elements_to_add.push(`<span class="message ml5">${day_school[oldest_key]['days_msg']}</span>`);
                            
                            // hidden値を一度だけ追加
                            elements_to_add.push(`<input type="hidden" name="adding[${c_id}][57][over_ninety]" value="${ninety_flg}">`);
                            
                            if (ninety_days_before_flg) {
                                elements_to_add.push(`<input type="hidden" name="adding[${c_id}][57][over_ninety_before]" value="${ninety_days_before_flg}">`);
                            }
                            
                            // 要素を一度にまとめて追加
                            $select.after(elements_to_add.join(''));
                            
                            // エラーメッセージ用
                            let error_msg = '';
                            
                            if (ninety_flg) {
                                // チェックが無い時にエラー表示をする
                                if ($('.edit_detail_flg').length === 0 && check_info.is_checked === false) {
                                    error_msg = `<p class="err err_check_flg ml10">▼90日を超えて算定する場合はチェックを入れてください。</p>`;
                                } else if (index_flag && check_info.is_checked === false) {
                                    error_msg = `<p class="err err_check_flg ml10">90日を超えて算定する場合はチェックを入れてください。</p>`;
                                }
                            } else if (ninety_days_before_flg) {
                                // 90日を超えた前日の場合にエラーを出す
                                error_msg = `<p class="err err_check_flg ml10 over_first_day">▼最新の算定日より90日を超えた前日での登録は行えません。</p>`;
                            }
                            
                            // エラーメッセージがある場合、td要素の先頭に配置する
                            if (error_msg) {
                                $td.prepend(error_msg);
                            }
                        }
                    });

                    // 一括画面でのエラーチェック
                    checkTableForErrors();
                }
            } else {
                contents_err = limits[adding_name][classification];
                // 初回加算のみオレンジエラーの場合があるため、エラー種別を分岐
                let error_type = limits['hoiku_flg'] ? 'err orang' : 'err';
                elements.find('.js-selected-adding-all').closest('td').prepend(`<p class="${error_type}">${contents_err}</p>`);

                //一覧画面の場合、登録ボタンを非活性にする(オレンジエラーの場合のみ非活性化はしない)
                if (index_flag) {
                    const hidden_btn = elements.find('.js_hidden_btn');
                    if (error_type === 'err') {
                        hidden_btn.addClass('disable');
                    } else {
                        hidden_btn.removeClass('disable');
                    }
                }
            }
        } else {
            //一覧画面の場合、登録ボタンを活性にする
            if (index_flag) {
                elements.find('.js_hidden_btn').removeClass('disable');
            } else if ($('.edit_all_flg').length === 0 && $('.edit_detail_flg').length === 0) {
                // 個別の場合、特に行わない
            } else {
                // 一覧の場合、エラーチェックを行う
                checkTableForErrors();
            }
        }
    } else {
        if ($('.edit_detail_flg').length) {
            // 一覧画面の場合、特に行わない
        } else if ($('.edit_all_flg').length === 0 && $('.edit_detail_flg').length === 0) {
            // 個別編集の場合、特に行わない
        } else {
            // 一括画面の場合、エラー文を削除し、エラーチェックを行う
            const $same_code_err = $(elements).find('p[data-error-type="same-code"]');
            const $hidden_same_code = $(elements).find('input[name*="same_code"]');
            const $ninety_days_err = $(elements).find('p.err_check_flg:not([data-error-type])');
            $same_code_err.length > 0 && $same_code_err.remove();
            $hidden_same_code.length > 0 && $hidden_same_code.remove();
            $ninety_days_err.length > 0 && $ninety_days_err.remove();

            checkTableForErrors();
        }
    }
}

/**
 * 通所自立支援加算で、90日を超えても算定するかどうかのチェックの有無を見る
 */
$(document).on('change', 'input[name^="adding"][name$="[get_over_ninety_flg]"]', function() {
    const name_attr = $(this).attr('name');
    const match = name_attr.match(/adding\[(\d+)\]\[57\]\[get_over_ninety_flg\]/);
    
    if (match && match[1]) {
        // 現在の行（親要素）を特定
        const current_row = $(this).closest('div');
        const td_element = $(this).closest('td');
        
        if (current_row.find('.over_first_day').length > 0) {
            // 初回算定日より前だったらエラーは表示しておく
        } else if ($(this).is(':checked')) {
            // チェックが入っている場合、現在の行のエラーメッセージを削除
            td_element.find('p.err_check_flg').remove();
        } else if ($('.edit_detail_flg').length === 0) {
            td_element.find('p.err_check_flg').remove();
            
            // エラーメッセージを作成
            const error_msg = `<p class="err err_check_flg ml10">▼90日を超えて算定する場合はチェックを入れてください。</p>`;
            
            // td要素の先頭にエラーメッセージを追加
            td_element.prepend(error_msg);
        }
    }

    if ($('.edit_all_flg').length === 0 && $('.edit_detail_flg').length === 0) {
        // 個別画面のエラーチェック
        checkErrorsAndUpdateSaveButton($('.js-selected-adding-all').closest('tr'));
    } else {
        // 一括画面でのエラーチェック
        checkTableForErrors();
    }
});

/**
 * 一括画面用のエラーチェック
 */
function checkTableForErrors() {
    // エラーフラグ（エラーがあればtrueに変更）
    let has_errors = false;
    
    // テーブル内の各行を検査
    $('.js_adding_table tbody').each(function() {
        const day_school_errors = $(this).find('.js_hidden_content p.err_check_flg, td > p.err_check_flg');
        
        if (day_school_errors.length > 0) {
            has_errors = true;
            return false;
        }
    });

    if (has_errors) {
        $('.save').prop('disabled', true).addClass('disable');
    } else {
        $('.save').prop('disabled', false).removeClass('disable');
    }
}

/**
 * 各施設の回数制限
 * @param f_id  施設ID
 * @param date  yyyy-dd-mm
 */
function getAddingCount(f_id, c_id, date, adding_name, classifications) {

    const url = "./ajax/ajax_adding_contents_children_2024.php?f_id=" + f_id + "&date=" + date;
    let limit = '';
    $.ajax({
        url: url,
        data: {
            "f_id": f_id,
            "c_id": c_id,
            "date": date,
            "adding_name": adding_name,
            "classifications": classifications
        },
        timeout: 3000,
        async: false,
        dataType: 'json',
        type: 'POST',
        success: function (data) {
            limit = data;
        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });

    return limit;
}

/**
 * 警告エラーチェック
 * @param elements 加算項目tr
 * @param f_id 施設ID
 * @param c_id 児童ID
 * @param date 日付
 */
function checkYellowError(elements, f_id, c_id, selectedValue) {

    //一度警告メッセージを削除
    elements.find('.orang').remove();

    //初回加算(保育)
    if (selectedValue == 12) {
        const orange_err = $('[name="hoiku_first_err[' + f_id + '][' + c_id + ']"]').clone();

        // 警告エラーが見つかった場合は警告エラーメッセージを取得
        if (orange_err) {
            elements.find('.js-selected-adding-all').closest('td').prepend(orange_err);
        }
    }
}

/**
 * 加算の併用エラーチェック(エラーの削除処理)
 * @param currentTbody  加算項目tr
 * @param selectedValue  選択された加算の値
 */
function checkConcurrentUse(currentTbody, selectedValue) {
    // 強度行動障害児支援加算の併用エラーチェック
    if (selectedValue === 9 || selectedValue === 71) {
        // 一旦tbody内の選択している加算全て取得して配列へ格納
        let selectedAddings = [];
        currentTbody.find('.js-selected-adding-all').each(function() {
            selectedAddings.push($(this).val());
        });
        // 選択加算に内に9と71がある場合は処理を中断（既に出ているエラー削除したくない為）
        if (selectedAddings.includes('9') && selectedAddings.includes('71')) {
            return;
        }

        // 選択している全ての加算をループ処理
        currentTbody.find('.js_adding_tr').each(function() {
            // 選択している加算の値を取得
            let checkedValue = parseInt($(this).find('.js-selected-adding-all').val());
            // 削除する加算と選択している加算の組み合わせによりエラーを削除
            if ((selectedValue === 9 && checkedValue === 71) || (selectedValue === 71 && checkedValue === 9) || (!checkedValue)) {
                // 選択されている加算のエラーを削除
                $(this).find('.err').remove();
            }
        });
    }
}


// エラーを検知して、保存ボタンの活性・非活性化を操作する処理
function checkErrorsAndUpdateSaveButton(currentRow) {
    // 現在の行から親のtbodyを取得
    const tbody = currentRow.closest('tbody');

    const options_flg = tbody.hasClass('adding_options_tbody') ? 1 : 0;
    let errorFound = false;

    // 操作オプションの場合(現在操作オプション動いていない為コメントアウト)
    if (options_flg === 1) {
        // const $optionsAdding = tbody.closest('#inputAdding');
        // let allValuesAreNone = true; // 全ての値が空文字かどうかを追跡するフラグ
        //
        // // .js-selected-adding-optionsクラスを持つselect要素の値を取得してチェック
        // $optionsAdding.find('.js-selected-adding-options').each(function() {
        //     let selectedValue = $(this).val();
        //
        //     // どれかの値が入っていればフラグをfalseに設定
        //     if (selectedValue) {
        //         allValuesAreNone = false;
        //         return false; // ループから抜ける
        //     }
        // });
        //
        // if ($optionsAdding.find('.err:visible').not('.js_clone_obj .red:visible, .js_attendance_area .red:visible, .time-error:visible, .date-error:visible').length > 0) {
        //     errorFound = true;
        // }
        //
        // // errorFoundの値に応じて反映ボタンの状態を更新
        // if (errorFound || allValuesAreNone) {
        //     $('.allSetBtn_adding').prop('disabled', true).addClass('disable');
        // } else {
        //     $('.allSetBtn_adding').prop('disabled', false).removeClass('disable');
        // }

    } else {
        // tbody内の全てのtr.js_adding_trクラスをチェック
        tbody.find('tr.js_adding_tr').each(function() {
            // 各tr.js_adding_trの中の表示状態のerrクラス要素をチェック（時間エラーは除外）
            if ($(this).find('.err').not('.orang').not(':contains("時間")').length > 0) {
                errorFound = true;
                return false; // エラーが見つかったらループを抜ける
            }
        });
        // errorFoundの値に応じて保存ボタンの状態を更新
        if (errorFound) {
            $('.save').prop('disabled', true).addClass('disable');
        } else {
            $('.save').prop('disabled', false).removeClass('disable');
        }
    }
}


/**
 * 加算の併用エラーチェック(個別サポート加算１の２と強度行動障害児加算)
 * @param currentTbody  加算項目$tbody
 */
function checkSupport1_2AndStrongBehavior($tbody) {

    //エラーメッセージ準備
    let err = "<p class='err js_support_one_err'>▼個別サポート加算（Ⅰ）の②と強度行動障害児支援加算は一緒に算定できません</p>";
    var support_one2_flg = 0;
    var strong_behavior_flg = 0;
    var support_one2_obj = 0;

    $tbody.find('.js-selected-adding-all').each(function() {
        if ($(this).val() == 37 && $(this).closest('tr').find('.js_classification').val() == 2 ) {
            support_one2_flg = 1;
            support_one2_obj = $(this);
        }

        if ($(this).val() == 9 || $(this).val() == 71) {
            strong_behavior_flg = 1;
        }
    });

    if (support_one2_flg == 1 && strong_behavior_flg == 1) {
        $(support_one2_obj).closest('td').prepend(err);
    }

    return;
}

/**
 * 追加単位にチェックが入っているかどうかを判定する
 * @param checkbox 追加単位フラグ
 * @param addingValue 加算の値
 * @return 追加単位フラグの値
 */
function checkedExtraUnitFlag (checkbox, addingValue) {
    let extraUnitFlag = null;
    if ($(checkbox).prop('checked')) {
        extraUnitFlag = addingValue;
    }

    return extraUnitFlag;
}


/**
 * 指定された要素内のチェックボックスの存在と状態を確認する関数
 * @param {jQuery|HTMLElement} element - チェックボックスを検索する親要素
 * @return {Object} - 存在するかどうかとチェック状態を含むオブジェクト
 */
function checkNinetyDaysCheckbox(element) {
    // jQueryオブジェクトに変換（すでにjQueryオブジェクトの場合はそのまま）
    const $element = $(element);

    // チェックボックスを検索
    // 1. name属性が[get_over_ninety_flg]を含む入力要素を探す
    const $checkbox = $element.find('input[type="checkbox"][name*="get_over_ninety_flg"]');

    // 結果オブジェクトを作成
    const result = {
        exists: $checkbox.length > 0,    // チェックボックスが存在するか
        is_checked: false,                // チェックされているか（デフォルトは false）
        element: $checkbox.length > 0 ? $checkbox : null  // チェックボックス要素（存在する場合）
    };

    // チェックボックスが存在する場合、チェック状態を確認
    if (result.exists) {
        result.is_checked = $checkbox.is(':checked');
    }

    return result;

}

// 医療連携体制加算でⅠ～Ⅲ、Ⅵ、Ⅶを選択した場合、算定状況を非活性にして利用者1人に固定する(一括編集＆個別編集の場合)
$(document).on('change', 'select[name$="[medical_adding_flg]"]', function () {

    let selected_medical_adding_number = $(this).val();

    // 医療連携加算が４、５の場合のみ、 算定状況の選択を活性にする
    if (selected_medical_adding_number == 4 || selected_medical_adding_number == 5) {
        $(this).closest('tr').find('.medical_adding_status').prop('disabled', false).css('background', '');
    } else {
        $(this).closest('tr').find('.medical_adding_status').prop('disabled', true).css('background', '#EEE');
    }
});

// 医療連携体制加算でⅠ～Ⅲ、Ⅵ、Ⅶを選択した場合、算定状況を非活性にして利用者1人に固定する(加算登録タブの場合)
$(document).on('change', 'select[name$="medical_adding_flg"]', function () {

    let selected_medical_adding_number = $(this).val();

    // 医療連携加算が４、５の場合のみ、 算定状況の選択を活性にする
    if (selected_medical_adding_number == 4 || selected_medical_adding_number == 5) {
        $(this).closest('tr').find('.medical_adding_status').prop('disabled', false).css('background', '');
    } else {
        $(this).closest('tr').find('.medical_adding_status').prop('disabled', true).css('background', '#EEE');
    }
});
