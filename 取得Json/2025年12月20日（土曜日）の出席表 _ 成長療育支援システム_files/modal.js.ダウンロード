/*
モーダル画面
-----------------------------------------------*/

var gScrollTop = 0; // モーダル前の画面のスクロール位置を記憶
function isMobile() {

    // wmsで動かないよう一時対応
    var location_href = location.href;
    /*if(location_href.indexOf("/wms/") > -1){
        return false;
    }*/

    var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    return /android|hug_app_webview-1-ios/i.test(userAgent) || /iPad|iPhone|iPod/.test(userAgent);
}

/* --- デジタルサイン用処理 --- */
/**
 * サインモーダルを閉じる (各引数はマイページ側(react用)でのみ使用)
 * @param {string || null} action       操作の種類 (save:サイン保存, delete:サイン削除)
 * @param {string || null} filename     サインの画像ファイル名
 * @param {string || null} saved_data   サインの画像データ
 * @param {string || null} path         サインの保存先パス
 * 
 * @return {void}
 */
function closeSignForm(action=null, filename=null, saved_data=null, path=null) {
    changeDateTextState(action, filename, path);
    
    const form_body = $('.c_sign_form_body');
    const is_all_parameter_saved = [action, filename, saved_data, path].every(Boolean);
    // 既存の方法
    if (form_body.is(':visible')) {
        form_body.hide();
        $('.c_original_body').show();
        $(window).scrollTop(gScrollTop);

        if (is_all_parameter_saved) {
            loadSavedImg(action, filename, saved_data, path);
        }
        return;
    }

    // reactからの保存処理終了後 (マイページ側)
    if ($.magnificPopup && $.magnificPopup.instance && $.magnificPopup.instance.isOpen) {
        // モーダルを閉じる
        $.magnificPopup.close();
        // 保存したサインを新たに表示する
        if (is_all_parameter_saved) {
            loadSavedImg(action, filename, saved_data, path);
        }
    }
}

/**
 * デジタルサイン画像を出す処理
 * @param {string || null} action
 * @param {string || null} filename
 * @param {string || null} saved_data
 * @param {string || null} path
 * @return {void}
 */
function loadSavedImg(action, filename, saved_data, path) {
    if (!filename) {
        return;
    }

    try {
        if (action === 'save' && saved_data) {
            // 日付サインの場合
            if (path.date) {
                // サインを表示する為の要素を探す
                const container_elems = document.querySelectorAll(`.sign_${path.date}_${filename}`);

                // 要素がある場合のみ、サインの上書き表示を行う
                container_elems.forEach(container_elem => {
                    if (container_elem) {
                        handleMapImage(saved_data.date, container_elem, 'signImg_ymd');
                    }
                })
            }

            // 名前サインの場合 (日付と名前の両方を一度に保存するサインがある為、elseifを用いず別々に判定を行う)
            if (path.name) {
                const container_elems = document.querySelectorAll(`.sign_${path.name}_${filename}`);

                container_elems.forEach(container_elem => {
                    if (container_elem) {
                        handleMapImage(saved_data.name, container_elem, 'signImg');
                    }
                })
            }
        } else if (action === 'delete') {
            if (path.date) {
                const date_selector = `.sign_${path.date}_${filename}`;
                const date_link_containers = document.querySelectorAll(date_selector);

                date_link_containers.forEach(date_link_container => {
                    if (date_link_container) {
                        handleImageDelete(date_link_container.querySelector('.signImg_ymd'));
                    }
                })
            }

            if (path.name) {
                const name_selector = `.sign_${path.name}_${filename}`;
                const name_link_containers = document.querySelectorAll(name_selector);

                name_link_containers.forEach(name_link_container => {
                    if (name_link_container) {
                        handleImageDelete(name_link_container.querySelector('.signImg'));
                    }
                })
            }
        }

        // 上限管理のサイン更新があった場合、上限管理のサイン状態も更新する
        const upper_limit_sign_flg = $('#upper_limit_sign_flg').val();
        if (upper_limit_sign_flg && upper_limit_sign_flg === '1') {
            const date_flg = path.date ? 1 : 0;
            updateNeedSignStatusForUpperLimit(date_flg);
        }
    } catch (e) {
        console.error("サインデータの解析・表示中にエラーが発生しました:", e);
    }
}

/**
 * 画像を描画または新規作成する関数
 * @param {string}          base64_data     画像データ
 * @param {Element|null}    container_elem  既存の<span>要素（なければnull）
 * @param {string}          img_class       要素指定用のクラス
 */
function handleMapImage(base64_data, container_elem, img_class) {
    // 画像データが無い場合は削除として処理する
    if (!base64_data) {
        handleImageDelete(container_elem.querySelector(`.${img_class}`));
        return;
    }

    const link_elem = container_elem.querySelector('a.modalEdit');
    if (!link_elem) {
        return;
    }

    let target_img = link_elem.querySelector(`.${img_class}`);

    // html内にimg要素がなければ新規作成 (サイン画像が元々ない場合・新規作成時等)
    if (!target_img) {
        target_img = document.createElement('img');
        target_img.className = img_class;
        
        // 編集アイコンを探して、その前に挿入する
        let referenceNode = link_elem.querySelector('.pull-right, .service_reocrd_btn');
        
        // もし<span>タグが見つからなければ、アイコン<i>タグ自体を探します。
        if (!referenceNode) {
            referenceNode = link_elem.querySelector('.fa-fw.print, .fa.print');
        }
        
        // 基準要素が見つかれば、その直前に画像を挿入します。
        if (referenceNode) {
            link_elem.insertBefore(target_img, referenceNode);
        } else {
            // どちらも見つからない場合の最終手段として、末尾に追加します。
            link_elem.appendChild(target_img);
        }
    }
    
    // srcとスタイルをセット
    target_img.src = base64_data;
    target_img.style.width = 'auto';
    target_img.style.height = '30px';
}

/**
 * 画像を削除する関数
 * @param {Element} img_elem 削除する<img>要素
 */
function handleImageDelete(img_elem) {
    if (img_elem) {
        const prev_br = img_elem.previousSibling;
        if (prev_br && prev_br.nodeName === 'BR') {
            prev_br.remove();
        }
        const container = img_elem.closest('.years_empty_text');
        img_elem.remove();

        if (!container) {
            return;
        }

        // aタグ（リンク）を取得
        const link = container.querySelector('a.modalEdit');

        // コンテナ内に、他の画像も、年月日テキストも存在しないことを確認
        if (!link || link.querySelector('.signImg_ymd') !== null || link.querySelector('.js_date_field') !== null) {
            return;
        }
        
        // 条件を満たす場合のみ、新しい年月日テキストを作成して追加する
        const new_text_field = document.createElement('span');
        let era_name = '';
        
        // コンテナが 'data-era-name' 属性を持っているか確認
        if (container.dataset && container.dataset.eraName !== undefined) {
            // 元号がある場合
            era_name = container.dataset.eraName;
            new_text_field.className = 'js_date_field tar';
            new_text_field.innerHTML = `${era_name}&emsp;&emsp;&emsp;年&emsp;&emsp;月&emsp;&emsp;日`;
        } else {
            // 元号がない（または data-era-name 属性がない）場合
            new_text_field.className = 'js_date_field';
            new_text_field.innerHTML = '&emsp;&emsp;&emsp;&emsp;&emsp;年&emsp;&emsp;&emsp;月&emsp;&emsp;&emsp;日';
        }

        // 6. 構造を判別して挿入
        if (link.classList.contains('pull-right')) {
            //  <a> の「前」に挿入
            container.insertBefore(new_text_field, link);
        } else {
            //  <a> の「中」のアイコンの前に挿入
            const edit_icon = link.querySelector('i.fa.print');
            if (edit_icon) {
                link.insertBefore(new_text_field, edit_icon);
            } else {
                link.appendChild(new_text_field);
            }
        }
    }
}

/**
 * サービス提供実績記録票の下部日付表示用
 * @param {string} mode          save || delete
 * @param {string} filename      ファイル.pngの名前
 * 
 * @returns {void}
 */
function changeDateTextState(mode, filename, path) {
    const target_link = $(`a.modalEdit[href*="filename=${filename}"]`);
    if (!target_link.length) {
        // ターゲットが見つからなければ処理を終了
        return;
    }

    if (mode === 'save') {
        const container = target_link.closest('.years_empty_text');
        // 既存の「年月日」テキストがあれば削除
        if (container.length) {
            // 日付サインの時のみ削除
            if (path.date) {
                container.find('.js_date_field').remove();
            }
        } else {
            target_link.find('.js_date_field').remove();
        }
    }
}

/**
 * 上限管理のサインのステータスを更新する
 * @param {int} date_flg 日付サイン判定用
 * @param {void}
 */
function updateNeedSignStatusForUpperLimit(date_flg) {
    const url = '../../wm/payment/ajax/ajax_upper_limit_sign.php';
    const file_name = $('.hidden_file_name').val();

    $.ajax({
        url: url,
        timeout: 3000,
        async: false,
        dataType: 'json',
        data: {
            filename: file_name,
            date_flg: date_flg
        },
        success: function(data) {
            console.log(data);
        },
        error: function (response) {
            alert('通信に失敗しました。');
        }
    });
}

/* --- デジタルサイン用処理終了 --- */

$(document).ready(function(){
    $('.mfp-content', window.parent.document).height($("body").height());
});

$(document).ready(function(){

    var windowResizeTime;
    $(document).on("click", ".modalEdit", (function() {
        //aを取得する
        var link = $(this).attr("href");

        // モバイルの場合、iframeでサインフォームを表示
        if (isMobile() && link.indexOf("mode=sign") != -1) {
            gScrollTop = $(window).scrollTop();
            if (!$('.c_original_body').get(0)) {
                $('body').wrapInner("<div class='c_original_body'/>");
            }
            $('.c_original_body').hide();
            $('.c_sign_form_body').remove();
            var $signFormBody = $("<iframe class='c_sign_form_body' src='" + link + "' width='" + $(window).width() + "' height='" + $(window).height() + "' style='border: 0px solid;'/>");
            $('.c_original_body').after($signFormBody);
            $(window).resize(function () {
                clearTimeout(windowResizeTime);
                windowResizeTime = setTimeout(function () {
                    $('.c_sign_form_body').attr({
                        width: $(window).width(),
                        height: $(window).height()
                    });
                }, 100);
            });
            return false;
        }

        // モーダルの表示
        $.magnificPopup.open(
            {
                items:{src:link},
                type: 'iframe',
                mainClass: 'mfp-fade fbm',
                removalDelay: 0,
                fixedContentPos: true,
                showCloseBtn: true,
                closeBtnInside: true
            }
        );
        return false;
    }));

});

$(document).ready(function(){

    $(document).on("click", ".modalEditDoc", (function() {
        //aを取得する
        var link = $(this).attr("href");
        // モーダルの表示
        $.magnificPopup.open(
            {
                items:{src:link},
                type: 'iframe',
                mainClass: 'mfp-fade fbm',
                removalDelay: 0,
                fixedContentPos: true,
                showCloseBtn: true,
                closeBtnInside: true
            }
        );
        return false;
    }));

});

$(document).ready(function(){
    var win = window.parent;
    $('.modalReload').click(function() {
        // 処理が完了したらモーダルを閉じる
        win.location.reload();
    });

    /** 他施設利用状況管理のモーダル処理 **/
    $('.modalReloadFacilityOther').click(function() {

    if (doCheckCSRF() == 1) {

        var sort = win.$('input:hidden[name="sort"]').val();
        var inputSort = win.$('.tablesorter').find("th:nth-child(1)");

        if (inputSort.hasClass('headerSortDown')){
            sort = 1;
        }else if (inputSort.hasClass("headerSortUp")){
            sort = 2;
        }else if ((!inputSort.hasClass('headerSortDown')) && (!inputSort.hasClass('headerSortUp'))){
            sort = "";
        }

        //POSTメソッドで送るデータを定義します var param = {パラメータ名 : 値};
        var param = {id : $('#id').val(),
                     usage_id : $('#usage_id').val(),
                     o_id : $('#o_id').val(),
                     c_id : $('#name_list').val(),
                     total_cost : $('#total_cost').val(),
                     user_charge : $('#user_charge').val(),
                     sort : sort
                    };


        // チェック処理実行
        result = doFacilityOtherUsage(param);

        // 処理が完了したらモーダルを閉じる
        if (!result) {
            // 「再送信しますか？」が出ない方法
            win.location.assign(win.location);
          // win.location.reload();
        }
    }else{
        $(".dialogMsg").click();
        return false;
    }

    });

    /** 他施設利用状況管理のモーダル処理 **/
    $('.modalReloadMirrorFacilityOther').click(function() {

    if (doCheckCSRF() == 1) {

        //POSTメソッドで送るデータを定義します var param = {パラメータ名 : 値};
        var param = {id : $('#id').val(),
            usage_id : $('#usage_id').val(),
            o_id : $('#o_id').val(),
            c_id : $('#name_list').val(),
            total_cost : $('#total_cost').val(),
            user_charge : $('#user_charge').val(),
        };


        // チェック処理実行
        result = doMirrorFacilityOtherUsage(param);


        // 処理が完了したらモーダルを閉じる
        if (!result) {
            // 「再送信しますか？」が出ない方法
            win.location.assign(win.location);
            // win.location.reload();
        }
    }else{
        $(".dialogMsg").click();
        return false;
    }
    });

    /** 実費負担実績表のモーダル処理 **/
    $('.modalManagement').click(function() {
        //POSTメソッドで送るデータを定義します var param = {パラメータ名 : 値};
        let param;
        if (doCheckCSRF() == 1) {
        param = {id : $('#id').val(),
            management_id : $('#management_id').val(),
            c_id : $('#name_list').val(),
            f_id : $('#f_id').val(),
            date : $('#date').val(),
            cost : $('#cost').val(),
            reduced_tax_rate_flg : $('#reduced_tax_rate_flg').val(),
            services : $('[name="services"]').val()};

        // チェック処理実行
        result = doManagement(param);
        // 処理が完了したらモーダルを閉じる
        if (!result) {
            // 「再送信しますか？」が出ない方法
            win.location.assign(win.location);
            // win.location.reload();
        }
    }else{
        $(".dialogMsg").click();
        return false;
    }
    });

    /** 実費負担実績表のモーダルで追加できる児童がいない時の処理 **/
    $('.modalManagementNoChild').click(function() {
        win.location.assign(win.location);
    });

    /** 新規支給決定の対象児童を選択のモーダル処理 **/
    // $('.modalPaymentDifference').click(function() {
    //
    //     //POSTメソッドで送るデータを定義します var param = {パラメータ名 : 値};
    //     var form = new Object();
    //
    //     console.log(window.parent.document);
    //
    //     $(".ebox-content input:hidden",window.parent.document).each(function () {
    //         form[this.name] = this.value;
    //
    //     });
    //
    //     //チェックされた値
    //     $(".ebox-content input:checked",window.parent.document).each(function () {
    //         form[this.name]=this.value;
    //     });
    //
    //
    //     // var param = {id : $('#id').val(),
    //     //     management_id : $('#management_id').val(),
    //     //     c_id : $('#name_list').val(),
    //     //     f_id : $('#f_id').val(),
    //     //     date : $('#date').val(),
    //     //     cost : $('#cost').val()};
    //
    //     // チェック処理実行
    //     result = doPaymentDifference(form);
    //     // 処理が完了したらモーダルを閉じる
    //     if (!result) {
    //         // 「再送信しますか？」が出ない方法
    //         win.location.assign(win.location);
    //         // win.location.reload();
    //     }
    // });

    $('.modalClose').click(function() {
        parent.close();
    });
});

// 高さ・幅調整
$(document).ready(function(){
  $('.mfp-iframe-scaler', window.parent.document).height(document.body.scrollHeight);
  $('.mfp-content', window.parent.document).width($('.modalRow').width());
});

$(function() {
    $(document).on("click", ".modalPaymentDifference", (function() {
        if (doCheckCSRF() == 1) {
            //POSTメソッドで送るデータを定義します var param = {パラメータ名 : 値};
            var obj = new Object();

            $(".ebox-content input:hidden", window.document).each(function () {
                obj[this.name] = this.value;
            });

            //チェックされた値
            $(".ebox-content input:checked", window.document).each(function () {
                obj[this.name] = this.value;
            });

            // チェック処理実行
            result = doPaymentDifference(obj);
            if (!result) {
                var win = window.parent;

                // 「再送信しますか？」が出ない方法
                win.location.assign(win.location);
                win.location.reload();
            }
        }
    }));
});


///////////////////////////////////////////////////////////////////////////
//
//  checkFacilityOtherUsage(param)   他施設利用状況管理　登録処理  
//
/////////////////////////////////////////////////////////////////////// */
function doFacilityOtherUsage(param){
    var url = "./ajax/ajax_facility_other_usage.php";
    var result = 0;

    // 他施設利用状況の更新
    $.ajax({
      url: url,
      data: param,
      timeout: 3000,
      async:false,
      dataType: 'json',
      success: function(data, status, xhr) {
        // //新しい値をセット
        if (data) {
            //エラーの配列が返ってこない場合は、重複防止のため保存ボタンを非活性にする
            if(data.length == 0) {
                $('.modalReloadFacilityOther').prop("disabled",true);
            }
            // 値のクリア
            document.getElementById("err1").innerText = "";
            document.getElementById("err2").innerText = "";
            document.getElementById("err3").innerText = "";

            // 戻ってきたエラーを表示
            Object.keys(data).forEach(function (key) {
                var val = this[key];
                // $("labelName1ID").html("文字が書き変わります");
                document.getElementById("err" + key).innerText = "▼" + val;
                result = 1;
            }, data);
        }
      },
      error: function () {
        alert("通信に失敗しました。");
      }

    });


    return result;

}

///////////////////////////////////////////////////////////////////////////
//
//  checkFacilityOtherUsage(param)   他施設利用状況管理　登録処理
//
/////////////////////////////////////////////////////////////////////// */
function doManagement(param){
    var url = "./ajax/ajax_actual_cost_management.php";
    var result = 0;

    $("#err1").html("");
    $("#err2").html("");

    // 他施設利用状況の更新
    $.ajax({
        url: url,
        data: param,
        timeout: 3000,
        async:false,
        dataType: 'json',
        success: function(data, status, xhr) {
            // //新しい値をセット
            if (data.err1) {
                $("#err1").prepend(data.err1);
                result = 1;
            }
            if (data.err2) {
                $("#err2").prepend(data.err2);
                result = 1;
            }

            //エラーの配列が返ってこない場合は、重複防止のため保存ボタンを非活性にする
            if(!data.err1 && !data.err2) {
                $('.modalManagement').prop("disabled",true);
            }

        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });

    return result;
}

///////////////////////////////////////////////////////////////////////////
//
//  checkFacilityOtherUsage(param)   他施設利用状況管理　登録処理
//
/////////////////////////////////////////////////////////////////////// */
function doMirrorFacilityOtherUsage(param){
    var url = "./ajax/ajax_mirror_facility_other_usage.php";
    var result = 0;

    // 他施設利用状況の更新
    $.ajax({
        url: url,
        data: param,
        timeout: 3000,
        async:false,
        dataType: 'json',
        success: function(data, status, xhr) {
            // //新しい値をセット
            if (data) {
                //エラーの配列が返ってこない場合は、重複防止のため保存ボタンを非活性にする
                if(data.length == 0) {
                    $('.modalReloadMirrorFacilityOther').prop("disabled",true);
                }

                // 値のクリア
                document.getElementById("err1").innerText = "";
                document.getElementById("err2").innerText = "";
                document.getElementById("err3").innerText = "";

                // 戻ってきたエラーを表示
                Object.keys(data).forEach(function (key) {
                    var val = this[key];
                    // $("labelName1ID").html("文字が書き変わります");
                    document.getElementById("err" + key).innerText = "▼" + val;
                    result = 1;
                }, data);
            }
        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });

    return result;
}

///////////////////////////////////////////////////////////////////////////
//
//  checkFacilityOtherUsage(param)   新規支給決定の対象児童　登録処理
//
/////////////////////////////////////////////////////////////////////// */
function doPaymentDifference(obj){
    var url = "./ajax/ajax_payment_difference.php";
    var result = 0;
    var city_code = $('[name=city_code]').val();
    var date = $('[name=date]').val();
    var f_id = $('[name=f_id]').val();
    // 新規支給決定の対象児童を選択
    $.ajax({
        url: url,
        data:{
            "obj":obj
        },
        type : "POST",
        timeout: 3000,
        async:false,
        dataType: 'json',
        success: function(data, status, xhr) {
            if (data) {

                $.ajax({
                    type: 'GET',
                    url: './payment-difference.php?date='+date+'&f_id='+f_id,
                    success: function(data2) {
                        //内訳のみをロードする
                        $('.js_toggle_area'+city_code+' .tableSpInner', window.parent.document).html($(data2).find('.js_toggle_area'+city_code+' .tableSpInner').html());
                        //モーダルを閉じる
                        $('.mfp-bg', window.parent.document).trigger('click');
                        return false;

                    }
                });

            }
        },
        error: function () {
            alert("通信に失敗しました。");
        }
    });

    return result;
}