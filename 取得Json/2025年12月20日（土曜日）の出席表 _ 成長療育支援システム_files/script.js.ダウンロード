/*
このページのトップへ
-----------------------------------------------*/
var prePath = getPrePath();
$(function () {
    var topBtn = $('#toTop p span');
    //スクロールしてトップに戻る
    //500の数字を大きくするとスクロール速度が遅くなる
    topBtn.click(function () {
        $('body,html').animate({
            scrollTop: 0
        }, 500);
        //}, 0);
        return false;
    });
});
// 請求エラーの表示
$(function () {
    $('.js_acordion_close').hide();
    $(document).on("click", ".js_acordion_setting", (function () {
        $(this).closest('.caution-box').find('.js_acordion_close').fadeToggle(200);
        $(this).find(".fa-caret-down").toggleClass('up');
    }));
});
/*
TEL
----------------------------------------------- */
$(function () {
    var ua = navigator.userAgent;
    if (ua.indexOf('iPhone') > 0 || ua.indexOf('Android') > 0) {
        $('.tel-link').each(function () {
            if ($(this).is('img')) {
                var str = $(this).attr('alt');
                $(this).wrap('<a href="tel:' + str.replace(/-/g, '') + '"></a>');
            } else {
                var str = $(this).text();
                $(this).replaceWith('<a href="tel:' + str.replace(/-/g, '') + '">' + str + '</a>');
            }
        });
    }
});
/*
メニューボタン
-----------------------------------------------*/
/*
$(function() {
  $("#panel-btn").click(function() {
    $("#panel").slideToggle(200);
    $("#panel-btn-icon").toggleClass("close");
    return false;
  });
});
$(window).resize(function(){
    var w = $(window).width();
    if( w >= 769) {
        $("#panel").css("display" , "table");
        $("#panel-btn-icon").removeClass("close");
    } else {
        $("#panel").css("display" , "none");
    }
});
*/
function CheckAll(checked) {
    len = document.form1.elements.length;
    var i;
    for (i = 0; i < len; i++) {
        if (document.form1.elements[i].name == 'id[]') {
            document.form1.elements[i].checked = checked;
        }
    }
}
/*
クリック時にダイアログボックスを表示
-----------------------------------------------*/
$(function () {
    $('.dialog').click(function () {
        // value属性の値をダイアログメッセージとして表示する
        var dialogMsg = $(this).attr('value');
        dialogRes = confirm(dialogMsg);
        if (dialogRes == false) {
            return false;
        }
    });
});
/*
２度押し防止
-----------------------------------------------*/
function submitonce(theform) {
    if (document.all || document.getElementById) {
        for (i = 0; i < theform.length; i++) {
            var tempobj = theform.elements[i];
            if (tempobj.type) { // この辺が新しい
                if (tempobj.type.toLowerCase() == "submit" || tempobj.type.toLowerCase() == "reset") {
                    tempobj.disabled = true;
                }
            } // この辺が新しい
        }
    }
}
/*
buttonに設定されているvalue値をPOST
-----------------------------------------------*/
function setHiddenValue(button) {
    if (button.name) {
        var q = document.createElement('input');
        q.type = 'hidden';
        q.name = button.name;
        q.value = button.value;
        button.form.appendChild(q);
    }
}
/*
global nav
----------------------------------------------- */
$(function () {
    // まずウインドウの横幅を変数に入れる
    var timer = false;
    var winWidth = window.innerWidth ? window.innerWidth : $(window).width(); //デバイス（ウィンドウ）幅を取得
    var winWidth_resized;
    $(window).on("load", function () {
        if (winWidth >= 1025) {
            menuOpen();
        }
    });
    // ウインドウのリサイズイベントに処理をバインド
    $(window).on("resize", function () {
        // リサイズ後の放置時間が指定ミリ秒以下なら何もしない(リサイズ中に何度も処理が行われるのを防ぐ)
        if (timer !== false) {
            clearTimeout(timer);
        }
        // 放置時間が指定ミリ秒以上なので処理を実行
        timer = setTimeout(function () {
            // リサイズ後のウインドウの横幅を取得
            winWidth_resized = window.innerWidth;
            // リサイズ前のウインドウ幅とリサイズ後のウインドウ幅が異なる場合
            if (winWidth != winWidth_resized) {
                // ここにやりたい処理書く
                // console.log("ウインドウ横幅のリサイズ");
                // console.log("現在の横幅: ", winWidth);
                // console.log("リサイズ後の横幅: ", winWidth_resized);
                if (winWidth > 1025 && winWidth_resized <= 1024) {
                    // console.log("PC スマホ");
                    $('#panel').css('display', 'none');
                } else if (winWidth <= 1024 && winWidth_resized <= 1024) {
                    // console.log("スマホ スマホ");
                } else if (winWidth <= 1024 && winWidth_resized >= 1025) {
                    // console.log("スマホ PC");
                    $('#panel').css("display", "block");
                    $('.navInner').css('overflow', 'visible');
                    $('#panel li ul').css("display", "none");
                    menuOpen();
                } else if (winWidth > 1025 && winWidth_resized > 1025) {
                    // console.log("PC PC");
                    $('#panel li ul').css("display", "none");
                    menuOpen();
                }
                // 次回以降使えるようにリサイズ後の幅をウインドウ幅に設定する
                winWidth = window.innerWidth;
            }
        }, 100);
    });
    function menuOpen() {
        $('.navList').hover(function () {
            if (winWidth > 1024) {
                $("ul:not(:animated)", this).slideDown("fast");
                $(this).addClass("current");
            }
        }, function () {
            if (winWidth > 1024) {
                $("ul", this).slideUp("fast");
                $(this).removeClass("current");
            }
        });
        $('.navL').hover(function () {
            if (winWidth > 1024) {
                $(".navLBox:not(:animated)", this).slideDown("fast");
                $(this).addClass("current");
            }
        }, function () {
            if (winWidth > 1024) {
                $(".navLBox", this).slideUp("fast");
                $(this).removeClass("current");
            }
        });
    }
});
/*
メニューボタン
-----------------------------------------------*/
$(function () {
    $("#panel-btn").click(function () {
        $("#panel").slideToggle(200);
        $("#panel-btn-icon").toggleClass("close");
        $('#panel li ul').css("display", "block");
        return false;
    });
});
/*
テーブルソート機能
-----------------------------------------------*/
$(function () {
    $('.sortTable01').tablesorter({
        widgets: ['zebra']
    });
    $('.sortTable02').tablesorter({
        widgets: ['zebra']
    });
    $('.sortTable03').tablesorter({});
    $('.sortTable04').tablesorter({
        headers: {
            0: { sorter: false }
        }
    });
});
// 児童名を選択したときの「ケア記録・生活記録の一覧を表示」ボタンの活性・非活性
$(function () {
    selectName();
    $('.selectName').change(function () {
        selectName();
    })
    function selectName() {
        $('.selectName').each(function () {
            var selectVal = $(this).children('option:selected').val();
            if (selectVal != 0) {
                $('.btn-sm#contactBookList').removeClass('disable');
            } else {
                $('.btn-sm#contactBookList').addClass('disable');
            }
            return false;
        });
    }
});
// 関数
// チェックボックスをチェックした時のテーブルの行の表示・非表示関数
function checkedTrToggle(check, showElm) {
    var checked = $(check).prop('checked');
    if (checked == false) {
        $(showElm).hide();
    }
    $(check).on('click', function () {
        console.log(checked);
        var checked = $(this).prop('checked');
        if (checked == true) {
            $(showElm).show();
        } else {
            $(showElm).hide();
        }
    });
}
/*
formがsubmitされたときに「保存しました」を表示する
----------------------------------------------- */
$(function () {
    var $form = $('.formSaveJS');
    $form.submit(function (e) {
        // 同じ処理が二度走らないように、submitイベントをoff
        $form.off('submit');
        // 保存アニメーションを実行してからsubmit
        $('.formSaveComment01').css('display', 'block').animate({
            'opacity': '1'
        }, 200, function () {
            // 保存アニメーション後すぐに遷移すると違和感があるので遅延させる
            setTimeout(function () {
                $form.submit();
            }, 400);
        });
        // 自動でsubmitされないように処理を止める
        return false;
    });
});
// ヘルプ 動画マニュアル
$(function () {
    $('.openWindow').on('click', function () {
        var title = $(this).text();
        var link = this.href;

        //保存
        var url = prePath + "ajax/ajax_setpdfview.php";
        $.ajax({
            url: url,
            data: {
                "title": title,
                "link": link
            },
            timeout: 3000,
            async: false,
            dataType: 'json',
            success: function (data) {

            }
        });

        var width = $(this).attr('data-width');
        window.open(this.href, 'windowName', 'width=' + width + ', height=720,resizable=yes,scrollbars=yes');
        return false;
    });
});
// hug-srss.com側で処理する
$(function () {
    $('.addHugFacility a').on('click', function () {
        window.open("", "addfacilitypopup", 'width=500, height=720,resizable=yes,scrollbars=yes');
        document.addfacilitypopup.action = "https://www.hug-srss.com/hug-addfacility-form.php";
        document.addfacilitypopup.target = "addfacilitypopup";
        document.addfacilitypopup.chk_pass.value = "16d8ea4f562859f1230e40dd9c55d6894c05c2c8";
        document.addfacilitypopup.submit();
        return false;
    });
});
// 高さを揃える関数
function matchHeightJS(elm) {
    $(elm).matchHeight();
}
// もし、v-calendarの幅より内包するtableが広かったら横スクロールを出す関数
function scrollBox(elm) {
    var $elm = $(elm);
    var calW = $elm.width();
    var tableW = $elm.children('table').width();
    if (tableW >= calW) {
        $elm.addClass('overScroll');
    }
}
// ヘルプとよくある質問にサイトごとのキャンペーンURLを設置する
$(function () {
    // キャンペーンURL作成用にホストを取得
    host = location.host;
    // URLに「www」がなかったら「www」を付与する
    if (host.indexOf('www') == -1) {
        host = 'www.' + host;
    }
    // ヘルプとよくあるご質問のリンクにホスト名のキャンペーンを足す
    $('.campaignUrlAdd').each(function () {
        var obj = $(this);
        var link = obj.attr('href');
        // URLに「#」があると正常に動かないための出力分け
        if (link.indexOf('#') != -1) {
            var queryParam = '&';
        } else {
            var queryParam = '?';
        }
        obj.attr('href', link + queryParam + 'utm_source=' + host + '&utm_medium=hug');
    });
});
/*
タブ切り替え
-----------------------------------------------*/
$(function () {
    // タブ切り替えの要素があるか確認
    var isTab = $('.tabList');
    // タブ切り替えの要素があった場合
    if (isTab.is('.tabList')) {
        // タブをクリックしたら切り替え
        $('.tabList a').on('click', function () {
            // 飛び先のハッシュを取得
            var link = $(this).attr('href');
            // タブ切り替え
            $('.tabList a').removeClass('on');
            $(this).addClass('on');
            // テーブル切り替え
            $('.tabArea').removeClass('visible');
            $(link).addClass('visible');
            // タブをクリックしたときにリンクを無効化
            return false;
        });
    }
});
/*
emergency
-----------------------------------------------*/
$(function () {
    $('.paymentFlowFixedInner,.emergencyTxt').removeClass('fixed');
    $(window).scroll(function () {
        var now = $(window).scrollTop();
        if (now > 300) {
            $('.paymentFlowFixedInner,.emergencyTxt').stop().addClass('fixed');
        } else {
            $('.paymentFlowFixedInner,.emergencyTxt').stop().removeClass('fixed');
        }
    });
});
/*
tdLabel check
----------------------------------------------- */
$(function () {
    if ($('.tdLabel').length) {
        $('.tdLabel').each(function () {
            var h = $(this).parent('td').outerHeight();
            $(this).height(h);
        });
    }
});
//テンプレートから直接submit用処理
$(function () {
    $(document).on("click", ".js_token_form", (function () {

        $(this).prop("disabled", true);
        var mode = $('#mode_token').val();
        var token = $('#csrf_token_from_client').val();
        var hug_page_url = $('#hug_page_url').val();
        var formObj = $(this).closest('form');
        if ($('.pocco_flg').val() == 1) {
            var url = "../ajax/ajax_token.php" + "?token=" + token + "&mode=" + mode + "&hug_page_url=" + hug_page_url;
        } else {
            var url = prePath + "ajax/ajax_token.php" + "?token=" + token + "&mode=" + mode + "&hug_page_url=" + hug_page_url;
        }
        $.get(url, function (data) {
            if (data == 1) {
                $(formObj).submit();
            } else {
                $(".dialogMsg").click();
                return false;
            }
        });
    }));
});
//js側でのsubmit用トークンチェック処理
function doCheckCSRF() {
    var mode = $('#mode_token').val();
    var token = $('#csrf_token_from_client').val();
    var hug_page_url = $('#hug_page_url').val();
    var url = prePath + "ajax/ajax_token.php" + "?token=" + token + "&mode=" + mode + "&hug_page_url=" + hug_page_url;
    var result = $.ajax({
        type: 'GET',
        url: url,
        async: false
    }).responseText;
    return result;
}

//enter押すと、ボタンクリックさせる
$(function () {
    //pageを取得しておく
    tager_page_name = "";
    //現在のページを取得する
    tager_page_name = window.location.href.split('/').pop();
    tager_page_name = tager_page_name.substring(0, tager_page_name.indexOf("."));
    $('input').keypress(function (e) {
        if (e.which == 13) {
            if (tager_page_name == "event") {
                return false;
            } else {
                e.preventDefault();
                if ($(".js_token_form").length) {
                    $(".js_token_form").trigger("click");
                } else {
                    $(".search").trigger("click");
                }
            }
        }
    });
});

// すべてチェック・すべて解除
$(function () {
    //すべてチェックすべて解除改変版
    $('.js_checkAll').on('click', function () {

        var check_val = $(this).data('check');

        if (check_val == 1) {
            $(".js_checkall_table").find("input[type='checkbox']").prop('checked', true);
            $('.js_checkall_table tr').addClass('highlight');

        } else {
            $(".js_checkall_table").find("input[type='checkbox']").prop('checked', false);
            $('.js_checkall_table tr').removeClass('highlight');
        }

        setCountChecked();
    });
    // テーブルのチェックを選択したときに黄色にするもの
    $('.js_solo_check').on('click', function () {
        // closest() を使用して、最も近い親の tr 要素を取得
        var $tr = $(this).closest('tr');

        // このチェックボックスがチェックされているか確認
        if ($(this).is(':checked')) {
            // チェックされている場合、highlight クラスを追加
            $tr.addClass('highlight');
        } else {
            // チェックされていない場合、highlight クラスを削除
            $tr.removeClass('highlight');
        }

        setCountChecked();
    });



    $('.js_checkAll_new').on('click', function () {

        var check_val = $(this).data('check');

        if (check_val == 1) {
            $("input[type='checkbox']", $(this).closest('form')).prop('checked', true);
            $('.carePrintAll tr').addClass('highlight');
        } else {
            $("input[type='checkbox']", $(this).closest('form')).prop('checked', false);
            $('.carePrintAll tr').removeClass('highlight');
        }

        // 印刷ボタン、出力人数表示
        setCountChecked();
    });


    //
    $('.js_check_sheet').on('click', function () {

        if ($(this).prop('checked')) {
            $(this).closest('tr').addClass('highlight');
        } else {
            $(this).closest('tr').removeClass('highlight');
        }

        // 印刷ボタン、出力人数表示
        setCountChecked();
    });
});


// 印刷ボタン、出力人数表示
function setCountChecked() {

    //児童数を取得して出力
    var cnt1 = $(".js_check_sheet:checked:visible").size();

    if (cnt1) {
        $(".waitBtn, .printing").removeClass('disable');
    } else {
        $(".waitBtn, .printing").addClass('disable');
    }

    $(".sumcheck").text(cnt1);
}

/*請求用のパス変更----------------------------------------------- */
function getPrePath() {
    var pathname = $(location).attr('pathname');

    if (pathname.match('/payment_upgrade/') || pathname.match('/payment/') || pathname.match('/individual/')) {
        var prePath = "../";
    } else {
        var prePath = "./";
    }
    return prePath;
}
/*請求用のパス変更----------------------------------------------- */
$(function () {
    $('[data-js_toggleCont]').each(function () {
        var $this = $(this);
        if ($this.attr('data-js_toggleCont') === 'open') {
            $this.slideDown();
        } else {
            $this.hide();
        }
    });
    $('[data-js_toggleBtn]').on('click', function () {
        // 一番近くにある data-js_toggleCont 要素を取得し、表示切り替え
        $(this).closest('[data-js_toggleBtn]').next('[data-js_toggleCont]').slideToggle();
    });


});


//個別支援計画原案、本案の操作オプションの別表利用開始日の表示・非表示の制御
$(document).on("click", "[name=individual_display_ledger\\[other_tables\\]]", (function () {

    if ($(this).prop('checked')) {
        $(this).closest('div').find('span').show();
    } else {
        $(this).closest('div').find('span').hide();
    }
}));

//ダイアログタグでの実装
document.addEventListener('DOMContentLoaded', function () {
    const openTriggers = document.querySelectorAll('[data-modal-open]');
    const closeTriggers = document.querySelectorAll('[data-modal-close]');
    let scrollPosition = 0;

    openTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            const modalId = trigger.getAttribute('data-modal-open');
            const modal = document.getElementById(modalId);
            scrollPosition = window.pageYOffset;
            document.body.style.top = `-${scrollPosition}px`;
            document.body.style.position = 'fixed';
            modal.showModal();
        });
    });

    closeTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            const modal = trigger.closest('dialog');
            modal.close();
            document.body.style.position = '';
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        });
    });

    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (event) => {
            const rect = dialog.getBoundingClientRect();
            if (
                event.clientX < rect.left ||
                event.clientX > rect.right ||
                event.clientY < rect.top ||
                event.clientY > rect.bottom
            ) {
                dialog.close();
                document.body.style.position = '';
                document.body.style.top = '';
                window.scrollTo(0, scrollPosition);
            }
        });
    });
});

document.addEventListener("DOMContentLoaded", function () {
    // data-modal属性を持つ全てのボタンにクリックイベントを追加
    document.querySelectorAll("[data-modal]").forEach(button => {
        button.addEventListener("click", function () {
            const modalId = this.getAttribute("data-modal");
            const dialog = document.getElementById(modalId);

            // ダイアログが存在する場合表示する
            if (dialog) {

                dialog.showModal();

                // ダイアログの中のセレクトボックスの幅を調整する処理
                $('.uiSelectBtn').each(function () {
                    
                    var selectListWidth = $(this).siblings('.uiSelectList').outerWidth();
                        
                    //非表示のボタンwidthが０になっているので、それを調整する処理
                    if (selectListWidth == 0) {
                        selectListWidth = $(this).closest('tr').prev().find('.uiSelectBtn').width();
                    }
                    $(this).width(selectListWidth);
                    $(this).siblings('.uiSelectList').width(selectListWidth + 15);
                });

                // ダイアログが開かれたときにhtmlにdialog-openクラスを追加
                document.documentElement.classList.add("dialog-open");

                // 閉じるボタンの処理
                const closeButton = dialog.querySelector(".close");
                if (closeButton) {
                    closeButton.addEventListener("click", function () {
                        dialog.close();
                    });
                }

                // cancelボタンの処理
                const cancelButton = dialog.querySelector(".cancel");
                if (cancelButton) {
                    cancelButton.addEventListener("click", function () {
                        dialog.close();
                    });
                }

                // 背景クリックで閉じる処理
                dialog.addEventListener("click", function (event) {
                    // `noCloseBg` クラスがない場合のみ、背景クリックで閉じる
                    if (!dialog.classList.contains("noCloseBg") && event.target === dialog) {
                        dialog.close();
                    }
                });

                // ダイアログが閉じられたときにhtmlからdialog-openクラスを削除
                dialog.addEventListener("close", function () {
                    document.documentElement.classList.remove("dialog-open");
                });
            }
        });
    });
});
