<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hug Client</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
    }
    #toolbar {
      background: #333;
      color: white;
      padding: 8px;
      flex: 0 0 auto; /* é«˜ã•å›ºå®š */
    }
    #tabs {
      background: #555;
      padding: 4px;
      flex: 0 0 auto; /* é«˜ã•å›ºå®š */
    }
    #content {
      position: relative;
      flex: 1 1 auto;  /* æ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
      overflow: hidden;
    }
    #hugview, #settings {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .hidden {
      visibility: hidden;
      pointer-events: none;
    }

  </style>
</head>
<body>
  <div id="toolbar">
    <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
    <button id="loginBtn">âš™ï¸ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="professional-support">å°‚é–€çš„æ”¯æ´-ä¸€è¦§</button>
    <button id="professional-support-new">å°‚é–€çš„æ”¯æ´-æ–°è¦</button>
  </div>
  <div id="tabs">
    <button data-target="hugview">Hug</button>
    <button data-target="settings">è¨­å®š</button>
  </div>

  <div id="content">
    <webview id="hugview" src="https://www.hug-ayumu.link/hug/wm/" allowpopups></webview>
    <div id="settings"></div>
  </div>

  <script>
    const hugview = document.getElementById("hugview");

    document.getElementById("refreshBtn").addEventListener("click", () => {
      hugview.reload();
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const { username, password } = await window.electronAPI.getEnv();
      hugview.executeJavaScript(`
        document.querySelector('input[name="username"]').value = ${JSON.stringify(username)};
        document.querySelector('input[name="password"]').value = ${JSON.stringify(password)};
        const checkbox = document.querySelector('input[name="setexpire"]');
        if (checkbox && !checkbox.checked) checkbox.click();
        document.querySelector("input.btn-login")?.click();
      `);
    });

    document.getElementById("professional-support").addEventListener("click", () => {
      hugview.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php");
    });

    document.getElementById("professional-support-new").addEventListener("click", () => {
      hugview.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php?mode=edit");
      // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ option ã‚’é¸æŠ
      hugview.addEventListener("did-finish-load", () => {
        hugview.executeJavaScript(`
          // å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—
          const selectSupport = document.querySelector('select[name="adding_children_id"]');
          if (selectSupport) {
            selectSupport.value = "55";
            selectSupport.dispatchEvent(new Event("change", { bubbles: true }));
            console.log("âœ… å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’é¸æŠ");
          }

          // å­ã©ã‚‚ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼šå²¡ç”° ç£¨å’Œ â†’ value="49"ï¼‰
          const selectChild = document.querySelector('select[name="c_id_list[0][id]"]');
          if (selectChild) {
            selectChild.value = "49";
            selectChild.dispatchEvent(new Event("change", { bubbles: true }));
            console.log("âœ… å­ã©ã‚‚ãƒªã‚¹ãƒˆã§å²¡ç”°ç£¨å’Œã‚’é¸æŠ");
          }

          // è¨˜éŒ²è€…ï¼ˆä¾‹ï¼šæ±å±± â†’ value="73"ï¼‰
          const selectRecorder = document.querySelector('select[name="recorder"]');
          if (selectRecorder) {
            selectRecorder.value = "73";
            selectRecorder.dispatchEvent(new Event("change", { bubbles: true }));
            console.log("âœ… è¨˜éŒ²è€…ã‚’ã²ãŒã—ã‚„ã¾ã«é¸æŠ");
          }
          const interviewSelect = document.querySelector('select[name="interview_staff[]"]');
          if (interviewSelect) {
            interviewSelect.value = "73"; // æ±å±± å‹è¼”
            interviewSelect.dispatchEvent(new Event("change", { bubbles: true }));
            console.log("âœ… é¢æ¥æ‹…å½“ã‚’é¸æŠ:", interviewSelect.value);
          }

          // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé …ç›®ã®ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›
          const customizeInput = document.querySelector('input[name="customize[title][]"]');
          if (customizeInput) {
            customizeInput.value = "è¨˜éŒ²";
            customizeInput.dispatchEvent(new Event("input", { bubbles: true }));
            console.log("âœ… ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›:", customizeInput.value);
          }
        `);
      }, { once: true }); // â† ä¸€åº¦ã ã‘å®Ÿè¡Œ
    });


    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const tabs = document.querySelectorAll("#tabs button");
    const hugviewEl = document.getElementById("hugview");
    const settingsEl = document.getElementById("settings");

    // â­ åˆæœŸçŠ¶æ…‹ã§ Settings ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    settingsEl.classList.add("hidden");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        if (tab.dataset.target === "hugview") {
          hugviewEl.classList.remove("hidden");
          settingsEl.classList.add("hidden");
        } else {
          hugviewEl.classList.add("hidden");
          settingsEl.classList.remove("hidden");
        }
      });
    });

    // è¨­å®šãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§åŸ‹ã‚è¾¼ã‚€
    fetch("settings.html")
      .then(res => res.text())
      .then(html => {
        settingsEl.innerHTML = html;
        settingsEl.classList.add("hidden");
        console.log("âœ… settings.html ã‚’èª­ã¿è¾¼ã‚“ã ");

        // ğŸ’¡ ã“ã“ã§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã™ã‚‹
        const btn = settingsEl.querySelector("#loadStaffBtn");
        const staffList = settingsEl.querySelector("#staffList");

        btn.addEventListener("click", async () => {
          console.log("âœ… ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«");
          try {
            const staff = await window.electronAPI.fetchStaff();
            console.log("âœ… APIã‹ã‚‰å–å¾—:", staff);

            staffList.innerHTML = "";
            staff.forEach(s => {
              const li = document.createElement("li");
              li.textContent = `${s.id}: ${s.name}`;
              staffList.appendChild(li);
            });
          } catch (err) {
            console.error("âŒ ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          }
        });
      });


  </script>
</body>
</html>
