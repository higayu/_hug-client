<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hug Client</title>
<style>
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #toolbar {
    background: #333;
    color: white;
    padding: 8px;
    flex: 0 0 auto;
  }
  #tabs {
    background: #555;
    padding: 4px;
    flex: 0 0 auto;
  }
  #tabs button.active-tab {
    background: linear-gradient(180deg, #b3e5fc, #4fc3f7);
    color: #000;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  #tabs button {
    margin-right: 4px;
    padding: 4px 10px;
    border: none;
    cursor: pointer;
    background: #777;
    color: white;
    border-radius: 4px;
  }
  /* 🌟 アクティブタブの見た目 */
  #tabs button.active-tab {
    background: #4fc3f7;
    color: #000;
    font-weight: bold;
  }
  #content {
    position: relative;
    flex: 1 1 auto;
    overflow: hidden;
  }
  #hugview{
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
  .hidden {
    visibility: hidden;
    pointer-events: none;
  }
  .close-btn {
    color: red;
    cursor: pointer;
    margin-left: 6px;
    font-weight: bold;
  }
  .close-btn.hidden {
    display: none;
  }
  /* ✅ シンプルなスイッチスタイル */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
    margin-left: 8px;
    vertical-align: middle;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    border-radius: 22px;
    transition: 0.3s;
  }

  .slider::before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
  }

  /* ON状態 */
  .toggle-switch input:checked + .slider {
    background-color: #4fc3f7;
  }

  .toggle-switch input:checked + .slider::before {
    transform: translateX(18px);
  }

      /* 🌟 サイドバーとしての設定パネル */
    #content {
      position: relative;
      display: flex;
      height: 100%;
      overflow: hidden;
    }


/* 左サイドバー */
#settings {
  width: 280px;
  background: #f8f8f8;
  border-right: 1px solid #ccc;
  padding: 15px;
  position: absolute;
  top: 0;
  left: 0;
  transform: translateX(-100%); /* ← 初期は完全に左に隠す */
  height: 100%;
  box-shadow: 2px 0 8px rgba(0,0,0,0.1);
  transition: transform 0.3s ease; /* ← 左右移動をスムーズに */
  overflow-y: auto;
  z-index: 50; /* ← webview より上にする */
}

/* 開いた状態 */
#settings.open {
  transform: translateX(0); /* ← スライドイン */
}

/* メイン画面（webview） */
#hugview {
  flex: 1;
  width: 100%;
  height: 100%;
  border: none;
  transition: margin-left 0.3s ease;
  position: relative;
  z-index: 1;
}

/* サイドバー開時に右にずらす */
#hugview.shifted {
  margin-left: 280px;
}


/* ハンバーガーボタン */
.hamburger {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  margin-right: 8px;
  transition: transform 0.2s;
}
.hamburger:hover {
  transform: scale(1.1);
}


</style>

</head>
<body>
  <div id="toolbar">
    <!-- 🌟 ハンバーガーメニュー -->
    <button id="menuToggle" class="hamburger">☰</button>
    <button id="refreshBtn">🔄 更新</button>
    <button id="loginBtn">⚙️ 自動ログイン</button>

    <!-- 🌟 施設選択セレクトボックス -->
    <label for="facilitySelect" style="margin-left:10px;">施設:</label>
    <select id="facilitySelect" name="c_id_list[49][f_id]" class="js_c_f_id">
      <option value="3" selected>PD吉島</option>
      <option value="6">PD光</option>
      <option value="7">PD横川</option>
      <option value="8">PD五日市駅前</option>
    </select>

    <button id="professional-support">専門的支援-一覧</button>
    <button id="professional-support-new">専門的支援-新規</button>

      <!-- 🌟 閉じるボタン表示ON/OFF トグル -->
    <label class="toggle-switch" title="閉じるボタン表示トグル">
      <input type="checkbox" id="closeToggle" checked>
      <span class="slider"></span>
    </label>

    <button id="Individual_Support_Button">個別支援-計画</button>
    <button id="Specialized-Support-Plan">専門的支援-計画</button>
    <button id="Import-Setting">設定ファイルの取得</button>
  </div>

  <div id="tabs">
    <button data-target="hugview">Hug</button>
  </div>

  <div id="content">
    <!-- 左サイドバー -->
    <div id="settings"></div>
    <webview id="hugview" src="https://www.hug-ayumu.link/hug/wm/" allowpopups></webview>
  </div>
    <pre id="configOutput" style="display: none; white-space: pre-wrap; background:#eee; padding:10px; border-radius:8px;"></pre>
  <script>
    // ページ読み込み完了時に実行
    let HUG_USERNAME = "";
    let HUG_PASSWORD = "";
    let STAFF_ID ="";
    let FACILITY_ID = "";
    let DATE_STR = "";
    let WEEK_DAY = "";
    let SELECT_CHILD = "";
    let SELECT_CHILD_Name = "";
    let childrenData;

    // 🌟 グローバルスコープで定義（後で中身を上書きできるように）
    let initializeChildrenList = async function () {
      console.warn("⚠️ initializeChildrenList() はまだ初期化されていません");
    };


    // ✅ 曜日を取得する関数（例："日"～"土"）
    // 引数 offset は日数オフセット。0=当日, -1=前日, 1=翌日
    function getTodayWeekday(offset = 0) {
      const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
      const date = new Date();
      date.setDate(date.getDate() + offset); // オフセット適用
      return weekdays[date.getDay()];
    }


    // ✅ 日付を "YYYY-MM-DD" 形式で取得する関数
    // 例: getDateString(0) → 今日, getDateString(1) → 明日, getDateString(-1) → 昨日
    function getDateString(offset = 0) {
      const today = new Date();
      today.setDate(today.getDate() + offset); // オフセットを適用

      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");

      return `${year}-${month}-${day}`;
    }


    window.addEventListener("DOMContentLoaded", async () => {
      const output = document.getElementById("configOutput");
      const settingsEl = document.getElementById("settings");

      // ===== ① config.json 読み込み =====
      const result = await window.electronAPI.readConfig();
      if (!result.success) {
        output.textContent = "❌ 読み込みエラー: " + result.error;
        console.error(result.error);
        return;
      }

      console.log("✅ config.json 読み込み成功:", result.data);
      output.textContent = JSON.stringify(result.data, null, 2);

      HUG_USERNAME = result.data.HUG_USERNAME;
      HUG_PASSWORD = result.data.HUG_PASSWORD;
      STAFF_ID = result.data.STAFF_ID;
      FACILITY_ID = result.data.FACILITY_ID;
      DATE_STR = getDateString(0);
      WEEK_DAY = getTodayWeekday(0);

      // ===== ② settings.html を読み込む =====
      const res = await fetch("settings.html");
      const html = await res.text();
      settingsEl.innerHTML = html;
      console.log("✅ settings.html 読み込み完了");

      // ===== ③ 子どもリスト描画関数を定義 =====
      const weekdaySelect = settingsEl.querySelector("#weekdaySelect");
      const childrenList = settingsEl.querySelector("#childrenList");

      initializeChildrenList = async function (children = childrenData) {
        console.log("🚀 子どもリスト描画開始");

        if (!childrenList) return;
        childrenList.innerHTML = "";

        if (Array.isArray(children) && children.length > 0) {
          children.forEach((c, index) => {
            const li = document.createElement("li");
            li.textContent = `${c.child_id}：${c.name}`;
            li.dataset.childId = c.child_id;
            li.style.cursor = "pointer";

            li.addEventListener("click", () => {
              SELECT_CHILD = c.child_id;
              SELECT_CHILD_Name = c.name;
              console.log(`🎯 SELECT_CHILD: ${SELECT_CHILD} / ${SELECT_CHILD_Name}`);
              childrenList.querySelectorAll("li").forEach((item) => (item.style = ""));
              li.style.background = "#4fc3f7";
              li.style.color = "#000";
            });

            childrenList.appendChild(li);

            // 🌟 初回のみ：1番目の子を自動選択
            if (index === 0 && !SELECT_CHILD) {
              SELECT_CHILD = c.child_id;
              SELECT_CHILD_Name = c.name;
              li.style.background = "#4fc3f7";
              li.style.color = "#000";
              console.log(`✨ 初回自動選択: ${SELECT_CHILD_Name} (${SELECT_CHILD})`);
            }
          });
        } else {
          childrenList.innerHTML = "<li>該当する子どもがいません</li>";
        }
      };

      // ===== ④ 初期化（曜日設定＋児童取得） =====
      if (weekdaySelect) {
        WEEK_DAY = getTodayWeekday(0);
        weekdaySelect.value = WEEK_DAY;
        console.log(`🗓️ 初期設定 → WEEK_DAY = ${WEEK_DAY}`);

        try {
          childrenData = await window.electronAPI.GetChildrenByStaffAndDay(STAFF_ID, WEEK_DAY);
          console.log("✅ 初期子ども一覧取得成功:", childrenData);
          initializeChildrenList(childrenData);
        } catch (err) {
          console.error("❌ 初期子ども一覧取得失敗:", err);
        }

        // 曜日変更イベント
        weekdaySelect.addEventListener("change", async () => {
          WEEK_DAY = weekdaySelect.value;
          childrenData = await window.electronAPI.GetChildrenByStaffAndDay(STAFF_ID, WEEK_DAY);
          console.log("🔁 子ども一覧再取得:", childrenData);
          SELECT_CHILD = ""; // ← 曜日が変わったら選択をリセット
          initializeChildrenList();
        });
      }

      // ===== ⑤ サイドバー制御 =====
      const menuToggle = document.getElementById("menuToggle");
      const hugview = document.getElementById("hugview");

      if (menuToggle && settingsEl && hugview) {
        menuToggle.addEventListener("click", () => {
          const isOpen = settingsEl.classList.toggle("open");
          hugview.classList.toggle("shifted", isOpen);
          console.log(isOpen ? "📂 サイドバーを開きました" : "📁 サイドバーを閉じました");
        });
      }

      document.addEventListener("click", (e) => {
        if (
          settingsEl.classList.contains("open") &&
          !settingsEl.contains(e.target) &&
          !menuToggle.contains(e.target)
        ) {
          settingsEl.classList.remove("open");
          document.getElementById("hugview").classList.remove("shifted");
          console.log("📁 サイドバーを閉じました（外側クリック）");
        }
      });

      // ✅ ページ初期表示時にも「今日の利用者」ボタンを自動クリック
      const vw = document.getElementById("hugview");
      vw.addEventListener("did-finish-load", async () => {
        console.log("🌐 ページ読み込み完了 - 今日の利用者ボタンをチェック中...");
        vw.executeJavaScript(`
          const todayButton = [...document.querySelectorAll('a.btn.btn-primary.btn-user')]
            .find(a => a.href.includes('attendance.php?mode=detail'));
          if (todayButton) {
            console.log("✅ 今日の利用者ボタンが見つかりました。クリックします:", todayButton.href);
            todayButton.click();
          } else {
            console.warn("⚠️ 今日の利用者ボタンが見つかりませんでした。");
          }
        `);
      });

    });

    
      // 🌟 現在アクティブなwebviewを管理
      let activeWebview = document.getElementById("hugview");
      let closeButtonsVisible = true; // ← トグルの状態を管理

      // 各ボタン共通でアクティブタブに対して操作する
      function getActiveWebview() {
        if (!activeWebview) {
          alert("アクティブなHugタブがありません");
          return null;
        }
        return activeWebview;
      }

    document.getElementById("refreshBtn").addEventListener("click", async () => {
      const vw = getActiveWebview();
      vw?.reload();

      // ✅ 設定パネル側のリストも再描画したいとき
      if (typeof initializeChildrenList === "function") {
        console.log("🔄 再読み込み後に子どもリストを再描画");
        childrenData = await window.electronAPI.GetChildrenByStaffAndDay(STAFF_ID, WEEK_DAY);
        await initializeChildrenList();
      }
    });


      // 🌟 トグルで閉じるボタンの表示ON/OFF
      document.getElementById("closeToggle").addEventListener("change", (e) => {
        closeButtonsVisible = e.target.checked;
        document.querySelectorAll(".close-btn").forEach(btn => {
          btn.style.display = closeButtonsVisible ? "inline" : "none";
        });
      });


    document.getElementById("loginBtn").addEventListener("click", async () => {
      const vw = getActiveWebview();
      if (!vw) return;

      if (!HUG_USERNAME || !HUG_PASSWORD) {
        alert("config.json がまだ読み込まれていません。");
        return;
      }

      console.log("🚀 自動ログイン開始...");

      vw.executeJavaScript(`
        document.querySelector('input[name="username"]').value = ${JSON.stringify(HUG_USERNAME)};
        document.querySelector('input[name="password"]').value = ${JSON.stringify(HUG_PASSWORD)};
        const checkbox = document.querySelector('input[name="setexpire"]');
        if (checkbox && !checkbox.checked) checkbox.click();
        document.querySelector("input.btn-login")?.click();
      `);

      // ✅ ログイン後の画面が読み込まれたら実行
      vw.addEventListener("did-finish-load", async () => {
        console.log("✅ ログイン後ページの読み込み完了。今日の利用者ボタンを探します...");
        vw.executeJavaScript(`
          // href に "attendance.php?mode=detail" を含むリンクを探す
          const todayButton = [...document.querySelectorAll('a.btn.btn-primary')]
            .find(a => a.href.includes('attendance.php?mode=detail'));

          if (todayButton) {
            console.log("✅ 今日の利用者ボタンが見つかりました。クリックします。");
            todayButton.click();
          } else {
            console.warn("⚠️ 今日の利用者ボタンが見つかりません。");
          }
        `);
      }, { once: true }); // ← 一度だけ発火する
    });


    document.getElementById("professional-support").addEventListener("click", () => {
      const vw = getActiveWebview();
      vw?.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php");
    });

    document.getElementById("professional-support-new").addEventListener("click", () => {
        const vw = getActiveWebview();
        if (!vw) return;
        vw.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php?mode=edit");
        vw.addEventListener("did-finish-load", () => {
          vw.executeJavaScript(`// 専門的支援実施加算
      const selectSupport = document.querySelector('select[name="adding_children_id"]');
      if (selectSupport) {
        selectSupport.value = "55";
        selectSupport.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 専門的支援実施加算を選択");
      }

      // 子どもリスト（例：岡田 磨和 → value="49"）
      const selectChild = document.querySelector('select[name="c_id_list[0][id]"]');
      if (selectChild) {
        selectChild.value = "${SELECT_CHILD}";
        selectChild.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 子どもリストで岡田磨和を選択");
      }

      // 記録者（例：東山 → value="73"）
      const selectRecorder = document.querySelector('select[name="recorder"]');
      if (selectRecorder) {
        selectRecorder.value = ${JSON.stringify(STAFF_ID)};
        selectRecorder.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 記録者をひがしやまに選択");
      }
      const interviewSelect = document.querySelector('select[name="interview_staff[]"]');
      if (interviewSelect) {
        interviewSelect.value = ${JSON.stringify(STAFF_ID)};
        interviewSelect.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 面接担当を選択:", interviewSelect.value);
      }

      // カスタマイズ項目のタイトル入力
      const customizeInput = document.querySelector('input[name="customize[title][]"]');
      if (customizeInput) {
        customizeInput.value = "記録";
        customizeInput.dispatchEvent(new Event("input", { bubbles: true }));
        console.log("✅ カスタマイズタイトル入力:", customizeInput.value);
      }
    `);
        }, { once: true });
      });

    // ✅ 個別支援計画を別ウインドウで開く
    document.getElementById("Individual_Support_Button").addEventListener("click", () => {
      window.electronAPI.openIndividualSupportPlan(SELECT_CHILD);
    });


    // ✅ Renderer 側（あなたのHTML内）
    document.getElementById("Specialized-Support-Plan").addEventListener("click", () => {
      // mainプロセスに新しいウインドウを開くよう依頼
      window.electronAPI.openSpecializedSupportPlan(SELECT_CHILD);
    });

    // 「設定ファイルの取得」ボタンのクリックイベント
    document.getElementById("Import-Setting").addEventListener("click", async () => {
      try {
        const result = await window.electronAPI.importConfigFile();
        if (result.success) {
          alert("✅ 設定ファイルをコピーしました:\n" + result.destination);
        } else {
          alert("⚠️ コピーがキャンセルまたは失敗しました");
        }
      } catch (err) {
        alert("❌ エラーが発生しました: " + err.message);
      }
    });


      // タブ追加ボタンを作る
    const tabsContainer = document.getElementById("tabs");

    const addTabButton = document.createElement("button");
    addTabButton.textContent = "＋ 新しいHugページ";

    const Kojin_Button = document.createElement("button");
    Kojin_Button.textContent = "＋ 個人記録";


    tabsContainer.appendChild(addTabButton);
    tabsContainer.appendChild(Kojin_Button);

    addTabButton.addEventListener("click", () => {
      const newId = `hugview-${Date.now()}`;
      const newWebview = document.createElement("webview");
      newWebview.id = newId;
      newWebview.src = `https://www.hug-ayumu.link/hug/wm/attendance.php?mode=detail&f_id=${JSON.stringify(FACILITY_ID)}&date=${DATE_STR}`;
      newWebview.allowpopups = true;
      newWebview.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;";
      newWebview.classList.add("hidden");
      document.getElementById("content").appendChild(newWebview);

    // タブボタン作成部分の改良
    const tabButton = document.createElement("button");
    tabButton.innerHTML = `
      Hug-${tabsContainer.querySelectorAll("button[data-target^='hugview']").length + 1}
      <span class="close-btn"${closeButtonsVisible ? "" : " style='display:none'"}>❌</span>
    `;
    tabButton.dataset.target = newId;
    tabsContainer.insertBefore(tabButton, addTabButton);

      tabButton.addEventListener("click", () => {
        document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
        newWebview.classList.remove("hidden");
        activeWebview = newWebview; // ← アクティブを更新
      });

      // 閉じる処理
      const closeBtn = tabButton.querySelector(".close-btn");
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // タブ切り替えを防ぐ
        if (!confirm("このタブを閉じてもよろしいですか？")) return;
        newWebview.remove();
        tabButton.remove();

        if (activeWebview === newWebview) {
          activeWebview = document.getElementById("hugview");
          activeWebview.classList.remove("hidden");
        }
      });

      // 追加直後にこのタブを選択状態にする
      tabButton.click();
    });



    // 🧩 個人記録タブを開く
    Kojin_Button.addEventListener("click", () => {
      const newId = `hugview-${Date.now()}`;
      const newWebview = document.createElement("webview");
      newWebview.id = newId;
      console.log("今日の日付",DATE_STR);

      // contact_book ページを開く
      newWebview.src = `https://www.hug-ayumu.link/hug/wm/contact_book.php?id=${SELECT_CHILD}`;
      newWebview.allowpopups = true;
      newWebview.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;";
      newWebview.classList.add("hidden");

      // ✅ タブコンテナに新しいボタンを追加（最後尾でOK）
      const tabButton = document.createElement("button");
      tabButton.innerHTML = `
        個人記録 : ${SELECT_CHILD_Name}
        <span class="close-btn"${closeButtonsVisible ? "" : " style='display:none'"}>❌</span>
      `;
      tabButton.dataset.target = newId;
      tabsContainer.appendChild(tabButton); // ← 修正箇所！

      // 切り替え処理
      tabButton.addEventListener("click", () => {
        document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
        newWebview.classList.remove("hidden");
        activeWebview = newWebview;
      });

      // 閉じる処理
      tabButton.querySelector(".close-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        if (!confirm("このタブを閉じてもよろしいですか？")) return;
        newWebview.remove();
        tabButton.remove();
        activeWebview = document.getElementById("hugview");
        activeWebview.classList.remove("hidden");
      });

    // ✅ 自動で編集モードを開く処理
    newWebview.addEventListener(
      "did-finish-load",
      () => {
        newWebview.executeJavaScript(`
          console.log("✅ ページ読込完了: 編集ボタン群を探索中...");
          const DATE_STR = "${DATE_STR}";
          const editButtons = document.querySelectorAll('button.btn.btn-sm.m0.edit');
          console.log("🔍 検出した編集ボタン数:", editButtons.length);

          let targetButton = null;
          editButtons.forEach(btn => {
            const onclick = btn.getAttribute("onclick") || "";
            if (onclick.includes("cal_date=" + DATE_STR)) {
              targetButton = btn;
            }
          });

          if (targetButton) {
            console.log("✅ 該当日付の編集ボタンを発見:", DATE_STR);
            targetButton.click();

            // ⏳ 編集画面の読み込みを待って record_staff を設定
            setTimeout(() => {
              console.log("🔎 編集画面の record_staff セレクトを探します...");
              const staffSelect = document.querySelector('select[name="record_staff"]');
              if (staffSelect) {
                staffSelect.value = "${STAFF_ID}";
                staffSelect.dispatchEvent(new Event("change", { bubbles: true }));
                console.log("✅ record_staff を設定:", staffSelect.value);
              } else {
                console.warn("⚠️ record_staff セレクトが見つかりません");
              }
            }, 2000);
          } else {
            console.warn("❌ 指定された cal_date の編集ボタンが見つかりません:", DATE_STR);
          }
        `);
      },
      { once: true }
    );

      document.getElementById("content").appendChild(newWebview);
      tabButton.click(); // ← すぐに表示
    });



    // タブ切り替え
    const tabs = document.querySelectorAll("#tabs button");
    const hugviewEl = document.getElementById("hugview");
    const settingsEl = document.getElementById("settings");
    

    // タブ切り替え（イベント委譲対応）
    tabsContainer.addEventListener("click", (e) => {
      const tab = e.target.closest("button[data-target]");
      if (!tab) return;

      // 🎨 すべてのタブからアクティブクラスを除去
      tabsContainer.querySelectorAll("button").forEach(btn => btn.classList.remove("active-tab"));
      // 🎨 押されたタブだけにアクティブクラスを付与
      tab.classList.add("active-tab");

      const targetId = tab.dataset.target;
      document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));

      if (targetId === "settings") {
        settingsEl.classList.remove("hidden");
      } else {
        const targetView = document.getElementById(targetId);
        if (targetView) {
          targetView.classList.remove("hidden");
          activeWebview = targetView;
        }
      }
    });

  </script>
</body>
</html>
