<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hug Client</title>
<style>
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #toolbar {
    background: #333;
    color: white;
    padding: 8px;
    flex: 0 0 auto;
  }
  #tabs {
    background: #555;
    padding: 4px;
    flex: 0 0 auto;
  }
  #tabs button.active-tab {
    background: linear-gradient(180deg, #b3e5fc, #4fc3f7);
    color: #000;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  #tabs button {
    margin-right: 4px;
    padding: 4px 10px;
    border: none;
    cursor: pointer;
    background: #777;
    color: white;
    border-radius: 4px;
  }
  /* 🌟 アクティブタブの見た目 */
  #tabs button.active-tab {
    background: #4fc3f7;
    color: #000;
    font-weight: bold;
  }
  #content {
    position: relative;
    flex: 1 1 auto;
    overflow: hidden;
  }
  #hugview, #settings {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
  .hidden {
    visibility: hidden;
    pointer-events: none;
  }
  .close-btn {
    color: red;
    cursor: pointer;
    margin-left: 6px;
    font-weight: bold;
  }
  .close-btn.hidden {
    display: none;
  }
  /* ✅ シンプルなスイッチスタイル */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
    margin-left: 8px;
    vertical-align: middle;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    border-radius: 22px;
    transition: 0.3s;
  }

  .slider::before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
  }

  /* ON状態 */
  .toggle-switch input:checked + .slider {
    background-color: #4fc3f7;
  }

  .toggle-switch input:checked + .slider::before {
    transform: translateX(18px);
  }

</style>

</head>
<body>
  <div id="toolbar">
    <button id="refreshBtn">🔄 更新</button>
    <button id="loginBtn">⚙️ 自動ログイン</button>

    <!-- 🌟 施設選択セレクトボックス -->
    <label for="facilitySelect" style="margin-left:10px;">施設:</label>
    <select id="facilitySelect" name="c_id_list[49][f_id]" class="js_c_f_id">
      <option value="3" selected>PD吉島</option>
      <option value="6">PD光</option>
      <option value="7">PD横川</option>
      <option value="8">PD五日市駅前</option>
    </select>

    <button id="KojinBtn">個人記録</button>
    <button id="professional-support">専門的支援-一覧</button>
    <button id="professional-support-new">専門的支援-新規</button>
    <button id="Specialized-Support-Plan">専門的支援-計画</button>
      <!-- 🌟 閉じるボタン表示ON/OFF トグル -->
    <label class="toggle-switch" title="閉じるボタン表示トグル">
      <input type="checkbox" id="closeToggle" checked>
      <span class="slider"></span>
    </label>
  </div>

  <div id="tabs">
    <button data-target="hugview">Hug</button>
    <button data-target="settings">設定</button>
  </div>

  <div id="content">
    <webview id="hugview" src="https://www.hug-ayumu.link/hug/wm/" allowpopups></webview>
    <div id="settings"></div>
  </div>
  <pre id="configOutput" style="display: none; white-space: pre-wrap; background:#eee; padding:10px; border-radius:8px;"></pre>

  <script>
    // ページ読み込み完了時に実行
    let HUG_USERNAME = "";
    let HUG_PASSWORD = "";
    let STAFF_ID ="";
    let SELECT_CHILD = "90";
    let FACILITY_ID = "";
    let DATE_STR = "";
    let WEEK_DAY = "";

    // ✅ 曜日を取得する関数（例："日"～"土"）
    // 引数 offset は日数オフセット。0=当日, -1=前日, 1=翌日
    function getTodayWeekday(offset = 0) {
      const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
      const date = new Date();
      date.setDate(date.getDate() + offset); // オフセット適用
      return weekdays[date.getDay()];
    }


    // ✅ 日付を "YYYY-MM-DD" 形式で取得する関数
    // 例: getDateString(0) → 今日, getDateString(1) → 明日, getDateString(-1) → 昨日
    function getDateString(offset = 0) {
      const today = new Date();
      today.setDate(today.getDate() + offset); // オフセットを適用

      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");

      return `${year}-${month}-${day}`;
    }


  window.addEventListener("DOMContentLoaded", async () => {
    const result = await window.electronAPI.readConfig();
    const output = document.getElementById("configOutput");

    if (result.success) {
      output.textContent = JSON.stringify(result.data, null, 2);
      console.log("✅ config.json 読み込み成功:", result.data);

      // ✅ グローバル変数に代入
      HUG_USERNAME = result.data.HUG_USERNAME;
      HUG_PASSWORD = result.data.HUG_PASSWORD;
      STAFF_ID = result.data.STAFF_ID;
      FACILITY_ID = result.data.FACILITY_ID;
      DATE_STR = getDateString(0);
    } else {
      output.textContent = "❌ 読み込みエラー: " + result.error;
      console.error(result.error);
    }
  });

      // 🌟 現在アクティブなwebviewを管理
      let activeWebview = document.getElementById("hugview");
      let closeButtonsVisible = true; // ← トグルの状態を管理

      // 各ボタン共通でアクティブタブに対して操作する
      function getActiveWebview() {
        if (!activeWebview) {
          alert("アクティブなHugタブがありません");
          return null;
        }
        return activeWebview;
      }

      document.getElementById("refreshBtn").addEventListener("click", () => {
        const vw = getActiveWebview();
        vw?.reload();
      });


      // 🌟 トグルで閉じるボタンの表示ON/OFF
      document.getElementById("closeToggle").addEventListener("change", (e) => {
        closeButtonsVisible = e.target.checked;
        document.querySelectorAll(".close-btn").forEach(btn => {
          btn.style.display = closeButtonsVisible ? "inline" : "none";
        });
      });


    document.getElementById("loginBtn").addEventListener("click", async () => {
        const vw = getActiveWebview();
        if (!vw) return;

        if (!HUG_USERNAME || !HUG_PASSWORD) {
          alert("config.json がまだ読み込まれていません。");
          return;
        }

        vw.executeJavaScript(`
          document.querySelector('input[name="username"]').value = ${JSON.stringify(HUG_USERNAME)};
          document.querySelector('input[name="password"]').value = ${JSON.stringify(HUG_PASSWORD)};
          const checkbox = document.querySelector('input[name="setexpire"]');
          if (checkbox && !checkbox.checked) checkbox.click();
          document.querySelector("input.btn-login")?.click();
        `);
      });

    document.getElementById("KojinBtn").addEventListener("click", async () => {
      const vw = getActiveWebview();
      if (!vw) return;

      // contact_book ページを開く
      vw.loadURL(`https://www.hug-ayumu.link/hug/wm/contact_book.php?id=${SELECT_CHILD}`);

      // 読み込み完了後に実行
      vw.addEventListener(
        "did-finish-load",
        () => {
          vw.executeJavaScript(`
            console.log("✅ ページ読込完了: 編集ボタンを探します...");
            const editButton = document.querySelector('button.btn.btn-sm.m0.edit');
            if (editButton) {
              console.log("✅ 編集ボタン見つかりました。クリックします。");
              editButton.click();
            } else {
              console.warn("❌ 編集ボタンが見つかりませんでした。");
            }
          `);
        },
        { once: true } // 一度だけ実行
      );
    });


    document.getElementById("professional-support").addEventListener("click", () => {
      const vw = getActiveWebview();
      vw?.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php");
    });

    document.getElementById("professional-support-new").addEventListener("click", () => {
        const vw = getActiveWebview();
        if (!vw) return;
        vw.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php?mode=edit");
        vw.addEventListener("did-finish-load", () => {
          vw.executeJavaScript(`// 専門的支援実施加算
      const selectSupport = document.querySelector('select[name="adding_children_id"]');
      if (selectSupport) {
        selectSupport.value = "55";
        selectSupport.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 専門的支援実施加算を選択");
      }

      // 子どもリスト（例：岡田 磨和 → value="49"）
      const selectChild = document.querySelector('select[name="c_id_list[0][id]"]');
      if (selectChild) {
        selectChild.value = "49";
        selectChild.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 子どもリストで岡田磨和を選択");
      }

      // 記録者（例：東山 → value="73"）
      const selectRecorder = document.querySelector('select[name="recorder"]');
      if (selectRecorder) {
        selectRecorder.value = ${JSON.stringify(STAFF_ID)};
        selectRecorder.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 記録者をひがしやまに選択");
      }
      const interviewSelect = document.querySelector('select[name="interview_staff[]"]');
      if (interviewSelect) {
        interviewSelect.value = ${JSON.stringify(STAFF_ID)};
        interviewSelect.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("✅ 面接担当を選択:", interviewSelect.value);
      }

      // カスタマイズ項目のタイトル入力
      const customizeInput = document.querySelector('input[name="customize[title][]"]');
      if (customizeInput) {
        customizeInput.value = "記録";
        customizeInput.dispatchEvent(new Event("input", { bubbles: true }));
        console.log("✅ カスタマイズタイトル入力:", customizeInput.value);
      }
    `);
        }, { once: true });
      });

    document.getElementById("Specialized-Support-Plan").addEventListener("click", () => {
      const vw = getActiveWebview();
      if (!vw) return;

      // 専門的支援計画ページを開く
      vw.loadURL("https://www.hug-ayumu.link/hug/wm/addition_plan.php");

      vw.addEventListener("did-finish-load", () => {
        vw.executeJavaScript(`// 🚀 専門的支援計画ページ 自動処理開始
          console.log("✅ 専門的支援計画ページを読み込みました");
          //  id="name_list" の子ども選択
          const selectChild2 = document.querySelector('#name_list');
          if (selectChild2) {
            selectChild2.value = "${SELECT_CHILD}";
            selectChild2.dispatchEvent(new Event("change", { bubbles: true }));
            console.log("✅ #name_list に設定:", selectChild2.value);
          } else {
            console.warn("⚠️ #name_list が見つかりません");
          }

          // ③ 少し待ってから「検索」ボタンをクリック
          setTimeout(() => {
            const searchButton = document.querySelector('button.btn.btn-sm.search[type="submit"]');
            if (searchButton && !searchButton.disabled) {
              searchButton.click();
              console.log("✅ 検索ボタンをクリックしました");
            } else {
              console.warn("⚠️ 検索ボタンが無効または見つかりません");
            }
          }, 1500);
        `);
      }, { once: true });
    });

      // タブ追加ボタンを作る
    const tabsContainer = document.getElementById("tabs");

    const addTabButton = document.createElement("button");
    addTabButton.textContent = "＋ 新しいHugページ";

    const Individual_Support_Button = document.createElement("button");
    Individual_Support_Button.textContent = "＋ 個別支援計画";


    tabsContainer.appendChild(addTabButton);
    tabsContainer.appendChild(Individual_Support_Button);

    addTabButton.addEventListener("click", () => {
      const newId = `hugview-${Date.now()}`;
      const newWebview = document.createElement("webview");
      newWebview.id = newId;
      newWebview.src = `https://www.hug-ayumu.link/hug/wm/attendance.php?mode=detail&f_id=${JSON.stringify(FACILITY_ID)}&date=${DATE_STR}`;
      newWebview.allowpopups = true;
      newWebview.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;";
      newWebview.classList.add("hidden");
      document.getElementById("content").appendChild(newWebview);

    // タブボタン作成部分の改良
    const tabButton = document.createElement("button");
    tabButton.innerHTML = `
      Hug-${tabsContainer.querySelectorAll("button[data-target^='hugview']").length + 1}
      <span class="close-btn"${closeButtonsVisible ? "" : " style='display:none'"}>❌</span>
    `;
    tabButton.dataset.target = newId;
    tabsContainer.insertBefore(tabButton, addTabButton);

      tabButton.addEventListener("click", () => {
        document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
        newWebview.classList.remove("hidden");
        activeWebview = newWebview; // ← アクティブを更新
      });

      // 閉じる処理
      const closeBtn = tabButton.querySelector(".close-btn");
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // タブ切り替えを防ぐ
        if (!confirm("このタブを閉じてもよろしいですか？")) return;
        newWebview.remove();
        tabButton.remove();

        if (activeWebview === newWebview) {
          activeWebview = document.getElementById("hugview");
          activeWebview.classList.remove("hidden");
        }
      });

      // 追加直後にこのタブを選択状態にする
      tabButton.click();
    });


    // 🧩 個別支援計画タブを開く
    Individual_Support_Button.addEventListener("click", () => {
      const newId = `hugview-${Date.now()}`;
      const newWebview = document.createElement("webview");
      newWebview.id = newId;
      newWebview.src = "https://www.hug-ayumu.link/hug/wm/individual_care-plan-main.php";
      newWebview.allowpopups = true;
      newWebview.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;";
      newWebview.classList.add("hidden");
      document.getElementById("content").appendChild(newWebview);

      const tabButton = document.createElement("button");
      tabButton.innerHTML = `
        個別支援計画
        <span class="close-btn"${closeButtonsVisible ? "" : " style='display:none'"}>❌</span>
      `;
      tabButton.dataset.target = newId;
      tabsContainer.insertBefore(tabButton, Individual_Support_Button);

      tabButton.addEventListener("click", () => {
        document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
        newWebview.classList.remove("hidden");
        activeWebview = newWebview;
      });

      tabButton.querySelector(".close-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        if (!confirm("このタブを閉じてもよろしいですか？")) return;
        newWebview.remove();
        tabButton.remove();
        activeWebview = document.getElementById("hugview");
        activeWebview.classList.remove("hidden");
      });

      // ✅ 自動処理が複数回実行されないようにするフラグ
      let autoProcessExecuted = false;

      newWebview.addEventListener("did-finish-load", async () => {
        if (autoProcessExecuted) {
          console.log("⏩ 自動処理はすでに実行済み、スキップします");
          return;
        }
        autoProcessExecuted = true; // ← 実行済みフラグON
        console.log("✅ 個別支援計画ページ読み込み完了（初回のみ実行）");

        newWebview.executeJavaScript(`
          console.log("🚀 自動処理開始: ページ初期化中...");

          const childSelect = document.querySelector('#name_list');
          if (childSelect) {
            const targetValue = ${JSON.stringify(SELECT_CHILD)};
            const optionExists = [...childSelect.options].some(opt => opt.value === targetValue);

            if (optionExists) {
              childSelect.value = targetValue;
              childSelect.dispatchEvent(new Event("change", { bubbles: true }));
              console.log("✅ 子ども選択完了:", targetValue, childSelect.options[childSelect.selectedIndex].text);
            } else {
              console.warn("⚠️ 指定された子どもIDがリストに見つかりません:", targetValue);
            }
          } else {
            console.error("❌ #name_list がページに見つかりません");
          }

          setTimeout(() => {
            const searchButton = document.querySelector('button.btn.btn-sm.search');
            if (searchButton && !searchButton.disabled) {
              searchButton.click();
              console.log("✅ 検索ボタンをクリックしました。");
            } else {
              console.warn("⚠️ 検索ボタンが無効化されているか見つかりません");
            }
          }, 1500);

          console.log("✅ 自動処理完了");
        `);
      }, { once: true }); // ← イベント自体も一度しか発火しない

      tabButton.click();
    });



    // タブ切り替え
    const tabs = document.querySelectorAll("#tabs button");
    const hugviewEl = document.getElementById("hugview");
    const settingsEl = document.getElementById("settings");
    

    // ⭐ 初期状態で Settings を非表示にする
    settingsEl.classList.add("hidden");

    // タブ切り替え（イベント委譲対応）
    tabsContainer.addEventListener("click", (e) => {
      const tab = e.target.closest("button[data-target]");
      if (!tab) return;

      // 🎨 すべてのタブからアクティブクラスを除去
      tabsContainer.querySelectorAll("button").forEach(btn => btn.classList.remove("active-tab"));
      // 🎨 押されたタブだけにアクティブクラスを付与
      tab.classList.add("active-tab");

      const targetId = tab.dataset.target;
      document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
      settingsEl.classList.add("hidden");

      if (targetId === "settings") {
        settingsEl.classList.remove("hidden");
      } else {
        const targetView = document.getElementById(targetId);
        if (targetView) {
          targetView.classList.remove("hidden");
          activeWebview = targetView;
        }
      }
    });


    // 設定ページを読み込んで埋め込む
    fetch("settings.html")
      .then(res => res.text())
      .then(html => {
        settingsEl.innerHTML = html;
        settingsEl.classList.add("hidden");
        console.log("✅ settings.html を読み込んだ");

      // 🌟 曜日セレクトとの連携処理
      const weekdaySelect = settingsEl.querySelector("#weekdaySelect");

      if (weekdaySelect) {
        // 初期状態として当日の曜日を選択
        WEEK_DAY = getTodayWeekday(0);
        weekdaySelect.value = WEEK_DAY;
        console.log(`🗓️ 初期設定 → WEEK_DAY = ${WEEK_DAY}`);

        // ✅ initializeChildrenList にセレクト値を反映
        async function initializeChildrenList() {
          console.log("🚀 初期化処理開始");

          const staffId = STAFF_ID;
          WEEK_DAY = weekdaySelect.value; // ← セレクトの値を優先
          console.log(`📦 渡す引数 → staffId: ${staffId}, WEEK_DAY: ${WEEK_DAY}`);

          const childrenList = settingsEl.querySelector("#childrenList");
          if (!childrenList) return;

          try {
            const children = await window.electronAPI.GetChildrenByStaffAndDay(staffId, WEEK_DAY);
            console.log("✅ 子ども一覧取得成功:", children);

            // ✅ HTMLに一覧を表示
            childrenList.innerHTML = "";
            if (Array.isArray(children) && children.length > 0) {
              children.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.child_id}：${c.name}`;
                li.dataset.childId = c.child_id;
                li.style.cursor = "pointer";

                // ✅ クリックで SELECT_CHILD を変更
                li.addEventListener("click", () => {
                  SELECT_CHILD = c.child_id;
                  console.log(`🎯 SELECT_CHILD が更新されました: ${SELECT_CHILD}`);

                  // 💡 選択状態の見た目を更新
                  childrenList.querySelectorAll("li").forEach(item => {
                    item.style.background = "";
                    item.style.color = "";
                  });
                  li.style.background = "#4fc3f7";
                  li.style.color = "#000";
                });

                childrenList.appendChild(li);
              });
            } else {
              childrenList.innerHTML = "<li>該当する子どもがいません</li>";
            }
          } catch (err) {
            console.error("❌ 子ども一覧取得失敗:", err);
            childrenList.innerHTML = `<li style="color:red;">エラー: ${err.message}</li>`;
          }
        }

        // 🔁 セレクト変更時にも再取得
        weekdaySelect.addEventListener("change", () => {
          console.log(`🔁 曜日が変更されました → ${weekdaySelect.value}`);
          initializeChildrenList();
        });

        // ✅ 初期化関数を即実行
        initializeChildrenList();
      } else {
        console.warn("⚠️ #weekdaySelect が見つかりません。曜日連携は無効です。");
      }


        // 💡 要素を取得
        const childrenList = settingsEl.querySelector("#childrenList");

        if (!childrenList) {
          console.error("❌ settings.html に #childrenList が見つかりません");
          return;
        }

        // ✅ 初期化処理（ボタンを押さずに即実行）
        async function initializeChildrenList() {
          console.log("🚀 初期化処理開始");
          const staffId = STAFF_ID;   // config.jsonから読み込んだ職員ID
          WEEK_DAY = getTodayWeekday(0);  // ✅ 当日の曜日を自動取得
          //WEEK_DAY = '土';  // ✅ 当日の曜日を自動取得

          try {
            console.log("🚀 子ども一覧取得処理開始");
            console.log(`📦 渡す引数 → staffId: ${staffId}, WEEK_DAY: ${WEEK_DAY}`);
            const children = await window.electronAPI.GetChildrenByStaffAndDay(staffId, WEEK_DAY);
            console.log("✅ 子ども一覧取得成功:", children);

            // ✅ HTMLに一覧を表示
            childrenList.innerHTML = "";
            if (Array.isArray(children) && children.length > 0) {
              children.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.child_id}：${c.name}`;
                li.dataset.childId = c.child_id; // 🔹 child_id を保持
                li.style.cursor = "pointer";

                // ✅ クリックで SELECT_CHILD を変更
                li.addEventListener("click", () => {
                  SELECT_CHILD = c.child_id;
                  console.log(`🎯 SELECT_CHILD が更新されました: ${SELECT_CHILD}`);

                  // 💡 選択状態の見た目を更新
                  childrenList.querySelectorAll("li").forEach(item => {
                    item.style.background = "";
                    item.style.color = "";
                  });
                  li.style.background = "#4fc3f7";
                  li.style.color = "#000";
                });

                childrenList.appendChild(li);
              });
            }
          } catch (err) {
            console.error("❌ 子ども一覧取得失敗:", err);
            childrenList.innerHTML = `<li style="color:red;">エラー: ${err.message}</li>`;
          }
        }

        // ✅ 初期化関数を即実行
        initializeChildrenList();
      });


  </script>
</body>
</html>
