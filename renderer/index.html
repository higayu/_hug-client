<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hug Client</title>
<style>
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #toolbar {
    background: #333;
    color: white;
    padding: 8px;
    flex: 0 0 auto;
  }
  #tabs {
    background: #555;
    padding: 4px;
    flex: 0 0 auto;
  }
  #tabs button.active-tab {
    background: linear-gradient(180deg, #b3e5fc, #4fc3f7);
    color: #000;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  #tabs button {
    margin-right: 4px;
    padding: 4px 10px;
    border: none;
    cursor: pointer;
    background: #777;
    color: white;
    border-radius: 4px;
  }
  /* ğŸŒŸ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®è¦‹ãŸç›® */
  #tabs button.active-tab {
    background: #4fc3f7;
    color: #000;
    font-weight: bold;
  }
  #content {
    position: relative;
    flex: 1 1 auto;
    overflow: hidden;
  }
  #hugview, #settings {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
  .hidden {
    visibility: hidden;
    pointer-events: none;
  }
  .close-btn {
    color: red;
    cursor: pointer;
    margin-left: 6px;
    font-weight: bold;
  }
  .close-btn.hidden {
    display: none;
  }
  /* âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¤ãƒƒãƒã‚¹ã‚¿ã‚¤ãƒ« */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
    margin-left: 8px;
    vertical-align: middle;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    border-radius: 22px;
    transition: 0.3s;
  }

  .slider::before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
  }

  /* ONçŠ¶æ…‹ */
  .toggle-switch input:checked + .slider {
    background-color: #4fc3f7;
  }

  .toggle-switch input:checked + .slider::before {
    transform: translateX(18px);
  }

</style>

</head>
<body>
  <div id="toolbar">
    <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
    <button id="loginBtn">âš™ï¸ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="professional-support">å°‚é–€çš„æ”¯æ´-ä¸€è¦§</button>
    <button id="professional-support-new">å°‚é–€çš„æ”¯æ´-æ–°è¦</button>
      <!-- ğŸŒŸ é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³è¡¨ç¤ºON/OFF ãƒˆã‚°ãƒ« -->
    <label class="toggle-switch" title="é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³è¡¨ç¤ºãƒˆã‚°ãƒ«">
      <input type="checkbox" id="closeToggle" checked>
      <span class="slider"></span>
    </label>
  </div>

  <div id="tabs">
    <button data-target="hugview">Hug</button>
    <button data-target="settings">è¨­å®š</button>
  </div>

  <div id="content">
    <webview id="hugview" src="https://www.hug-ayumu.link/hug/wm/" allowpopups></webview>
    <div id="settings"></div>
  </div>
  <pre id="configOutput" style="white-space: pre-wrap; background:#eee; padding:10px; border-radius:8px;"></pre>

  <script>
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
    let HUG_USERNAME = "";
    let HUG_PASSWORD = "";
    let STAFF_ID ="";

  window.addEventListener("DOMContentLoaded", async () => {
    const result = await window.electronAPI.readConfig();
    const output = document.getElementById("configOutput");

    if (result.success) {
      output.textContent = JSON.stringify(result.data, null, 2);
      console.log("âœ… config.json èª­ã¿è¾¼ã¿æˆåŠŸ:", result.data);

      // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥
      HUG_USERNAME = result.data.HUG_USERNAME;
      HUG_PASSWORD = result.data.HUG_PASSWORD;
      STAFF_ID = result.data.STAFF_ID;
    } else {
      output.textContent = "âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + result.error;
      console.error(result.error);
    }
  });

      // ğŸŒŸ ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªwebviewã‚’ç®¡ç†
      let activeWebview = document.getElementById("hugview");
      let closeButtonsVisible = true; // â† ãƒˆã‚°ãƒ«ã®çŠ¶æ…‹ã‚’ç®¡ç†

      // å„ãƒœã‚¿ãƒ³å…±é€šã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã«å¯¾ã—ã¦æ“ä½œã™ã‚‹
      function getActiveWebview() {
        if (!activeWebview) {
          alert("ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªHugã‚¿ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“");
          return null;
        }
        return activeWebview;
      }

      document.getElementById("refreshBtn").addEventListener("click", () => {
        const vw = getActiveWebview();
        vw?.reload();
      });


      // ğŸŒŸ ãƒˆã‚°ãƒ«ã§é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºON/OFF
      document.getElementById("closeToggle").addEventListener("change", (e) => {
        closeButtonsVisible = e.target.checked;
        document.querySelectorAll(".close-btn").forEach(btn => {
          btn.style.display = closeButtonsVisible ? "inline" : "none";
        });
      });


      document.getElementById("loginBtn").addEventListener("click", async () => {
        const vw = getActiveWebview();
        if (!vw) return;

        if (!HUG_USERNAME || !HUG_PASSWORD) {
          alert("config.json ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        vw.executeJavaScript(`
          document.querySelector('input[name="username"]').value = ${JSON.stringify(HUG_USERNAME)};
          document.querySelector('input[name="password"]').value = ${JSON.stringify(HUG_PASSWORD)};
          const checkbox = document.querySelector('input[name="setexpire"]');
          if (checkbox && !checkbox.checked) checkbox.click();
          document.querySelector("input.btn-login")?.click();
        `);
      });


      document.getElementById("professional-support").addEventListener("click", () => {
        const vw = getActiveWebview();
        vw?.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php");
      });

      document.getElementById("professional-support-new").addEventListener("click", () => {
        const vw = getActiveWebview();
        if (!vw) return;
        vw.loadURL("https://www.hug-ayumu.link/hug/wm/record_proceedings.php?mode=edit");
        vw.addEventListener("did-finish-load", () => {
          vw.executeJavaScript(`// å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—
      const selectSupport = document.querySelector('select[name="adding_children_id"]');
      if (selectSupport) {
        selectSupport.value = "55";
        selectSupport.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("âœ… å°‚é–€çš„æ”¯æ´å®Ÿæ–½åŠ ç®—ã‚’é¸æŠ");
      }

      // å­ã©ã‚‚ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼šå²¡ç”° ç£¨å’Œ â†’ value="49"ï¼‰
      const selectChild = document.querySelector('select[name="c_id_list[0][id]"]');
      if (selectChild) {
        selectChild.value = "49";
        selectChild.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("âœ… å­ã©ã‚‚ãƒªã‚¹ãƒˆã§å²¡ç”°ç£¨å’Œã‚’é¸æŠ");
      }

      // è¨˜éŒ²è€…ï¼ˆä¾‹ï¼šæ±å±± â†’ value="73"ï¼‰
      const selectRecorder = document.querySelector('select[name="recorder"]');
      if (selectRecorder) {
        selectRecorder.value = ${JSON.stringify(STAFF_ID)};
        selectRecorder.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("âœ… è¨˜éŒ²è€…ã‚’ã²ãŒã—ã‚„ã¾ã«é¸æŠ");
      }
      const interviewSelect = document.querySelector('select[name="interview_staff[]"]');
      if (interviewSelect) {
        interviewSelect.value = ${JSON.stringify(STAFF_ID)};
        interviewSelect.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("âœ… é¢æ¥æ‹…å½“ã‚’é¸æŠ:", interviewSelect.value);
      }

      // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé …ç›®ã®ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›
      const customizeInput = document.querySelector('input[name="customize[title][]"]');
      if (customizeInput) {
        customizeInput.value = "è¨˜éŒ²";
        customizeInput.dispatchEvent(new Event("input", { bubbles: true }));
        console.log("âœ… ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›:", customizeInput.value);
      }
    `);
        }, { once: true });
      });

      // ã‚¿ãƒ–è¿½åŠ ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹
    const tabsContainer = document.getElementById("tabs");
    const addTabButton = document.createElement("button");
    addTabButton.textContent = "ï¼‹ æ–°ã—ã„Hugãƒšãƒ¼ã‚¸";
    tabsContainer.appendChild(addTabButton);

    addTabButton.addEventListener("click", () => {
      const newId = `hugview-${Date.now()}`;
      const newWebview = document.createElement("webview");
      newWebview.id = newId;
      newWebview.src = "https://www.hug-ayumu.link/hug/wm/";
      newWebview.allowpopups = true;
      newWebview.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;";
      newWebview.classList.add("hidden");
      document.getElementById("content").appendChild(newWebview);

    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ä½œæˆéƒ¨åˆ†ã®æ”¹è‰¯
    const tabButton = document.createElement("button");
    tabButton.innerHTML = `
      Hug-${tabsContainer.querySelectorAll("button[data-target^='hugview']").length + 1}
      <span class="close-btn"${closeButtonsVisible ? "" : " style='display:none'"}>âŒ</span>
    `;
    tabButton.dataset.target = newId;
    tabsContainer.insertBefore(tabButton, addTabButton);

      tabButton.addEventListener("click", () => {
        document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
        newWebview.classList.remove("hidden");
        activeWebview = newWebview; // â† ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’æ›´æ–°
      });

      // é–‰ã˜ã‚‹å‡¦ç†
      const closeBtn = tabButton.querySelector(".close-btn");
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’é˜²ã
        if (!confirm("ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        newWebview.remove();
        tabButton.remove();

        if (activeWebview === newWebview) {
          activeWebview = document.getElementById("hugview");
          activeWebview.classList.remove("hidden");
        }
      });

      // è¿½åŠ ç›´å¾Œã«ã“ã®ã‚¿ãƒ–ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      tabButton.click();
    });


    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const tabs = document.querySelectorAll("#tabs button");
    const hugviewEl = document.getElementById("hugview");
    const settingsEl = document.getElementById("settings");
    

    // â­ åˆæœŸçŠ¶æ…‹ã§ Settings ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    settingsEl.classList.add("hidden");

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²å¯¾å¿œï¼‰
    tabsContainer.addEventListener("click", (e) => {
      const tab = e.target.closest("button[data-target]");
      if (!tab) return;

      // ğŸ¨ ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’é™¤å»
      tabsContainer.querySelectorAll("button").forEach(btn => btn.classList.remove("active-tab"));
      // ğŸ¨ æŠ¼ã•ã‚ŒãŸã‚¿ãƒ–ã ã‘ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
      tab.classList.add("active-tab");

      const targetId = tab.dataset.target;
      document.querySelectorAll("webview").forEach(v => v.classList.add("hidden"));
      settingsEl.classList.add("hidden");

      if (targetId === "settings") {
        settingsEl.classList.remove("hidden");
      } else {
        const targetView = document.getElementById(targetId);
        if (targetView) {
          targetView.classList.remove("hidden");
          activeWebview = targetView;
        }
      }
    });


    // è¨­å®šãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§åŸ‹ã‚è¾¼ã‚€
    fetch("settings.html")
      .then(res => res.text())
      .then(html => {
        settingsEl.innerHTML = html;
        settingsEl.classList.add("hidden");
        console.log("âœ… settings.html ã‚’èª­ã¿è¾¼ã‚“ã ");

        // ğŸ’¡ ã“ã“ã§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã™ã‚‹
        const btn = settingsEl.querySelector("#loadStaffBtn");
        const staffList = settingsEl.querySelector("#staffList");

        btn.addEventListener("click", async () => {
          console.log("âœ… ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«");
          try {
            const staff = await window.electronAPI.fetchStaff();
            console.log("âœ… APIã‹ã‚‰å–å¾—:", staff);

            staffList.innerHTML = "";
            staff.forEach(s => {
              const li = document.createElement("li");
              li.textContent = `${s.id}: ${s.name}`;
              staffList.appendChild(li);
            });
          } catch (err) {
            console.error("âŒ ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          }
        });
      });


  </script>
</body>
</html>
