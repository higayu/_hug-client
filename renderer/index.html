<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hug Client</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* スクロール防止 */
    }
    #toolbar {
      background: #333;
      color: white;
      padding: 8px;
      flex: 0 0 auto; /* 高さ固定 */
    }
    #tabs {
      background: #555;
      padding: 4px;
      flex: 0 0 auto; /* 高さ固定 */
    }
    #content {
      position: relative;
      flex: 1 1 auto;  /* 残りの高さを埋める */
      overflow: hidden;
    }
    #hugview, #settings {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .hidden {
      visibility: hidden;
      pointer-events: none;
    }

  </style>
</head>
<body>
  <div id="toolbar">
    <button id="refreshBtn">🔄 更新</button>
    <button id="loginBtn">⚙️ 自動ログイン</button>
  </div>
  <div id="tabs">
    <button data-target="hugview">Hug</button>
    <button data-target="settings">設定</button>
  </div>

  <div id="content">
    <webview id="hugview" src="https://www.hug-ayumu.link/hug/wm/" allowpopups></webview>
    <div id="settings"></div>
  </div>

  <script>
    const hugview = document.getElementById("hugview");

    document.getElementById("refreshBtn").addEventListener("click", () => {
      hugview.reload();
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const { username, password } = await window.electronAPI.getEnv();
      hugview.executeJavaScript(`
        document.querySelector('input[name="username"]').value = ${JSON.stringify(username)};
        document.querySelector('input[name="password"]').value = ${JSON.stringify(password)};
        const checkbox = document.querySelector('input[name="setexpire"]');
        if (checkbox && !checkbox.checked) checkbox.click();
        document.querySelector("input.btn-login")?.click();
      `);
    });

    // タブ切り替え
    const tabs = document.querySelectorAll("#tabs button");
    const hugviewEl = document.getElementById("hugview");
    const settingsEl = document.getElementById("settings");

    // ⭐ 初期状態で Settings を非表示にする
    settingsEl.classList.add("hidden");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        if (tab.dataset.target === "hugview") {
          hugviewEl.classList.remove("hidden");
          settingsEl.classList.add("hidden");
        } else {
          hugviewEl.classList.add("hidden");
          settingsEl.classList.remove("hidden");
        }
      });
    });

    // 設定ページを読み込んで埋め込む
    fetch("settings.html")
      .then(res => res.text())
      .then(html => {
        settingsEl.innerHTML = html;
        settingsEl.classList.add("hidden");
        console.log("✅ settings.html を読み込んだ");

        // 💡 ここでボタンのイベントを登録する
        const btn = settingsEl.querySelector("#loadStaffBtn");
        const staffList = settingsEl.querySelector("#staffList");

        btn.addEventListener("click", async () => {
          console.log("✅ ボタンクリックイベント発火");
          try {
            const staff = await window.electronAPI.fetchStaff();
            console.log("✅ APIから取得:", staff);

            staffList.innerHTML = "";
            staff.forEach(s => {
              const li = document.createElement("li");
              li.textContent = `${s.id}: ${s.name}`;
              staffList.appendChild(li);
            });
          } catch (err) {
            console.error("❌ スタッフ取得エラー:", err);
          }
        });
      });


  </script>
</body>
</html>
